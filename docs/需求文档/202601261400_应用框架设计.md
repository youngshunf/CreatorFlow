# CreatorFlow 应用框架设计

> 版本：v1.0（草案）
> 日期：2026-01-26

---

## 1. 设计目标

### 1.1 核心问题

当前 CreatorFlow 提供了强大的 AI 能力，但存在以下使用门槛：

- **概念复杂**：用户需要理解 Workspace、Session、Skill、Source、MCP 等专业概念
- **配置繁琐**：每次创建工作区都需要从零配置 skills、sources、statuses
- **缺乏场景化**：通用 AI 助手难以直接满足特定领域的工作流需求

### 1.2 解决方案

引入 **应用(App)** 概念，作为 **场景化解决方案的封装单元**：

```
用户视角：选择应用 → 创建工作区 → 开始工作
技术视角：App = Skills + Workflows + Sources + Statuses + Views + Templates
```

### 1.3 用户分层

| 用户类型 | 使用方式 | 关注点 |
|---------|---------|--------|
| 普通用户 | 选择应用 → 开箱即用 | 完成任务，不关心技术细节 |
| 进阶用户 | 基于应用 → 自定义调整 | 添加/移除 skills，调整工作流 |
| 专业用户 | 创建应用 → 分享到市场 | 组合能力，服务特定领域 |

---

## 2. 核心概念

### 2.1 应用(App)

应用是 **场景化能力的封装**，包含完成特定领域工作所需的全部配置：

```
App
├── manifest.json          # 应用元数据
├── skills/                # 预置技能
├── workflows/             # 工作流定义
├── sources/               # 推荐数据源
├── statuses/              # 状态配置
├── views/                 # 视图配置
├── templates/             # 项目结构模板
├── permissions/           # 默认权限
└── assets/                # 图标、示例等资源
```

### 2.2 应用与工作区的关系

```
Workspace
├── 已安装应用: [App1, App2, ...]    # 可组合多个应用
├── 合并后的 Skills                   # 来自多个应用 + 用户自定义
├── 合并后的 Sources                  # 来自多个应用 + 用户自定义
├── 合并后的 Workflows                # 来自多个应用 + 用户自定义
├── 用户自定义覆盖                    # 用户的修改优先级最高
└── Sessions
```

**关键规则**：
- 一个工作区可以安装多个应用
- 应用之间的配置自动合并，冲突时后安装的覆盖先安装的
- 用户的自定义修改优先级最高，不会被应用更新覆盖

### 2.3 工作流(Workflow)

工作流是 **基于 LangGraph 的 AI 自动化流程**，支持：

- **AI 节点**：LLM 调用、推理、决策
- **工具节点**：API 调用、数据操作、文件处理
- **条件分支**：根据条件选择不同路径
- **循环**：重复执行直到满足条件
- **并行**：多个节点同时执行
- **人工介入**：Human-in-the-loop 审批

```yaml
# 示例：自媒体日更工作流
id: daily-content
name: 日更内容工作流
description: 从选题到发布的完整内容创作流程

trigger:
  type: manual  # manual | schedule | event
  # schedule: "0 9 * * *"  # 每天早上9点
  # event: { type: "file:change", filter: "*.md" }

execution:
  mode: session  # session | background
  notifyOnComplete: true

# 工作流状态定义（LangGraph State）
state:
  topic: string
  materials: array
  drafts: object
  approved: boolean

# 节点定义（LangGraph Nodes）
nodes:
  # AI 节点：选题分析
  - id: analyze_topic
    type: ai
    name: 选题分析
    skill: topic-selection
    input:
      positioning: "{{workspace.config.positioning}}"
      hot_topics: "{{tools.trend_radar.getHotTopics()}}"
    output: topic

  # 工具节点：素材收集
  - id: collect_materials
    type: tool
    name: 素材收集
    tools:
      - search_images
      - fetch_references
    input:
      topic: "{{state.topic}}"
    output: materials

  # 并行节点：多平台内容生成
  - id: generate_content
    type: parallel
    name: 内容生成
    branches:
      - id: xhs_draft
        condition: "{{workspace.config.platforms.includes('xiaohongshu')}}"
        type: ai
        skill: xiaohongshu-copywriting
        input:
          topic: "{{state.topic}}"
          materials: "{{state.materials}}"

      - id: douyin_draft
        condition: "{{workspace.config.platforms.includes('douyin')}}"
        type: ai
        skill: video-script
        input:
          topic: "{{state.topic}}"
    output: drafts

  # 人工审核节点（Human-in-the-loop）
  - id: human_review
    type: human
    name: 内容审核
    prompt: 请审核以下内容，确认后将自动发布
    show:
      - "{{state.drafts}}"
    actions:
      - id: approve
        label: 确认发布
      - id: reject
        label: 修改
      - id: cancel
        label: 取消
    output: approved

  # 工具节点：发布
  - id: publish
    type: tool
    name: 多平台发布
    condition: "{{state.approved}}"
    tools:
      - publish_xiaohongshu
      - publish_douyin
    input:
      drafts: "{{state.drafts}}"

# 边定义（LangGraph Edges）
edges:
  - from: START
    to: analyze_topic
  - from: analyze_topic
    to: collect_materials
  - from: collect_materials
    to: generate_content
  - from: generate_content
    to: human_review
  - from: human_review
    to: publish
    condition: "{{state.approved}}"
  - from: human_review
    to: generate_content  # 修改后重新生成
    condition: "{{action == 'reject'}}"
  - from: publish
    to: END
```

---

## 3. 应用规范

### 3.1 Manifest 规范

```json
{
  "$schema": "https://creatorflow.app/schemas/app-manifest.json",
  "id": "creator-media",
  "name": "自媒体创作者",
  "version": "1.0.0",
  "description": "面向小红书/抖音/公众号的全流程创作工具",
  "author": {
    "name": "CreatorFlow Official",
    "url": "https://creatorflow.app"
  },
  "icon": "assets/icon.png",
  "category": "content-creation",
  "tags": ["自媒体", "小红书", "抖音", "公众号"],
  
  "capabilities": {
    "skills": ["topic-selection", "script-writing", "material-management"],
    "workflows": ["daily-content", "campaign"],
    "sources": {
      "required": [],
      "recommended": ["xiaohongshu", "douyin", "wechat-mp"]
    }
  },

  "workspace": {
    "defaultStatuses": "statuses/content-pipeline.json",
    "defaultViews": "views/content-views.json",
    "defaultLabels": "labels/content-labels.json",
    "projectTemplate": "templates/project-structure"
  },

  "compatibility": {
    "creatorflow": ">=1.0.0"
  }
}
```

### 3.2 目录结构规范

```
apps/
├── builtin/                          # 内置应用（官方维护）
│   ├── creator-media/                # 自媒体创作者
│   ├── software-dev/                 # 软件开发
│   ├── academic-research/            # 学术研究
│   └── general-assistant/            # 通用助手
│
└── community/                        # 社区应用（用户贡献）
    └── {app-slug}/
        ├── manifest.json
        ├── README.md
        ├── CHANGELOG.md
        ├── skills/
        │   └── {skill-slug}/
        │       ├── SKILL.md          # 技能定义（现有格式）
        │       └── icon.png
        ├── workflows/
        │   └── {workflow-slug}.yaml
        ├── sources/
        │   └── {source-slug}/
        │       ├── config.json       # 数据源配置模板
        │       └── guide.md
        ├── statuses/
        │   └── default.json
        ├── views/
        │   └── default.json
        ├── labels/
        │   └── default.json
        ├── templates/
        │   └── project-structure/    # 项目目录模板
        ├── permissions/
        │   └── default.json
        └── assets/
            └── icon.png
```

### 3.3 Skill 扩展

在现有 Skill 基础上，增加工作流集成能力：

```yaml
---
name: 选题分析
description: 基于账号定位和热点趋势，生成选题建议
icon: 🎯

# 新增：工作流集成
workflow:
  # 声明输入参数
  inputs:
    - name: account_positioning
      type: string
      required: true
      description: 账号定位描述
    - name: recent_hot_topics
      type: array
      required: false
      description: 近期热点话题列表
  
  # 声明输出参数
  outputs:
    - name: selected_topic
      type: string
      description: 选中的选题
    - name: content_angle
      type: string
      description: 内容切入角度
    - name: reference_materials
      type: array
      description: 参考素材列表

# 触发条件（可选）
globs:
  - "**/topics/**"
  - "**/选题/**"

alwaysAllow:
  - Read
  - WebSearch
---

你是一位资深的自媒体选题策划专家...

## 输入信息

账号定位：{{account_positioning}}

{{#if recent_hot_topics}}
近期热点：
{{#each recent_hot_topics}}
- {{this}}
{{/each}}
{{/if}}

## 任务

请根据以上信息，完成选题分析...
```

---

## 4. 工作流引擎

### 4.1 技术选型

采用 **LangGraph.js** 作为工作流引擎，原生支持 AI 节点和工具调用。

| 方案 | 特点 | 适用场景 | 推荐度 |
|-----|------|---------|-------|
| **LangGraph.js** | AI 原生、状态管理、工具调用、人工介入 | AI Agent 工作流 | ⭐⭐⭐⭐⭐ |
| LangChain.js | LLM 封装、工具集成 | 配合 LangGraph 使用 | ⭐⭐⭐⭐ |
| ts-edge | 轻量、类型安全 | 简单流程 | ⭐⭐⭐ |

**选择 LangGraph.js 的理由**：

1. **AI 原生**：专为 AI Agent 工作流设计，原生支持 LLM 调用和工具执行
2. **状态管理**：内置 Checkpointer 支持工作流状态持久化
3. **人工介入**：原生支持 Human-in-the-loop 审批流程
4. **流式输出**：支持 token 级别的流式输出
5. **生产就绪**：Replit、Uber、LinkedIn、Klarna 等公司生产使用
6. **TypeScript 原生**：`@langchain/langgraph` 提供完整 TypeScript 支持

### 4.2 架构设计

```
WorkflowSystem
├── Parser (自研)                 # YAML → LangGraph StateGraph
├── Scheduler (自研)              # 定时/事件触发调度
├── Executor (LangGraph)          # 图执行引擎
│   ├── StateGraph                 # 状态图定义
│   ├── ToolNode                   # 工具执行节点
│   └── Checkpointer               # 状态持久化
├── ContextManager (自研)         # 变量上下文管理
└── HumanInteraction (LangGraph)  # Human-in-the-loop
```

### 4.3 核心依赖

```json
{
  "dependencies": {
    "@langchain/langgraph": "^0.2.x",
    "@langchain/core": "^0.3.x",
    "@langchain/anthropic": "^0.3.x"
  }
}
```

### 4.2 步骤类型

| 类型 | 说明 | 示例 |
|-----|------|------|
| `skill` | 调用 Skill 执行 | 选题分析、脚本创作 |
| `source` | 调用数据源 | 获取热点、发布内容 |
| `condition` | 条件分支 | 根据平台选择不同处理 |
| `loop` | 循环执行 | 批量处理素材 |
| `parallel` | 并行执行 | 同时生成多平台内容 |
| `human` | 人工节点 | 审核确认、手动输入 |
| `wait` | 等待 | 定时等待、事件等待 |

### 4.3 变量系统

```
变量作用域：
├── {{workspace.config.*}}     # 工作区配置
├── {{session.*}}              # 当前会话
├── {{steps.{stepId}.*}}       # 上游步骤输出
├── {{sources.{sourceSlug}.*}} # 数据源调用
├── {{env.*}}                  # 环境变量
└── {{input.*}}                # 工作流输入参数
```

### 4.4 状态管理

工作流执行状态持久化，支持：
- 断点续执行
- 失败重试
- 历史记录查看
- 执行日志

```
sessions/{sessionId}/workflows/
├── {workflowId}/
│   ├── state.json           # 当前状态
│   ├── context.json         # 变量上下文
│   └── logs/
│       └── {timestamp}.log  # 执行日志
```

---

## 5. 应用市场

### 5.1 应用来源

| 来源 | 位置 | 特点 |
|-----|------|------|
| 内置应用 | 随产品分发 | 官方维护，开箱即用 |
| 本地应用 | `~/.creator-flow/apps/` | 用户自定义 |
| 远程仓库 | GitHub / GitLab | 社区贡献，版本管理 |
| 应用市场 | `market.creatorflow.app` | 官方审核，一键安装 |

### 5.2 应用生命周期

```
发现 → 安装 → 配置 → 使用 → 更新 → 卸载
```

**安装流程**：
1. 从市场/仓库下载应用包
2. 校验 manifest 和依赖
3. 复制到 `~/.creator-flow/apps/{app-slug}/`
4. 注册到应用列表

**应用到工作区**：
1. 用户选择应用
2. 合并 skills、sources、statuses 等配置
3. 创建项目结构（如果有模板）
4. 记录应用版本，支持后续更新

### 5.3 更新策略

- **应用更新**：保留用户自定义，只更新应用原始配置
- **冲突处理**：用户修改 > 后安装应用 > 先安装应用 > 默认值
- **版本锁定**：用户可以锁定应用版本，不自动更新

---

## 6. 用户体验设计

### 6.1 新建工作区流程

```
当前流程：
  新建工作区 → 输入名称 → 手动配置 → 开始使用

新流程：
  新建工作区 → 选择应用(可多选) → 个性化配置 → 开始使用
                    ↓
              [自媒体创作者]  → 选择平台：☑小红书 ☑抖音 □公众号
              [软件开发]     → 选择语言/框架
              [学术研究]     → 选择领域
              [空白工作区]   → 从零开始
```

### 6.2 应用市场入口

```
侧边栏
├── 工作区列表
├── ─────────
├── 📦 应用市场        ← 新增入口
│   ├── 推荐应用
│   ├── 最近更新
│   ├── 分类浏览
│   └── 我的应用
```

### 6.3 工作流交互

```
会话界面
├── 聊天区域
├── ─────────
├── 📋 工作流          ← 新增面板
│   ├── 可用工作流列表
│   ├── 正在运行的工作流
│   │   └── 步骤进度可视化
│   └── 历史执行记录
```

**启动工作流**：
- 命令面板：`/workflow daily-content`
- 快捷入口：常用工作流固定在输入框上方
- 自动触发：文件变化、定时任务

**工作流执行中**：
- 显示当前步骤和进度
- 人工节点弹出确认框
- 可以暂停、取消、重试

---

## 7. 技术实现

### 7.1 新增模块

```
packages/shared/src/
├── apps/                    # 应用管理
│   ├── types.ts            # 应用类型定义
│   ├── manifest.ts         # Manifest 解析
│   ├── loader.ts           # 应用加载器
│   ├── installer.ts        # 安装/卸载
│   ├── merger.ts           # 配置合并
│   └── registry.ts         # 应用注册表
│
├── workflows/               # 工作流引擎
│   ├── types.ts            # 工作流类型
│   ├── parser.ts           # YAML 解析
│   ├── executor.ts         # 执行引擎
│   ├── context.ts          # 上下文管理
│   ├── condition.ts        # 条件求值
│   ├── state.ts            # 状态管理
│   └── steps/              # 步骤实现
│       ├── skill-step.ts
│       ├── source-step.ts
│       ├── condition-step.ts
│       ├── loop-step.ts
│       ├── parallel-step.ts
│       └── human-step.ts
│
└── market/                  # 应用市场
    ├── types.ts
    ├── client.ts           # 市场 API 客户端
    └── cache.ts            # 本地缓存
```

### 7.2 数据结构变更

**WorkspaceConfig 扩展**：

```typescript
interface WorkspaceConfig {
  // ... 现有字段

  /** 已安装的应用 */
  installedApps?: InstalledApp[];

  /** 应用配置覆盖（用户自定义） */
  appOverrides?: Record<string, AppOverride>;
}

interface InstalledApp {
  id: string;
  version: string;
  installedAt: number;
  locked?: boolean;  // 是否锁定版本
}

interface AppOverride {
  disabledSkills?: string[];
  disabledWorkflows?: string[];
  customConfig?: Record<string, unknown>;
}
```

### 7.3 存储结构

```
~/.creator-flow/
├── apps/                              # 全局应用存储
│   ├── builtin/                       # 内置应用
│   └── installed/                     # 已安装的社区应用
│
├── market-cache/                      # 市场缓存
│   ├── index.json                     # 应用索引
│   └── previews/                      # 应用预览图
│
└── workspaces/{workspaceId}/
    └── .creator-flow/
        ├── config.json                # 包含 installedApps
        ├── app-overrides/             # 应用配置覆盖
        │   └── {appId}.json
        └── workflows/                 # 工作流状态
            └── {workflowId}/
                ├── state.json
                └── history/
```

---

## 8. 实现路线图

### Phase 1：基础框架（2-3 周）

- [ ] 应用类型定义和 Manifest 规范
- [ ] 应用加载器和配置合并逻辑
- [ ] 内置应用：通用助手、自媒体创作者（基础版）
- [ ] 新建工作区流程集成应用选择

### Phase 2：工作流引擎（3-4 周）

- [ ] 工作流 YAML 解析器
- [ ] 基础步骤类型实现（skill, condition, parallel）
- [ ] 变量系统和上下文管理
- [ ] 工作流状态持久化
- [ ] UI：工作流面板、进度可视化

### Phase 3：人工节点和高级特性（2 周）

- [ ] human 步骤实现
- [ ] loop 步骤实现
- [ ] 断点续执行
- [ ] 错误处理和重试机制

### Phase 4：应用市场（2-3 周）

- [ ] 本地应用管理（安装/卸载/更新）
- [ ] 远程仓库支持（GitHub）
- [ ] 市场后端 API
- [ ] 市场 UI

### Phase 5：生态建设

- [ ] 应用开发文档和示例
- [ ] 应用提交和审核流程
- [ ] 社区应用推荐机制

---

## 9. 已确认的设计决策

### 9.1 工作流触发方式

支持三种触发方式：

| 触发方式 | 配置示例 | 说明 |
|---------|---------|------|
| 手动触发 | `trigger: manual` | 用户主动执行 |
| 定时触发 | `trigger: { schedule: "0 9 * * *" }` | Cron 表达式 |
| 事件触发 | `trigger: { event: "file:change", filter: "*.md" }` | 文件变化、消息到达等 |

### 9.2 工作流执行模式

用户可选择两种执行模式：

| 模式 | 特点 | 适用场景 |
|-----|------|--------|
| **后台模式** | 独立执行，完成后生成摘要 | 定时任务、批量处理 |
| **会话模式** | 每个步骤都在会话中可见 | 需要干预、调试 |

配置方式：
```yaml
execution:
  mode: background  # background | session
  notifyOnComplete: true
  notifyOnError: true
```

### 9.3 应用权限声明

社区应用必须声明权限，用户安装时授权：

```json
{
  "permissions": {
    "filesystem": {
      "read": ["workingDirectory"],
      "write": ["workingDirectory"]
    },
    "network": ["api.example.com"],
    "sources": {
      "required": ["gmail"],
      "optional": ["calendar"]
    },
    "system": {
      "clipboard": false,
      "notifications": true
    }
  }
}
```

安装时显示权限摘要，用户确认后安装。

### 9.4 待确认问题

1. **应用付费模式**：是否考虑付费应用？如何分成？

### 9.5 后续扩展

- 应用版本管理和回滚
- 应用依赖（一个应用依赖另一个应用）
- 团队/企业应用（私有应用商店）
- 应用数据分析（使用统计）

---

## 10. 附录

### A. 示例应用清单

| 应用 | 场景 | 核心能力 |
|-----|------|---------|
| 自媒体创作者 | 小红书/抖音/公众号 | 选题、脚本、素材、发布 |
| 软件开发 | 代码开发 | 代码生成、Review、文档 |
| 学术研究 | 论文写作 | 文献、数据分析、写作 |
| 客户服务 | 客服工作 | 知识库、话术、工单 |
| 项目管理 | 任务管理 | 规划、追踪、汇报 |
| 翻译本地化 | 多语言 | 翻译、术语、校对 |

### B. 参考资料

- Raycast Extensions
- Obsidian Plugins
- VS Code Extensions
- Zapier / n8n 工作流
