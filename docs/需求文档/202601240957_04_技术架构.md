# Craft Creator 产品定义文档 - 第四部分：技术架构设计

**文档信息**
- 模型：Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)
- 创建时间：2026-01-24 09:57:00
- 作者：@Ysf

---

## 整体架构设计

基于 CreatorFlow 的现有技术栈进行扩展，采用**桌面应用 + 云端服务**的混合架构。

```
┌─────────────────────────────────────────────────────────┐
│                    桌面应用层 (Electron)                   │
├─────────────────────────────────────────────────────────┤
│  UI 层 (React + Tailwind CSS v4)                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ - Agent 对话界面                                 │   │
│  │ - 脚本编辑器 (Monaco Editor)                     │   │
│  │ - 素材管理器 (网格/列表视图)                     │   │
│  │ - 内容预览器 (实时预览)                          │   │
│  │ - 项目管理面板                                   │   │
│  └─────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────┤
│  业务逻辑层 (packages/shared)                             │
│  ┌─────────────────────────────────────────────────┐   │
│  │ - Agent 编排引擎 (基于 Claude Agent SDK)         │   │
│  │ - 脚本管理器 (CRUD + 版本控制)                   │   │
│  │ - 素材索引引擎 (扫描 + 分析 + 检索)              │   │
│  │ - 内容生成协调器 (图文/视频生成)                 │   │
│  │ - 同步管理器 (本地 ↔ 云端)                      │   │
│  └─────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────┤
│  本地存储层                                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │ - 项目数据 (JSONL)                               │   │
│  │ - 脚本数据 (Markdown + 元数据)                   │   │
│  │ - 素材文件 (本地文件系统)                        │   │
│  │ - 素材索引 (SQLite)                              │   │
│  │ - 用户偏好 (加密存储 AES-256-GCM)                │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                            ↕ (HTTPS + WebSocket)
┌─────────────────────────────────────────────────────────┐
│                      云端服务层                           │
├─────────────────────────────────────────────────────────┤
│  API 网关 (Node.js + Express)                            │
│  ┌─────────────────────────────────────────────────┐   │
│  │ - 用户认证 (OAuth 2.0 + JWT)                     │   │
│  │ - 数据同步服务 (增量同步)                        │   │
│  │ - 素材 CDN (CloudFlare/AWS S3)                   │   │
│  │ - WebSocket 服务 (实时通知)                      │   │
│  └─────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────┤
│  AI 服务层                                                │
│  ┌─────────────────────────────────────────────────┐   │
│  │ - Claude API (脚本生成、对话、分析)              │   │
│  │ - 用户画像学习引擎 (Python + TensorFlow)         │   │
│  │ - 素材智能分析 (图像识别、视频理解)              │   │
│  │ - 内容生成引擎 (图文排版、视频剪辑)              │   │
│  │ - 推荐系统 (协同过滤 + 内容推荐)                 │   │
│  └─────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────┤
│  数据层 (PostgreSQL + Redis)                             │
│  ┌─────────────────────────────────────────────────┐   │
│  │ - 用户数据库 (用户、项目、脚本)                  │   │
│  │ - 素材元数据库 (标签、关联关系、向量)            │   │
│  │ - 学习模型存储 (用户画像、偏好)                  │   │
│  │ - 缓存层 (Redis: 热点数据、会话)                 │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────┐
│                    外部服务集成                           │
│  - 素材平台 API (Unsplash, Pexels, Pixabay)             │
│  - AI 生成服务 (Midjourney, Stable Diffusion)           │
│  - 发布平台 API (抖音开放平台、B站、小红书)              │
│  - 支付服务 (微信支付、支付宝)                           │
└─────────────────────────────────────────────────────────┘
```

---

## 核心技术组件详解

### 1. Agent 编排引擎

**基于 Claude Agent SDK 扩展**

```typescript
// 核心接口
interface AgentOrchestrator {
  // 执行用户意图
  executeIntent(intent: UserIntent): Promise<AgentResult>

  // 工具注册
  registerTool(tool: AgentTool): void

  // 工作流编排
  orchestrateWorkflow(workflow: Workflow): Promise<void>
}

// 自定义工具
const tools = [
  // 脚本生成工具
  {
    name: 'generate_script',
    description: '根据选题生成脚本大纲',
    parameters: { topic, platform, duration, style }
  },

  // 素材搜索工具
  {
    name: 'search_assets',
    description: '搜索相关素材',
    parameters: { query, type, source }
  },

  // 内容生成工具
  {
    name: 'generate_content',
    description: '生成图文或视频内容',
    parameters: { scriptId, platform, format }
  }
]
```

**工作流示例**：
```typescript
// 创作视频的完整工作流
const videoCreationWorkflow = {
  steps: [
    { tool: 'analyze_topic', input: userIntent },
    { tool: 'generate_script', input: topicAnalysis },
    { tool: 'search_assets', input: scriptRequirements },
    { tool: 'match_assets', input: { script, assets } },
    { tool: 'generate_video', input: { script, assets } }
  ]
}
```

---

### 2. 素材智能索引引擎

**功能架构**：
```
┌─────────────────────────────────────────────────────────┐
│                    素材扫描器                             │
│  - 文件系统监控 (chokidar)                               │
│  - 批量导入处理                                           │
│  - 增量更新                                               │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    AI 内容分析                            │
│  - 图像识别 (Vision API)                                 │
│  - 视频关键帧提取 (FFmpeg)                               │
│  - 音频分析 (波形、节奏)                                  │
│  - 文本提取 (OCR)                                         │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    向量化存储                             │
│  - 文本向量 (Sentence Transformers)                      │
│  - 图像向量 (CLIP)                                        │
│  - 向量数据库 (Pinecone/Milvus)                          │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    智能检索                               │
│  - 语义搜索                                               │
│  - 相似度匹配                                             │
│  - 多模态检索                                             │
└─────────────────────────────────────────────────────────┘
```

**数据结构**：
```typescript
interface AssetIndex {
  id: string
  filePath: string
  type: 'image' | 'video' | 'audio'

  // AI 分析结果
  analysis: {
    tags: string[]              // ['日落', '海边', '温暖']
    description: string          // AI 生成的描述
    dominantColors: string[]     // ['#FF6B35', '#F7931E']
    mood: string                 // '温暖'、'欢快'
    objects: string[]            // 识别的物体
    embedding: number[]          // 768 维向量
  }

  // 元数据
  metadata: {
    width: number
    height: number
    duration?: number
    fileSize: number
    createdAt: Date
  }

  // 使用记录
  usage: {
    usedInProjects: string[]
    usageCount: number
    lastUsedAt: Date
  }
}
```

---

### 3. 内容生成引擎

#### 图文生成

**技术栈**：
- Markdown 解析：`marked`
- 排版引擎：`puppeteer` (HTML → 图片/PDF)
- 模板系统：`handlebars`

**生成流程**：
```typescript
async function generateArticle(script: Script, template: Template) {
  // 1. 脚本转 Markdown
  const markdown = scriptToMarkdown(script)

  // 2. 应用模板
  const html = applyTemplate(markdown, template)

  // 3. 插入素材
  const htmlWithAssets = insertAssets(html, script.assets)

  // 4. 渲染为图片
  const images = await renderToImages(htmlWithAssets)

  return images
}
```

#### 视频生成

**技术栈**：
- 视频处理：`FFmpeg`
- 配音生成：`TTS API` (Azure/Google)
- 字幕生成：`SubRip` 格式

**生成流程**：
```typescript
async function generateVideo(script: Script, assets: Asset[]) {
  // 1. 构建时间轴
  const timeline = buildTimeline(script, assets)

  // 2. 生成配音
  const voiceOver = await generateVoiceOver(script.voiceOverText)

  // 3. 生成字幕
  const subtitles = generateSubtitles(script.subtitles)

  // 4. FFmpeg 合成
  const video = await ffmpegCompose({
    timeline,
    voiceOver,
    subtitles,
    transitions: script.transitions
  })

  return video
}
```

**FFmpeg 命令示例**：
```bash
# 合成视频
ffmpeg -i video1.mp4 -i video2.mp4 \
  -i audio.mp3 -i subtitles.srt \
  -filter_complex "[0:v][1:v]concat=n=2:v=1[outv]" \
  -map "[outv]" -map 2:a -c:v libx264 -c:a aac \
  output.mp4
```

---

### 4. 学习与个性化系统

**用户画像模型**：
```typescript
interface UserProfile {
  userId: string

  // 内容风格偏好
  contentStyle: {
    pacing: 'fast' | 'medium' | 'slow'
    tone: 'humorous' | 'serious' | 'casual'
    openingStyle: 'suspense' | 'direct' | 'story'
    visualStyle: string[]
  }

  // 素材偏好
  assetPreferences: {
    colorPalette: string[]
    musicGenres: string[]
    visualStyles: string[]
    frequentAssets: string[]
  }

  // 成功模式
  successPatterns: {
    topPerformingStructures: ScriptStructure[]
    effectiveOpenings: string[]
    engagingElements: string[]
  }

  // 学习权重
  learningWeights: {
    styleWeight: number
    assetWeight: number
    structureWeight: number
  }
}
```

**学习算法**：
```typescript
// 协同过滤推荐
function recommendAssets(userId: string, scriptContext: Context) {
  // 1. 获取用户画像
  const profile = getUserProfile(userId)

  // 2. 获取相似用户
  const similarUsers = findSimilarUsers(profile)

  // 3. 获取相似用户的素材偏好
  const recommendations = aggregatePreferences(similarUsers)

  // 4. 结合脚本上下文过滤
  const filtered = filterByContext(recommendations, scriptContext)

  return filtered
}

// 内容推荐
function recommendScriptStructure(userId: string, topic: string) {
  // 1. 分析用户历史成功案例
  const successCases = getSuccessCases(userId)

  // 2. 提取共同特征
  const patterns = extractPatterns(successCases)

  // 3. 应用到新主题
  const structure = applyPatterns(patterns, topic)

  return structure
}
```

---

## 数据同步策略

### 本地优先架构

```typescript
// 同步管理器
class SyncManager {
  // 增量同步
  async syncToCloud(changes: Change[]) {
    const compressed = compressChanges(changes)
    await uploadToCloud(compressed)
  }

  // 冲突解决
  async resolveConflicts(localData, cloudData) {
    // 策略：最后写入胜出 (Last Write Wins)
    return localData.timestamp > cloudData.timestamp
      ? localData
      : cloudData
  }

  // 离线队列
  async queueOfflineChanges(changes: Change[]) {
    await localDB.queue.add(changes)
  }
}
```

---

## 性能优化策略

### 1. 素材处理优化
- **缩略图生成**：首次导入时生成多尺寸缩略图
- **懒加载**：素材列表使用虚拟滚动
- **增量索引**：只处理新增和修改的文件

### 2. AI 调用优化
- **请求合并**：批量处理多个素材分析请求
- **缓存策略**：相同请求缓存结果（Redis）
- **流式响应**：长文本生成使用流式输出

### 3. 视频渲染优化
- **云端渲染**：复杂视频使用云端渲染
- **预览模式**：低分辨率快速预览
- **后台渲染**：不阻塞 UI 操作

---

## 安全性设计

### 1. 数据加密
- **本地存储**：AES-256-GCM 加密敏感数据
- **传输加密**：HTTPS + TLS 1.3
- **API 密钥**：安全存储，不暴露给前端

### 2. 权限控制
- **OAuth 2.0**：第三方平台授权
- **JWT Token**：用户身份验证
- **RBAC**：基于角色的访问控制

### 3. 隐私保护
- **本地优先**：敏感数据优先本地存储
- **可选同步**：用户控制数据上传
- **数据脱敏**：日志中移除敏感信息

---

## 技术栈总结

| 层级 | 技术选型 |
|------|---------|
| **桌面端** | Electron + React + TypeScript |
| **UI 框架** | Tailwind CSS v4 + shadcn/ui |
| **状态管理** | Jotai |
| **AI SDK** | @anthropic-ai/claude-agent-sdk |
| **本地存储** | SQLite + JSONL |
| **云端后端** | Node.js + Express |
| **数据库** | PostgreSQL + Redis |
| **向量数据库** | Pinecone / Milvus |
| **视频处理** | FFmpeg |
| **图像处理** | Sharp |
| **AI 服务** | Claude API + Vision API |
| **部署** | Docker + Kubernetes |

---

**上一部分**：[03_用户工作流.md](./202601240956_03_用户工作流.md)
**下一部分**：[05_数据模型.md](./202601240958_05_数据模型.md)
