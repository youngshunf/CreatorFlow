# OnlyOffice äº‘ç«¯é›†æˆ + AI åä½œæŠ€æœ¯æ–¹æ¡ˆ

## æ¦‚è¿°

æœ¬æ–¹æ¡ˆé‡‡ç”¨äº‘ç«¯ OnlyOffice Document Server + æ¡Œé¢ç«¯ Electron å®¢æˆ·ç«¯æ¶æ„ï¼Œå®ç° Office æ–‡æ¡£çš„é«˜ä¿çœŸç¼–è¾‘ä¸ AI åä½œåŠŸèƒ½ã€‚

### æ ¸å¿ƒä¼˜åŠ¿

- **é›¶æœ¬åœ°ä¾èµ–**ï¼šç”¨æˆ·æ— éœ€å®‰è£… LibreOffice æˆ– OnlyOffice
- **é«˜ä¿çœŸç¼–è¾‘**ï¼šæ”¯æŒå¤æ‚æ ·å¼ã€æ‰¹æ³¨ã€ä¿®è®¢ç­‰é«˜çº§åŠŸèƒ½
- **ç»Ÿä¸€ä½“éªŒ**ï¼šè·¨å¹³å°ä¸€è‡´çš„ç¼–è¾‘ä½“éªŒ
- **æ˜“äºç»´æŠ¤**ï¼šæœåŠ¡ç«¯ç»Ÿä¸€å‡çº§ï¼Œå®¢æˆ·ç«¯è½»é‡åŒ–

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CreatorFlow Electron                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ File Managerâ”‚  â”‚   webview   â”‚  â”‚    AI Service       â”‚  â”‚
â”‚  â”‚  (Chonky)   â”‚  â”‚ OnlyOffice  â”‚  â”‚  (CraftAgent)       â”‚  â”‚
â”‚  â”‚             â”‚  â”‚   Editor    â”‚  â”‚                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                â”‚                     â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                          â”‚ postMessage                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                             â”‚
â”‚                    â”‚  IPC Bus  â”‚                             â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTPS
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DMS API        â”‚ â”‚ OnlyOffice  â”‚ â”‚  File Storage   â”‚
â”‚  (æ–‡ä»¶å›è°ƒæœåŠ¡)  â”‚ â”‚ Doc Server  â”‚ â”‚  (S3/OSS/æœ¬åœ°)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 1: äº‘ç«¯ OnlyOffice éƒ¨ç½²ï¼ˆ2 å¤©ï¼‰

### 1.1 Docker Compose éƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'

services:
  onlyoffice:
    image: onlyoffice/documentserver:latest
    container_name: onlyoffice-docs
    ports:
      - "8080:80"
      - "8443:443"
    environment:
      - JWT_ENABLED=true
      - JWT_SECRET=${ONLYOFFICE_JWT_SECRET}
      - JWT_HEADER=Authorization
      - JWT_IN_BODY=false
    volumes:
      - oo_data:/var/www/onlyoffice/Data
      - oo_logs:/var/log/onlyoffice
      - oo_fonts:/usr/share/fonts/truetype/custom
    restart: unless-stopped

volumes:
  oo_data:
  oo_logs:
  oo_fonts:
```

### 1.2 Nginx åå‘ä»£ç†é…ç½®

```nginx
# /etc/nginx/conf.d/onlyoffice.conf
upstream onlyoffice {
    server 127.0.0.1:8080;
}

server {
    listen 443 ssl http2;
    server_name docs.creatorflow.app;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://onlyoffice;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket æ”¯æŒ
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }
}
```

### 1.3 å¥åº·æ£€æŸ¥ç«¯ç‚¹

```bash
# éªŒè¯éƒ¨ç½²æˆåŠŸ
curl https://docs.creatorflow.app/healthcheck
# é¢„æœŸè¿”å›: true
```

---

## Phase 2: DMS æ–‡ä»¶æœåŠ¡é€‚é…ï¼ˆ3 å¤©ï¼‰

### 2.1 DMS API æ¥å£è®¾è®¡

OnlyOffice éœ€è¦é€šè¿‡å›è°ƒ URL è¯»å–å’Œä¿å­˜æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä»¥ä¸‹æ¥å£ï¼š

```typescript
// æ¥å£å®šä¹‰
interface DMSApi {
  // è·å–æ–‡ä»¶å†…å®¹ (OnlyOffice è°ƒç”¨)
  'GET /api/dms/files/:fileId': () => FileStream;
  
  // ä¿å­˜æ–‡ä»¶å†…å®¹ (OnlyOffice å›è°ƒ)
  'POST /api/dms/callback': (body: OnlyOfficeCallback) => { error: 0 };
  
  // è·å–æ–‡ä»¶ç¼–è¾‘é…ç½® (Electron è°ƒç”¨)
  'POST /api/dms/editor-config': (body: EditorConfigRequest) => EditorConfig;
}
```

### 2.2 æ–‡ä»¶ä¸Šä¼ ä¸å­˜å‚¨

```typescript
// server/routes/dms.ts
import { Router } from 'express';
import { S3Client, PutObjectCommand, GetObjectCommand } from '@aws-sdk/client-s3';
import { v4 as uuidv4 } from 'uuid';

const router = Router();
const s3 = new S3Client({ region: process.env.AWS_REGION });

// ä¸Šä¼ æ–‡ä»¶
router.post('/files/upload', upload.single('file'), async (req, res) => {
  const fileId = uuidv4();
  const key = `documents/${fileId}/${req.file.originalname}`;
  
  await s3.send(new PutObjectCommand({
    Bucket: process.env.S3_BUCKET,
    Key: key,
    Body: req.file.buffer,
    ContentType: req.file.mimetype
  }));
  
  // è®°å½•æ–‡ä»¶å…ƒæ•°æ®
  await db.files.create({
    id: fileId,
    name: req.file.originalname,
    key,
    size: req.file.size,
    workspaceId: req.body.workspaceId,
    createdBy: req.user.id
  });
  
  res.json({ fileId, name: req.file.originalname });
});

// è·å–æ–‡ä»¶å†…å®¹ (ä¾› OnlyOffice æ‹‰å–)
router.get('/files/:fileId', async (req, res) => {
  const file = await db.files.findById(req.params.fileId);
  if (!file) return res.status(404).send('File not found');
  
  const object = await s3.send(new GetObjectCommand({
    Bucket: process.env.S3_BUCKET,
    Key: file.key
  }));
  
  res.setHeader('Content-Type', file.mimeType);
  res.setHeader('Content-Disposition', `attachment; filename="${file.name}"`);
  object.Body.pipe(res);
});
```

### 2.3 OnlyOffice å›è°ƒå¤„ç†

```typescript
// server/routes/dms.ts
interface OnlyOfficeCallback {
  key: string;           // æ–‡æ¡£å”¯ä¸€æ ‡è¯†
  status: number;        // 2=ready to save, 6=force save
  url?: string;          // ä¿®æ”¹åæ–‡æ¡£çš„ä¸‹è½½ URL
  changesurl?: string;   // å˜æ›´å†å² URL
  history?: object;      // ç‰ˆæœ¬å†å²
  users?: string[];      // å½“å‰ç¼–è¾‘ç”¨æˆ·
}

router.post('/callback', async (req, res) => {
  const { key, status, url } = req.body as OnlyOfficeCallback;
  
  // éªŒè¯ JWT
  const token = req.headers.authorization?.replace('Bearer ', '');
  if (!verifyJWT(token)) {
    return res.status(403).json({ error: 1 });
  }
  
  // status 2 æˆ– 6 è¡¨ç¤ºéœ€è¦ä¿å­˜
  if (status === 2 || status === 6) {
    try {
      // ä» OnlyOffice ä¸‹è½½ä¿®æ”¹åçš„æ–‡ä»¶
      const response = await fetch(url);
      const buffer = await response.arrayBuffer();
      
      // ä¿å­˜åˆ°å­˜å‚¨
      const file = await db.files.findByKey(key);
      await s3.send(new PutObjectCommand({
        Bucket: process.env.S3_BUCKET,
        Key: file.key,
        Body: Buffer.from(buffer)
      }));
      
      // æ›´æ–°å…ƒæ•°æ®
      await db.files.update(file.id, {
        updatedAt: new Date(),
        version: file.version + 1
      });
      
      res.json({ error: 0 });
    } catch (err) {
      console.error('Save failed:', err);
      res.json({ error: 1 });
    }
  } else {
    res.json({ error: 0 });
  }
});
```

### 2.4 JWT ç­¾åæœåŠ¡

```typescript
// server/services/jwt.ts
import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.ONLYOFFICE_JWT_SECRET;

export function signEditorConfig(config: object): string {
  return jwt.sign(config, JWT_SECRET, { expiresIn: '1h' });
}

export function verifyJWT(token: string): boolean {
  try {
    jwt.verify(token, JWT_SECRET);
    return true;
  } catch {
    return false;
  }
}
```

---

## Phase 3: Electron å®¢æˆ·ç«¯é›†æˆï¼ˆ3 å¤©ï¼‰

### 3.1 OnlyOffice é…ç½®ç”Ÿæˆ

```typescript
// apps/electron/src/main/onlyoffice/config.ts
interface EditorConfig {
  document: {
    fileType: string;
    key: string;
    title: string;
    url: string;
    permissions: {
      edit: boolean;
      download: boolean;
      print: boolean;
    };
  };
  editorConfig: {
    callbackUrl: string;
    lang: string;
    mode: 'edit' | 'view';
    user: {
      id: string;
      name: string;
    };
    customization: {
      autosave: boolean;
      forcesave: boolean;
      plugins: boolean;
    };
  };
  token?: string;
}

export async function generateEditorConfig(
  filePath: string,
  userId: string,
  userName: string
): Promise<EditorConfig> {
  // 1. ä¸Šä¼ æœ¬åœ°æ–‡ä»¶åˆ° DMS
  const fileInfo = await uploadFileToDMS(filePath);
  
  // 2. ç”Ÿæˆå”¯ä¸€æ–‡æ¡£ key
  const documentKey = `${fileInfo.fileId}_${Date.now()}`;
  
  // 3. æ„å»ºé…ç½®
  const config: EditorConfig = {
    document: {
      fileType: getFileExtension(filePath),
      key: documentKey,
      title: path.basename(filePath),
      url: `${DMS_BASE_URL}/api/dms/files/${fileInfo.fileId}`,
      permissions: {
        edit: true,
        download: true,
        print: true
      }
    },
    editorConfig: {
      callbackUrl: `${DMS_BASE_URL}/api/dms/callback`,
      lang: 'zh',
      mode: 'edit',
      user: {
        id: userId,
        name: userName
      },
      customization: {
        autosave: true,
        forcesave: true,
        plugins: true
      }
    }
  };
  
  // 4. JWT ç­¾å
  const response = await fetch(`${DMS_BASE_URL}/api/dms/editor-config`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(config)
  });
  
  return response.json();
}
```

### 3.2 IPC é€šé“å®šä¹‰

```typescript
// apps/electron/src/shared/types.ts
export type IpcChannels = {
  // ... ç°æœ‰ channels
  
  // OnlyOffice ç›¸å…³
  'onlyoffice:getConfig': (filePath: string) => Promise<EditorConfig>;
  'onlyoffice:processAI': (params: AIProcessParams) => Promise<string>;
  'onlyoffice:downloadFile': (fileId: string, savePath: string) => Promise<void>;
};

interface AIProcessParams {
  sessionId: string;
  action: string;
  text: string;
  customPrompt?: string;
}
```

### 3.3 ä¸»è¿›ç¨‹ IPC å¤„ç†

```typescript
// apps/electron/src/main/onlyoffice/ipc.ts
import { ipcMain } from 'electron';
import { generateEditorConfig } from './config';
import { handleOnlyOfficeAI } from './ai-handler';

export function registerOnlyOfficeIpc() {
  ipcMain.handle('onlyoffice:getConfig', async (_, filePath: string) => {
    const user = await getCurrentUser();
    return generateEditorConfig(filePath, user.id, user.name);
  });
  
  ipcMain.handle('onlyoffice:processAI', async (_, params: AIProcessParams) => {
    const agent = await getSessionAgent(params.sessionId);
    return handleOnlyOfficeAI(agent, params.action, params.text, params.customPrompt);
  });
}
```

### 3.4 Renderer ç¼–è¾‘å™¨ç»„ä»¶

```typescript
// apps/electron/src/renderer/components/onlyoffice/OnlyOfficeEditor.tsx
import { useEffect, useRef, useState } from 'react';
import { Loader2 } from 'lucide-react';

interface OnlyOfficeEditorProps {
  filePath: string;
  sessionId: string;
}

export function OnlyOfficeEditor({ filePath, sessionId }: OnlyOfficeEditorProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    let docEditor: any = null;

    const initEditor = async () => {
      try {
        // 1. è·å–ç¼–è¾‘å™¨é…ç½®
        const config = await window.electronAPI.onlyoffice.getConfig(filePath);
        
        // 2. æ·»åŠ äº‹ä»¶å¤„ç†
        config.events = {
          onDocumentReady: () => setLoading(false),
          onError: (e: any) => setError(e.data?.errorDescription || 'ç¼–è¾‘å™¨é”™è¯¯'),
          onRequestClose: () => window.close()
        };
        
        // 3. åˆå§‹åŒ–ç¼–è¾‘å™¨
        docEditor = new (window as any).DocsAPI.DocEditor(
          containerRef.current!.id,
          config
        );
      } catch (err) {
        setError(err instanceof Error ? err.message : 'åˆå§‹åŒ–å¤±è´¥');
      }
    };

    initEditor();

    return () => {
      docEditor?.destroyEditor();
    };
  }, [filePath]);

  if (error) {
    return (
      <div className="flex items-center justify-center h-full">
        <p className="text-destructive">{error}</p>
      </div>
    );
  }

  return (
    <div className="relative w-full h-full">
      {loading && (
        <div className="absolute inset-0 flex items-center justify-center bg-background/80">
          <Loader2 className="w-8 h-8 animate-spin" />
        </div>
      )}
      <div
        id="onlyoffice-editor"
        ref={containerRef}
        className="w-full h-full"
      />
    </div>
  );
}
```

### 3.5 åŠ è½½ OnlyOffice API è„šæœ¬

```typescript
// apps/electron/src/renderer/hooks/useOnlyOfficeScript.ts
import { useEffect, useState } from 'react';

const ONLYOFFICE_URL = 'https://docs.creatorflow.app';

export function useOnlyOfficeScript() {
  const [loaded, setLoaded] = useState(false);
  const [error, setError] = useState<Error | null>(null);

  useEffect(() => {
    if ((window as any).DocsAPI) {
      setLoaded(true);
      return;
    }

    const script = document.createElement('script');
    script.src = `${ONLYOFFICE_URL}/web-apps/apps/api/documents/api.js`;
    script.async = true;
    script.onload = () => setLoaded(true);
    script.onerror = () => setError(new Error('Failed to load OnlyOffice API'));
    
    document.body.appendChild(script);

    return () => {
      document.body.removeChild(script);
    };
  }, []);

  return { loaded, error };
}
```

---

## Phase 4: AI åä½œæ’ä»¶å¼€å‘ï¼ˆ5 å¤©ï¼‰

### 4.1 æ’ä»¶æ¶æ„è®¾è®¡

```
onlyoffice-ai-plugin/
â”œâ”€â”€ config.json              # æ’ä»¶æè¿°ä¸å…¥å£é…ç½®
â”œâ”€â”€ index.html               # æ’ä»¶ UI é¢æ¿
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ plugin.js            # ä¸»é€»è¾‘ï¼šä¸ç¼–è¾‘å™¨ API äº¤äº’
â”‚   â”œâ”€â”€ ai-bridge.js         # ä¸ Electron postMessage æ¡¥æ¥
â”‚   â””â”€â”€ ui-controller.js     # é¢æ¿ UI äº¤äº’é€»è¾‘
â”œâ”€â”€ styles/
â”‚   â””â”€â”€ plugin.css
â””â”€â”€ translations/
    â”œâ”€â”€ en.json
    â””â”€â”€ zh.json
```

### 4.2 config.json ç¤ºä¾‹

```json
{
  "name": "CreatorFlow AI",
  "guid": "asc.{CF-AI-PLUGIN-GUID}",
  "version": "1.0.0",
  "variations": [
    {
      "description": "AI åä½œåŠ©æ‰‹",
      "url": "index.html",
      "icons": ["icon.png"],
      "isViewer": false,
      "EditorsSupport": ["word", "cell", "slide"],
      "isVisual": true,
      "isModal": false,
      "isInsideMode": true,
      "initDataType": "text",
      "initData": "",
      "buttons": [
        { "text": "AI åŠ©æ‰‹", "primary": true }
      ]
    }
  ]
}
```

### 4.3 æ ¸å¿ƒ AI åŠŸèƒ½å®ç°

#### 4.3.1 è·å–é€‰åŒºæ–‡æœ¬

```javascript
// scripts/plugin.js
window.Asc.plugin.init = function() {
  // æ’ä»¶åˆå§‹åŒ–
};

window.Asc.plugin.button = function(id) {
  if (id === 0) { // ä¸»æŒ‰é’®ç‚¹å‡»
    this.callCommand(function() {
      var selection = Api.GetDocument().GetSelectedText();
      return selection;
    }, false, true, function(result) {
      // å‘é€åˆ° AI æœåŠ¡
      sendToElectron('ai:process', { text: result, action: 'current' });
    });
  }
};
```

#### 4.3.2 Electron æ¡¥æ¥é€šä¿¡

```javascript
// scripts/ai-bridge.js
function sendToElectron(channel, data) {
  window.parent.postMessage({
    type: 'onlyoffice-ai',
    channel: channel,
    payload: data
  }, '*');
}

window.addEventListener('message', function(event) {
  if (event.data.type === 'ai-response') {
    handleAIResponse(event.data.payload);
  }
});

function handleAIResponse(payload) {
  switch (payload.action) {
    case 'replace':
      replaceSelection(payload.text);
      break;
    case 'insert':
      insertAtCursor(payload.text);
      break;
    case 'comment':
      addComment(payload.text);
      break;
  }
}
```

#### 4.3.3 æ›¿æ¢é€‰åŒºå†…å®¹

```javascript
function replaceSelection(newText) {
  window.Asc.plugin.callCommand(function() {
    var doc = Api.GetDocument();
    var range = doc.GetRangeBySelect();
    if (range) {
      range.Delete();
      range.AddText(newText);
    }
  }, true, true);
}
```

### 4.4 AI åŠŸèƒ½èœå•

```javascript
// scripts/ui-controller.js
const AI_ACTIONS = [
  { id: 'translate', label: 'ç¿»è¯‘', icon: 'ğŸŒ', prompt: 'translate' },
  { id: 'rewrite', label: 'æ”¹å†™æ¶¦è‰²', icon: 'âœ¨', prompt: 'rewrite' },
  { id: 'expand', label: 'æ‰©å±•å†…å®¹', icon: 'ğŸ“', prompt: 'expand' },
  { id: 'summarize', label: 'æ€»ç»“æ‘˜è¦', icon: 'ğŸ“‹', prompt: 'summarize' },
  { id: 'simplify', label: 'ç®€åŒ–è¡¨è¾¾', icon: 'ğŸ¯', prompt: 'simplify' },
  { id: 'formal', label: 'æ­£å¼åŒ–', icon: 'ğŸ‘”', prompt: 'formal' },
  { id: 'casual', label: 'å£è¯­åŒ–', icon: 'ğŸ’¬', prompt: 'casual' },
  { id: 'fix', label: 'ä¿®æ­£è¯­æ³•', icon: 'ğŸ”§', prompt: 'fix_grammar' },
  { id: 'custom', label: 'è‡ªå®šä¹‰æŒ‡ä»¤', icon: 'âš¡', prompt: null }
];

function renderActionMenu() {
  const container = document.getElementById('ai-actions');
  AI_ACTIONS.forEach(action => {
    const btn = document.createElement('button');
    btn.className = 'ai-action-btn';
    btn.innerHTML = `${action.icon} ${action.label}`;
    btn.onclick = () => executeAction(action);
    container.appendChild(btn);
  });
}
```

### 4.5 Electron ç«¯ AI å¤„ç†

```typescript
// apps/electron/src/main/onlyoffice/ai-handler.ts
import { CraftAgent } from '@craft-agent/shared';

export async function handleOnlyOfficeAI(
  agent: CraftAgent,
  action: string,
  text: string,
  customPrompt?: string
): Promise<string> {
  const prompts: Record<string, string> = {
    translate: `å°†ä»¥ä¸‹æ–‡æœ¬ç¿»è¯‘ä¸ºè‹±æ–‡ï¼ˆå¦‚æœæ˜¯è‹±æ–‡åˆ™ç¿»è¯‘ä¸ºä¸­æ–‡ï¼‰ï¼Œä¿æŒåŸæœ‰æ ¼å¼ï¼š\n\n${text}`,
    rewrite: `æ”¹å†™æ¶¦è‰²ä»¥ä¸‹æ–‡æœ¬ï¼Œä½¿å…¶æ›´åŠ æµç•…ä¸“ä¸šï¼Œä¿æŒåŸæ„ï¼š\n\n${text}`,
    expand: `æ‰©å±•ä»¥ä¸‹å†…å®¹ï¼Œæ·»åŠ æ›´å¤šç»†èŠ‚å’Œè®ºè¿°ï¼Œä¿æŒé£æ ¼ä¸€è‡´ï¼š\n\n${text}`,
    summarize: `æ€»ç»“ä»¥ä¸‹å†…å®¹çš„è¦ç‚¹ï¼Œç®€æ˜æ‰¼è¦ï¼š\n\n${text}`,
    simplify: `ç®€åŒ–ä»¥ä¸‹æ–‡æœ¬ï¼Œä½¿ç”¨æ›´ç®€å•æ˜“æ‡‚çš„è¡¨è¾¾ï¼š\n\n${text}`,
    formal: `å°†ä»¥ä¸‹æ–‡æœ¬æ”¹å†™ä¸ºæ­£å¼çš„ä¹¦é¢è¯­é£æ ¼ï¼š\n\n${text}`,
    casual: `å°†ä»¥ä¸‹æ–‡æœ¬æ”¹å†™ä¸ºè½»æ¾çš„å£è¯­åŒ–é£æ ¼ï¼š\n\n${text}`,
    fix_grammar: `ä¿®æ­£ä»¥ä¸‹æ–‡æœ¬ä¸­çš„è¯­æ³•å’Œæ‹¼å†™é”™è¯¯ï¼š\n\n${text}`
  };

  const prompt = customPrompt || prompts[action] || text;
  
  const response = await agent.chat(prompt);
  return response.content;
}
```

### 4.6 webview æ¶ˆæ¯ç›‘å¬

```typescript
// apps/electron/src/renderer/components/onlyoffice/OnlyOfficeEditor.tsx
useEffect(() => {
  const handleMessage = async (event: MessageEvent) => {
    if (event.data.type !== 'onlyoffice-ai') return;
    
    const { channel, payload } = event.data;
    
    if (channel === 'ai:process') {
      setProcessing(true);
      try {
        const result = await window.electronAPI.onlyoffice.processAI({
          sessionId: currentSessionId,
          action: payload.action,
          text: payload.text
        });
        
        // å‘å›ç»™ webview ä¸­çš„æ’ä»¶
        webviewRef.current?.contentWindow?.postMessage({
          type: 'ai-response',
          payload: { action: 'replace', text: result }
        }, '*');
      } catch (error) {
        console.error('AI processing failed:', error);
      } finally {
        setProcessing(false);
      }
    }
  };
  
  window.addEventListener('message', handleMessage);
  return () => window.removeEventListener('message', handleMessage);
}, [currentSessionId]);
```

---

## Phase 5: æ–‡ä»¶ç®¡ç†å™¨é›†æˆï¼ˆ4 å¤©ï¼‰

### 5.1 å®‰è£… Chonky

```bash
bun add chonky chonky-icon-fontawesome
```

### 5.2 æ–‡ä»¶ç®¡ç†å™¨ IPC

```typescript
// apps/electron/src/shared/types.ts - æ–°å¢ channels
export type IpcChannels = {
  // ... ç°æœ‰ channels
  
  // æ–‡ä»¶ç®¡ç†å™¨
  'fm:listDirectory': (path: string) => Promise<FileEntry[]>;
  'fm:createFolder': (path: string, name: string) => Promise<void>;
  'fm:delete': (paths: string[]) => Promise<void>;
  'fm:rename': (oldPath: string, newPath: string) => Promise<void>;
  'fm:copy': (src: string[], dest: string) => Promise<void>;
  'fm:move': (src: string[], dest: string) => Promise<void>;
  'fm:openInEditor': (path: string) => Promise<void>;
};

export interface FileEntry {
  id: string;
  name: string;
  isDir: boolean;
  size?: number;
  modDate?: Date;
  ext?: string;
}
```

### 5.3 ä¸»è¿›ç¨‹å®ç°

```typescript
// apps/electron/src/main/file-manager.ts
import { ipcMain } from 'electron';
import * as fs from 'fs/promises';
import * as path from 'path';

export function registerFileManagerIpc() {
  ipcMain.handle('fm:listDirectory', async (_, dirPath: string) => {
    const entries = await fs.readdir(dirPath, { withFileTypes: true });
    return entries
      .filter(e => !e.name.startsWith('.')) // éšè—æ–‡ä»¶
      .map(e => ({
        id: path.join(dirPath, e.name),
        name: e.name,
        isDir: e.isDirectory(),
        ext: e.isDirectory() ? undefined : path.extname(e.name).toLowerCase()
      }));
  });
  
  ipcMain.handle('fm:delete', async (_, paths: string[]) => {
    for (const p of paths) {
      await fs.rm(p, { recursive: true });
    }
  });
  
  ipcMain.handle('fm:rename', async (_, oldPath: string, newPath: string) => {
    await fs.rename(oldPath, newPath);
  });
  
  // ... å…¶ä»–æ“ä½œ
}
```

### 5.4 Chonky æ–‡ä»¶æµè§ˆå™¨ç»„ä»¶

```typescript
// apps/electron/src/renderer/components/file-manager/FileManager.tsx
import { FileBrowser, FileNavbar, FileToolbar, FileList, FileContextMenu, ChonkyActions } from 'chonky';
import { ChonkyIconFA } from 'chonky-icon-fontawesome';

interface FileManagerProps {
  workspacePath: string;
  onFileOpen: (file: FileEntry) => void;
}

export function FileManager({ workspacePath, onFileOpen }: FileManagerProps) {
  const [currentPath, setCurrentPath] = useState(workspacePath);
  const [files, setFiles] = useState<FileArray>([]);
  
  useEffect(() => {
    loadDirectory(currentPath);
  }, [currentPath]);
  
  const loadDirectory = async (path: string) => {
    const entries = await window.electronAPI.fm.listDirectory(path);
    setFiles(entries.map(e => ({
      id: e.id,
      name: e.name,
      isDir: e.isDir,
      ext: e.ext
    })));
  };
  
  const handleFileAction = useCallback((data: ChonkyFileActionData) => {
    switch (data.id) {
      case ChonkyActions.OpenFiles.id:
        const file = data.payload.targetFile;
        if (file?.isDir) {
          setCurrentPath(file.id);
        } else if (file) {
          onFileOpen(file);
        }
        break;
      case ChonkyActions.DeleteFiles.id:
        handleDelete(data.state.selectedFiles);
        break;
      // ... å…¶ä»–æ“ä½œ
    }
  }, []);
  
  // è‡ªå®šä¹‰ AI åä½œ Action
  const aiCollabAction: FileAction = {
    id: 'ai_collaborate',
    button: {
      name: 'AI åä½œ',
      toolbar: true,
      contextMenu: true,
      icon: ChonkyIconName.flash
    }
  };
  
  return (
    <FileBrowser
      files={files}
      folderChain={buildFolderChain(currentPath, workspacePath)}
      onFileAction={handleFileAction}
      fileActions={[aiCollabAction, ...ChonkyActions.DefaultFileActions]}
      iconComponent={ChonkyIconFA}
    >
      <FileNavbar />
      <FileToolbar />
      <FileList />
      <FileContextMenu />
    </FileBrowser>
  );
}
```

### 5.5 é›†æˆåˆ°ä¾§è¾¹æ 

```typescript
// apps/electron/src/renderer/components/app-shell/sidebar-types.ts
export type SidebarMode = 
  | { type: 'chat' }
  | { type: 'files' }  // æ–°å¢
  | { type: 'settings' };
```

```typescript
// apps/electron/src/renderer/components/app-shell/LeftSidebar.tsx
{sidebarMode.type === 'files' && (
  <FileManager
    workspacePath={currentWorkspace.path}
    onFileOpen={handleFileOpen}
  />
)}
```

### 5.6 æ–‡ä»¶æ‰“å¼€è·¯ç”±

```typescript
const handleFileOpen = (file: FileEntry) => {
  const officeExtensions = ['.docx', '.xlsx', '.pptx', '.doc', '.xls', '.ppt', '.pdf'];
  
  if (officeExtensions.includes(file.ext || '')) {
    // æ‰“å¼€ OnlyOffice ç¼–è¾‘å™¨
    navigate({
      type: 'document-editor',
      filePath: file.id
    });
  } else {
    // æ‰“å¼€ä»£ç /æ–‡æœ¬æŸ¥çœ‹å™¨
    navigate({
      type: 'file-viewer',
      filePath: file.id
    });
  }
};
```

---

## Phase 6: æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ3 å¤©ï¼‰

### 6.1 æµ‹è¯•çŸ©é˜µ

**åŠŸèƒ½æµ‹è¯•**
- [ ] OnlyOffice è¿æ¥ä¸è®¤è¯
- [ ] æ–‡æ¡£æ‰“å¼€ï¼ˆDOCX/XLSX/PPTX/PDFï¼‰
- [ ] æ–‡æ¡£ç¼–è¾‘ä¸ä¿å­˜
- [ ] AI åŠŸèƒ½ï¼ˆç¿»è¯‘/æ”¹å†™/æ‰©å±•/æ€»ç»“ï¼‰
- [ ] æ–‡ä»¶ç®¡ç†å™¨åŸºæœ¬æ“ä½œ

**è¾¹ç•Œæ¡ä»¶**
- [ ] å¤§æ–‡ä»¶å¤„ç†ï¼ˆ>50MBï¼‰
- [ ] ç½‘ç»œæ–­å¼€æ¢å¤
- [ ] å¹¶å‘ç¼–è¾‘å†²çª
- [ ] ç‰¹æ®Šå­—ç¬¦æ–‡ä»¶å

**æ€§èƒ½æµ‹è¯•**
- [ ] æ–‡æ¡£åŠ è½½æ—¶é—´ < 3s
- [ ] AI å“åº”æ—¶é—´ < 5s
- [ ] å†…å­˜å ç”¨ç›‘æ§

### 6.2 é”™è¯¯å¤„ç†å¢å¼º

```typescript
// apps/electron/src/renderer/components/onlyoffice/ErrorBoundary.tsx
export function OnlyOfficeErrorBoundary({ children }: PropsWithChildren) {
  const [error, setError] = useState<Error | null>(null);
  
  if (error) {
    return (
      <div className="flex flex-col items-center justify-center h-full">
        <AlertCircle className="w-12 h-12 text-destructive" />
        <h3 className="mt-4 text-lg font-medium">æ–‡æ¡£æœåŠ¡è¿æ¥å¤±è´¥</h3>
        <p className="mt-2 text-muted-foreground">{error.message}</p>
        <Button className="mt-4" onClick={() => setError(null)}>
          é‡è¯•
        </Button>
      </div>
    );
  }
  
  return <ErrorBoundary onError={setError}>{children}</ErrorBoundary>;
}
```

### 6.3 æ€§èƒ½ä¼˜åŒ–

**æ–‡ä»¶é¢„åŠ è½½**
```typescript
// é¢„å…ˆè·å– JWT å’Œ documentKeyï¼Œå‡å°‘æ‰“å¼€å»¶è¿Ÿ
const prefetchDocument = async (filePath: string) => {
  const config = await window.electronAPI.onlyoffice.prepareDocument(filePath);
  documentCache.set(filePath, config);
};
```

**AI å“åº”æµå¼è¾“å‡º**
```typescript
// æµå¼æ˜¾ç¤º AI ç»“æœï¼Œæå‡æ„ŸçŸ¥é€Ÿåº¦
const streamAIResponse = async (text: string, action: string) => {
  const stream = await window.electronAPI.onlyoffice.processAIStream({
    text,
    action
  });
  
  let accumulated = '';
  for await (const chunk of stream) {
    accumulated += chunk;
    updatePreview(accumulated);
  }
  
  return accumulated;
};
```

---

## é™„å½•

### A. æŠ€æœ¯æ ˆæ±‡æ€»

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç”¨é€” |
|------|----------|------|
| æ–‡æ¡£æœåŠ¡ | OnlyOffice Document Server | äº‘ç«¯æ–‡æ¡£ç¼–è¾‘ |
| æ–‡ä»¶å­˜å‚¨ | è‡ªå»º DMS API | æ–‡ä»¶è¯»å†™å›è°ƒ |
| å‰ç«¯é›†æˆ | webview + postMessage | ç¼–è¾‘å™¨åµŒå…¥ |
| AI åä½œ | OnlyOffice Plugin | æ’ä»¶å¼ AI åŠŸèƒ½ |
| æ–‡ä»¶ç®¡ç† | Chonky | æ–‡ä»¶æµè§ˆå™¨ UI |
| é€šä¿¡å®‰å…¨ | JWT | API è®¤è¯ |

### B. å·¥æœŸæ±‡æ€»

| é˜¶æ®µ | å·¥ä½œæ—¥ |
|------|--------|
| Phase 1: äº‘ç«¯éƒ¨ç½² | 2 å¤© |
| Phase 2: DMS é€‚é… | 3 å¤© |
| Phase 3: Electron é›†æˆ | 3 å¤© |
| Phase 4: AI æ’ä»¶å¼€å‘ | 5 å¤© |
| Phase 5: æ–‡ä»¶ç®¡ç†å™¨ | 4 å¤© |
| Phase 6: æµ‹è¯•ä¼˜åŒ– | 3 å¤© |
| **æ€»è®¡** | **20 å¤©** |

### C. é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| OnlyOffice æœåŠ¡ä¸ç¨³å®š | é«˜ | å¥åº·æ£€æŸ¥ + è‡ªåŠ¨é‡è¿ + é™çº§æç¤º |
| JWT å®‰å…¨æ¼æ´ | é«˜ | çŸ­æœ‰æ•ˆæœŸ + HTTPS + å®šæœŸè½®æ¢å¯†é’¥ |
| å¤§æ–‡ä»¶ä¸Šä¼ æ…¢ | ä¸­ | åˆ†ç‰‡ä¸Šä¼  + è¿›åº¦æç¤º |
| AI å“åº”æ…¢ | ä¸­ | æµå¼è¾“å‡º + è¶…æ—¶å–æ¶ˆ |
| æµè§ˆå™¨å…¼å®¹æ€§ | ä½ | Electron webview ç‰ˆæœ¬å›ºå®š |

### D. åç»­æ‰©å±•æ–¹å‘

1. **ååŒç¼–è¾‘**ï¼šå¤šç”¨æˆ·åŒæ—¶ç¼–è¾‘åŒä¸€æ–‡æ¡£
2. **ç‰ˆæœ¬å†å²**ï¼šæ–‡æ¡£ç‰ˆæœ¬ç®¡ç†ä¸å›æ»š
3. **æ‰¹æ³¨ä¸ä¿®è®¢**ï¼šAI è¾…åŠ©å®¡é˜…å»ºè®®
4. **æ¨¡æ¿ç³»ç»Ÿ**ï¼šé¢„è®¾æ–‡æ¡£æ¨¡æ¿å¿«é€Ÿåˆ›å»º
5. **æ‰¹é‡å¤„ç†**ï¼šå¤šæ–‡ä»¶ AI æ‰¹é‡ç¿»è¯‘/è½¬æ¢
