# 数据模型设计

## 平台账号 (SocialAccount)

```typescript
interface SocialAccount {
  id: string;                    // 唯一标识，格式: {platform}_{uniqueId}
  platform: SocialPlatform;      // 平台类型
  nickname: string;              // 账号昵称
  avatar?: string;               // 头像 URL
  profileUrl?: string;           // 主页链接
  storageState?: string;         // Playwright storageState 文件路径
  lastLoginAt: number;           // 最后登录时间（Unix 时间戳 ms）
  status: AccountStatus;         // 账号状态
  metadata?: Record<string, any>; // 平台特定数据
}

// 账号状态
type AccountStatus =
  | 'active'    // 活跃，登录态有效
  | 'expired'   // 登录态过期，需重新登录
  | 'banned';   // 账号被封禁

// 支持的平台
type SocialPlatform =
  | 'xiaohongshu'  // 小红书
  | 'douyin'       // 抖音
  | 'wechat_mp'    // 微信公众号
  | 'bilibili'     // B站
  | 'kuaishou'     // 快手
  | 'weibo'        // 微博
  | 'zhihu';       // 知乎

// 平台元数据示例
interface XiaohongshuMetadata {
  userId: string;
  fansCount: number;
  followingCount: number;
  notesCount: number;
  likedCount: number;
}
```

## 发布内容 (PublishContent)

```typescript
interface PublishContent {
  id: string;                    // 唯一标识
  workspaceId: string;           // 所属工作区
  type: ContentType;             // 内容类型
  title?: string;                // 标题（部分平台必填）
  content: string;               // 正文/描述
  media: MediaFile[];            // 媒体文件列表
  tags?: string[];               // 话题标签
  location?: string;             // 定位信息
  coverImage?: string;           // 封面图路径
  scheduledAt?: number;          // 定时发布时间（Unix 时间戳 ms）
  createdAt: number;             // 创建时间
  updatedAt: number;             // 更新时间
}

// 内容类型
type ContentType =
  | 'image_text'  // 图文笔记
  | 'video'       // 短视频
  | 'long_video'  // 长视频（B站）
  | 'article'     // 长文章
  | 'text';       // 纯文字

// 媒体文件
interface MediaFile {
  id: string;
  type: 'image' | 'video';
  path: string;                  // 本地文件路径
  filename: string;              // 原始文件名
  size: number;                  // 文件大小（字节）
  width?: number;                // 宽度（像素）
  height?: number;               // 高度（像素）
  duration?: number;             // 视频时长（秒）
  thumbnail?: string;            // 缩略图路径
}
```

## 发布记录 (PublishRecord)

```typescript
interface PublishRecord {
  id: string;                    // 唯一标识
  contentId: string;             // 关联的内容 ID
  accountId: string;             // 发布账号 ID
  platform: SocialPlatform;      // 平台
  status: PublishStatus;         // 发布状态
  platformPostId?: string;       // 平台返回的内容 ID
  platformUrl?: string;          // 发布后的链接
  publishedAt?: number;          // 实际发布时间
  errorMessage?: string;         // 错误信息（失败时）
  retryCount: number;            // 重试次数
  stats?: PostStats;             // 数据统计
  createdAt: number;             // 记录创建时间
  updatedAt: number;             // 记录更新时间
}

// 发布状态
type PublishStatus =
  | 'pending'      // 待发布（定时任务）
  | 'publishing'   // 发布中
  | 'success'      // 发布成功
  | 'failed'       // 发布失败
  | 'deleted';     // 已删除
```

## 数据统计 (PostStats)

```typescript
interface PostStats {
  views: number;                 // 阅读/播放量
  likes: number;                 // 点赞数
  comments: number;              // 评论数
  shares: number;                // 转发/分享数
  favorites: number;             // 收藏数
  coins?: number;                // 投币数（B站）
  danmaku?: number;              // 弹幕数（B站）
  updatedAt: number;             // 统计更新时间
}

// 账号整体统计
interface AccountStats {
  accountId: string;
  platform: SocialPlatform;
  fansCount: number;             // 粉丝数
  followingCount: number;        // 关注数
  totalPosts: number;            // 作品总数
  totalViews: number;            // 总阅读/播放量
  totalLikes: number;            // 总点赞数
  updatedAt: number;
}
```

## 评论 (Comment)

```typescript
interface Comment {
  id: string;                    // 评论 ID
  postId: string;                // 所属内容 ID
  platform: SocialPlatform;      // 平台
  authorId: string;              // 评论者 ID
  authorName: string;            // 评论者昵称
  authorAvatar?: string;         // 评论者头像
  content: string;               // 评论内容
  likes: number;                 // 点赞数
  replyTo?: string;              // 回复的评论 ID（如果是回复）
  replies?: Comment[];           // 子评论列表
  createdAt: number;             // 评论时间
  isAuthor: boolean;             // 是否是作者本人
}
```

## 定时任务 (ScheduledTask)

```typescript
interface ScheduledTask {
  id: string;                    // 任务 ID
  contentId: string;             // 关联内容 ID
  accountIds: string[];          // 目标账号列表
  scheduledAt: number;           // 计划发布时间
  status: ScheduleStatus;        // 任务状态
  createdAt: number;             // 创建时间
}

type ScheduleStatus =
  | 'pending'    // 等待执行
  | 'executing'  // 执行中
  | 'completed'  // 已完成
  | 'cancelled'  // 已取消
  | 'failed';    // 执行失败
```

## 存储位置

| 数据类型 | 存储位置 | 格式 |
|---------|---------|------|
| 账号数据 | `~/.creator-flow/social-accounts.enc` | 加密 JSON |
| 登录态 | `~/.creator-flow/social-sessions/{accountId}.session.enc` | 加密 storageState |
| 内容/记录 | `~/.creator-flow/workspaces/{wsId}/social-publisher/data.db` | SQLite |
| 媒体文件 | `~/.creator-flow/workspaces/{wsId}/social-publisher/media/` | 原始文件 |

## 数据库 Schema (SQLite)

```sql
-- 发布内容表
CREATE TABLE publish_contents (
  id TEXT PRIMARY KEY,
  workspace_id TEXT NOT NULL,
  type TEXT NOT NULL,
  title TEXT,
  content TEXT NOT NULL,
  media TEXT NOT NULL,           -- JSON 数组
  tags TEXT,                     -- JSON 数组
  location TEXT,
  cover_image TEXT,
  scheduled_at INTEGER,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- 发布记录表
CREATE TABLE publish_records (
  id TEXT PRIMARY KEY,
  content_id TEXT NOT NULL,
  account_id TEXT NOT NULL,
  platform TEXT NOT NULL,
  status TEXT NOT NULL,
  platform_post_id TEXT,
  platform_url TEXT,
  published_at INTEGER,
  error_message TEXT,
  retry_count INTEGER DEFAULT 0,
  stats TEXT,                    -- JSON 对象
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  FOREIGN KEY (content_id) REFERENCES publish_contents(id)
);

-- 定时任务表
CREATE TABLE scheduled_tasks (
  id TEXT PRIMARY KEY,
  content_id TEXT NOT NULL,
  account_ids TEXT NOT NULL,     -- JSON 数组
  scheduled_at INTEGER NOT NULL,
  status TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  FOREIGN KEY (content_id) REFERENCES publish_contents(id)
);

-- 索引
CREATE INDEX idx_records_content ON publish_records(content_id);
CREATE INDEX idx_records_account ON publish_records(account_id);
CREATE INDEX idx_records_status ON publish_records(status);
CREATE INDEX idx_tasks_status ON scheduled_tasks(status);
CREATE INDEX idx_tasks_scheduled ON scheduled_tasks(scheduled_at);
```
