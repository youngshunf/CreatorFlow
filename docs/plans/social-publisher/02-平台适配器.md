# 平台适配器设计

## 统一接口定义

```typescript
// 平台适配器接口
interface PlatformAdapter {
  readonly platform: SocialPlatform;
  readonly name: string;              // 显示名称（中文）
  readonly supportedTypes: ContentType[];
  readonly hasOfficialApi: boolean;   // 是否有官方 API
  readonly loginUrl: string;          // 登录页面 URL
  readonly creatorUrl: string;        // 创作者中心 URL

  // ========== 账号管理 ==========

  // 执行登录流程
  login(options: LoginOptions): Promise<LoginResult>;

  // 检查登录状态是否有效
  checkLoginStatus(account: SocialAccount): Promise<boolean>;

  // 刷新账号资料（昵称、头像、粉丝数等）
  refreshProfile(account: SocialAccount): Promise<AccountProfile>;

  // ========== 内容发布 ==========

  // 发布内容
  publish(account: SocialAccount, content: PublishContent): Promise<PublishResult>;

  // 获取发布进度（用于大文件上传）
  getPublishProgress?(taskId: string): Promise<PublishProgress>;

  // ========== 内容管理 ==========

  // 获取已发布内容列表
  getPostList(account: SocialAccount, options?: ListOptions): Promise<Post[]>;

  // 获取内容详情
  getPostDetail(account: SocialAccount, postId: string): Promise<PostDetail>;

  // 更新内容（部分平台支持）
  updatePost?(account: SocialAccount, postId: string, updates: PostUpdates): Promise<void>;

  // 删除内容
  deletePost(account: SocialAccount, postId: string): Promise<void>;

  // ========== 数据统计 ==========

  // 同步单个内容的数据统计
  syncStats(account: SocialAccount, postId: string): Promise<PostStats>;

  // 获取账号整体统计
  getAccountStats?(account: SocialAccount): Promise<AccountStats>;

  // ========== 评论管理 ==========

  // 获取评论列表
  getComments(account: SocialAccount, postId: string, options?: CommentOptions): Promise<Comment[]>;

  // 回复评论
  replyComment(account: SocialAccount, commentId: string, text: string): Promise<ReplyResult>;

  // 删除评论
  deleteComment(account: SocialAccount, commentId: string): Promise<void>;
}

// 登录选项
interface LoginOptions {
  headless?: boolean;              // 是否无头模式（首次登录需 false）
  timeout?: number;                // 超时时间（毫秒）
  onQrCode?: (qrUrl: string) => void;      // 二维码回调
  onSmsCode?: () => Promise<string>;       // 短信验证码回调
  onCaptcha?: (imgUrl: string) => Promise<string>;  // 图形验证码回调
  onProgress?: (message: string) => void;  // 进度回调
}

// 登录结果
interface LoginResult {
  success: boolean;
  account?: SocialAccount;
  error?: string;
  needRetry?: boolean;             // 是否需要重试（如验证码错误）
}

// 发布结果
interface PublishResult {
  success: boolean;
  postId?: string;                 // 平台返回的内容 ID
  postUrl?: string;                // 发布后的链接
  error?: string;
  needReview?: boolean;            // 是否需要审核
}
```

## 基础适配器实现

```typescript
abstract class BasePlatformAdapter implements PlatformAdapter {
  protected browserManager: BrowserManager;
  protected sessionManager: SocialSessionManager;

  abstract readonly platform: SocialPlatform;
  abstract readonly name: string;
  abstract readonly supportedTypes: ContentType[];
  abstract readonly hasOfficialApi: boolean;
  abstract readonly loginUrl: string;
  abstract readonly creatorUrl: string;

  constructor(browserManager: BrowserManager, sessionManager: SocialSessionManager) {
    this.browserManager = browserManager;
    this.sessionManager = sessionManager;
  }

  // ========== 通用方法 ==========

  // 创建带登录态的页面
  protected async createAuthenticatedPage(account: SocialAccount): Promise<Page> {
    const context = await this.sessionManager.createContext(account);
    const page = await context.newPage();

    // 设置通用拦截器（屏蔽广告、追踪脚本等）
    await this.setupInterceptors(page);

    return page;
  }

  // 等待登录完成
  protected async waitForLogin(
    page: Page,
    selectors: LoginSelectors,
    options: LoginOptions
  ): Promise<LoginResult> {
    const { successSelector, failSelector, timeout = 120000 } = selectors;

    try {
      const result = await Promise.race([
        page.waitForSelector(successSelector, { timeout }),
        page.waitForSelector(failSelector, { timeout }).then(() => {
          throw new Error('登录失败');
        })
      ]);

      // 提取用户信息
      const profile = await this.extractProfile(page);

      return { success: true, account: profile };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  // 模拟人类操作延迟
  protected async humanDelay(min = 500, max = 1500): Promise<void> {
    const delay = Math.random() * (max - min) + min;
    await new Promise(resolve => setTimeout(resolve, delay));
  }

  // 模拟人类输入
  protected async humanType(page: Page, selector: string, text: string): Promise<void> {
    await page.click(selector);
    await this.humanDelay(100, 300);

    for (const char of text) {
      await page.type(selector, char, { delay: Math.random() * 100 + 50 });
    }
  }

  // 上传媒体文件
  protected async uploadMedia(
    page: Page,
    inputSelector: string,
    files: MediaFile[],
    onProgress?: (percent: number) => void
  ): Promise<void> {
    const fileInput = await page.$(inputSelector);
    if (!fileInput) throw new Error('找不到文件上传入口');

    const filePaths = files.map(f => f.path);
    await fileInput.setInputFiles(filePaths);

    // 等待上传完成
    // 具体实现由子类覆盖
  }

  // 设置页面拦截器
  protected async setupInterceptors(page: Page): Promise<void> {
    await page.route('**/*', (route) => {
      const url = route.request().url();

      // 屏蔽追踪和广告
      if (this.shouldBlock(url)) {
        route.abort();
      } else {
        route.continue();
      }
    });
  }

  private shouldBlock(url: string): boolean {
    const blockPatterns = [
      /google-analytics/,
      /facebook.*pixel/,
      /doubleclick/,
      /adservice/
    ];
    return blockPatterns.some(p => p.test(url));
  }

  // 提取用户资料（子类实现）
  protected abstract extractProfile(page: Page): Promise<AccountProfile>;
}
```

## 各平台特殊处理

### 小红书 (Xiaohongshu)

```typescript
class XiaohongshuAdapter extends BasePlatformAdapter {
  readonly platform = 'xiaohongshu';
  readonly name = '小红书';
  readonly supportedTypes: ContentType[] = ['image_text', 'video'];
  readonly hasOfficialApi = false;
  readonly loginUrl = 'https://creator.xiaohongshu.com/login';
  readonly creatorUrl = 'https://creator.xiaohongshu.com';

  // 特殊处理
  // 1. 图片需要压缩到 20MB 以内
  // 2. 有水印检测，需要去除其他平台水印
  // 3. 支持扫码登录和手机号登录
  // 4. 笔记发布后有审核期

  async publish(account: SocialAccount, content: PublishContent): Promise<PublishResult> {
    const page = await this.createAuthenticatedPage(account);

    try {
      await page.goto(`${this.creatorUrl}/publish/publish`);
      await this.humanDelay();

      // 选择内容类型
      if (content.type === 'video') {
        await page.click('[data-type="video"]');
      }

      // 上传媒体
      await this.uploadMedia(page, 'input[type="file"]', content.media);

      // 等待上传完成
      await page.waitForSelector('.upload-success', { timeout: 300000 });

      // 填写标题和正文
      await this.humanType(page, '.title-input', content.title || '');
      await this.humanType(page, '.content-input', content.content);

      // 添加话题标签
      for (const tag of content.tags || []) {
        await page.click('.add-topic');
        await this.humanType(page, '.topic-search', tag);
        await page.click('.topic-item:first-child');
      }

      // 发布
      await page.click('.publish-btn');

      // 等待发布结果
      const result = await page.waitForSelector('.publish-result');
      const postUrl = await result.getAttribute('data-url');

      return { success: true, postUrl };
    } finally {
      await page.close();
    }
  }
}
```

### 抖音 (Douyin)

```typescript
class DouyinAdapter extends BasePlatformAdapter {
  readonly platform = 'douyin';
  readonly name = '抖音';
  readonly supportedTypes: ContentType[] = ['video'];
  readonly hasOfficialApi = false;
  readonly loginUrl = 'https://creator.douyin.com/';
  readonly creatorUrl = 'https://creator.douyin.com';

  // 特殊处理
  // 1. 仅支持视频内容
  // 2. 视频需要转码为 MP4 H.264
  // 3. 封面可自动截取或手动上传
  // 4. 支持抖音特有的挑战赛、合拍等功能
}
```

### 微信公众号 (WeChat MP)

```typescript
class WechatMpAdapter extends BasePlatformAdapter {
  readonly platform = 'wechat_mp';
  readonly name = '微信公众号';
  readonly supportedTypes: ContentType[] = ['article', 'image_text', 'video'];
  readonly hasOfficialApi = true;  // 有官方 API
  readonly loginUrl = 'https://mp.weixin.qq.com/';
  readonly creatorUrl = 'https://mp.weixin.qq.com';

  // 特殊处理
  // 1. 优先使用官方 API（需要认证服务号）
  // 2. 文章支持富文本编辑
  // 3. 图片需要先上传到素材库
  // 4. 有每日发布次数限制

  // 使用官方 API 发布（如果可用）
  async publishViaApi(account: SocialAccount, content: PublishContent): Promise<PublishResult> {
    // 实现官方 API 调用
    // ...
  }
}
```

### B站 (Bilibili)

```typescript
class BilibiliAdapter extends BasePlatformAdapter {
  readonly platform = 'bilibili';
  readonly name = 'B站';
  readonly supportedTypes: ContentType[] = ['video', 'long_video', 'article', 'image_text'];
  readonly hasOfficialApi = false;
  readonly loginUrl = 'https://passport.bilibili.com/login';
  readonly creatorUrl = 'https://member.bilibili.com/platform/home';

  // 特殊处理
  // 1. 支持分P上传（多个视频合并为一个稿件）
  // 2. 视频需要选择分区
  // 3. 有投稿审核机制
  // 4. 支持专栏文章
}
```

### 快手 (Kuaishou)

```typescript
class KuaishouAdapter extends BasePlatformAdapter {
  readonly platform = 'kuaishou';
  readonly name = '快手';
  readonly supportedTypes: ContentType[] = ['video'];
  readonly hasOfficialApi = false;
  readonly loginUrl = 'https://cp.kuaishou.com/';
  readonly creatorUrl = 'https://cp.kuaishou.com';

  // 特殊处理
  // 1. 视频时长限制（普通用户 60s，认证用户更长）
  // 2. 支持快手特有的魔法表情等功能
}
```

### 微博 (Weibo)

```typescript
class WeiboAdapter extends BasePlatformAdapter {
  readonly platform = 'weibo';
  readonly name = '微博';
  readonly supportedTypes: ContentType[] = ['text', 'image_text', 'video'];
  readonly hasOfficialApi = true;  // 有官方 API（需申请）
  readonly loginUrl = 'https://weibo.com/login.php';
  readonly creatorUrl = 'https://weibo.com';

  // 特殊处理
  // 1. 图片最多 9 张
  // 2. 文字有字数限制
  // 3. 支持超话、话题等功能
}
```

### 知乎 (Zhihu)

```typescript
class ZhihuAdapter extends BasePlatformAdapter {
  readonly platform = 'zhihu';
  readonly name = '知乎';
  readonly supportedTypes: ContentType[] = ['article', 'text', 'video'];
  readonly hasOfficialApi = false;
  readonly loginUrl = 'https://www.zhihu.com/signin';
  readonly creatorUrl = 'https://www.zhihu.com/creator';

  // 特殊处理
  // 1. 文章和想法是不同的发布入口
  // 2. 支持回答问题（需要先搜索问题）
  // 3. 视频需要单独的视频创作入口
}
```

## 平台能力对比

| 平台 | 图文 | 短视频 | 长视频 | 文章 | 纯文字 | 官方API | 编辑 | 定时 |
|------|:----:|:------:|:------:|:----:|:------:|:-------:|:----:|:----:|
| 小红书 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ |
| 抖音 | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ |
| 微信公众号 | ✅ | ✅ | ❌ | ✅ | ✅ | ✅ | ✅ | ✅ |
| B站 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | ✅ | ✅ |
| 快手 | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ |
| 微博 | ✅ | ✅ | ❌ | ❌ | ✅ | ✅ | ✅ | ✅ |
| 知乎 | ❌ | ✅ | ❌ | ✅ | ✅ | ❌ | ✅ | ❌ |
