# 应用数据格式规范

> 版本：v1.0
> 日期：2026-01-27

## 概述

本文档定义了 CreatorFlow 应用（App）的数据格式规范，用于指导后续开发。

**核心理念**：应用是工作区的扩展，其本质是帮助用户快速初始化一个可直接使用的工作区。应用通过声明式配置定义工作区的初始状态，包括目录结构、默认设置、预置数据和依赖的技能。

## 1. 应用与工作区的关系

```text
┌─────────────────────────────────────────────────────────────┐
│                        应用 (App)                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ manifest.json - 应用配置清单                         │   │
│  │ ├── 基础信息 (id, name, version, author...)         │   │
│  │ ├── 工作区模板 (workspace)                          │   │
│  │ │   ├── 目录结构模板                                │   │
│  │ │   ├── 默认设置                                    │   │
│  │ │   └── 预置数据 (labels, statuses)                 │   │
│  │ └── 技能依赖 (skillDependencies)                    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓ 安装应用创建工作区
┌─────────────────────────────────────────────────────────────┐
│                      工作区 (Workspace)                      │
│  ~/.creator-flow/workspaces/{workspace_id}/                 │
│  ├── .creator-flow/                                         │
│  │   ├── config.json      ← 包含 appId 字段关联应用         │
│  │   ├── sources/                                           │
│  │   ├── sessions/                                          │
│  │   ├── skills/          ← 从应用依赖安装的技能            │
│  │   ├── statuses/        ← 从应用预置数据初始化            │
│  │   └── labels/          ← 从应用预置数据初始化            │
│  └── {用户目录结构}        ← 从应用模板创建                  │
└─────────────────────────────────────────────────────────────┘
```

## 2. 应用 Manifest 格式 (manifest.json)

### 2.1 完整结构

```json
{
  "$schema": "https://creatorflow.ai/schemas/app-manifest-v1.json",
  
  "id": "app.creator-media",
  "name": "自媒体创作",
  "version": "1.0.0",
  "description": "完整的自媒体创作工作流，支持小红书、抖音、公众号",
  
  "author": {
    "name": "CreatorFlow Team",
    "email": "team@creatorflow.ai",
    "url": "https://creatorflow.ai"
  },
  
  "license": "MIT",
  "homepage": "https://creatorflow.ai/apps/creator-media",
  "repository": "https://github.com/creatorflow/creator-media-app",
  
  "icon": "assets/icon.svg",
  
  "pricing": {
    "type": "free"
  },

  "skillDependencies": [
    "material-organize@^1.0.0",
    "script-create@^1.0.0",
    "topic-research@^1.0.0"
  ],

  "workspace": {
    "directoryStructure": {
      "素材库": {
        "图片": {},
        "视频": {},
        "文本": {}
      },
      "脚本库": {
        "草稿": {},
        "已发布": {}
      }
    },
    "defaults": {
      "model": "claude-sonnet-4-20250514",
      "permissionMode": "ask",
      "thinkingLevel": "think"
    },
    "presetData": {
      "labels": [
        { "id": "待创作", "name": "待创作", "color": "#3b82f6" },
        { "id": "创作中", "name": "创作中", "color": "#f59e0b" },
        { "id": "已发布", "name": "已发布", "color": "#10b981" }
      ],
      "statuses": [
        { "id": "todo", "name": "待办", "icon": "circle" },
        { "id": "in-progress", "name": "进行中", "icon": "clock" },
        { "id": "done", "name": "完成", "icon": "check" }
      ]
    }
  },

  "marketplace": {
    "category": "content-creation",
    "tags": ["自媒体", "创作", "AI", "小红书", "抖音"],
    "screenshots": [
      "assets/screenshots/dashboard.png",
      "assets/screenshots/editor.png"
    ]
  },

  "compatibility": {
    "platform": ">=1.0.0"
  }
}
```

### 2.2 字段说明

#### 基础信息（必填）

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | string | 应用唯一标识，格式：`app.{name}`，如 `app.creator-media` |
| `name` | string | 应用显示名称 |
| `version` | string | 语义化版本号，如 `1.0.0` |
| `description` | string | 应用描述（一句话） |

#### 作者信息（必填）

| 字段 | 类型 | 说明 |
|------|------|------|
| `author.name` | string | 作者/团队名称 |
| `author.email` | string | 联系邮箱 |
| `author.url` | string | 作者主页（可选） |

#### 资源信息（可选）

| 字段 | 类型 | 说明 |
|------|------|------|
| `license` | string | 开源协议，如 `MIT` |
| `homepage` | string | 应用主页 URL |
| `repository` | string | 代码仓库 URL |
| `icon` | string | 应用图标路径（相对于包根目录） |

#### 定价信息（必填）

```typescript
interface Pricing {
  type: 'free' | 'paid' | 'subscription';
  price?: number;           // type=paid 时的一次性价格
  subscription?: {          // type=subscription 时的订阅价格
    monthly: number;
    yearly: number;
  };
}
```

#### 技能依赖（必填）

```typescript
// 格式: "{skill_id}@{version_range}"
skillDependencies: string[];

// 示例
"skillDependencies": [
  "material-organize@^1.0.0",    // 兼容 1.x.x
  "script-create@^2.0.0",        // 兼容 2.x.x
  "topic-research@>=1.0.0"       // 1.0.0 及以上
]
```

安装应用时，客户端会：
1. 解析 `skillDependencies` 列表
2. 检查本地已安装的技能
3. 从市场下载缺失的技能包
4. 安装到工作区的 `skills/` 目录

#### 工作区模板（必填）

```typescript
interface WorkspaceTemplate {
  // 目录结构模板（创建工作区时自动生成）
  directoryStructure?: Record<string, DirectoryStructure>;
  
  // 工作区默认设置（覆盖全局默认值）
  defaults?: {
    model?: string;                    // 默认 AI 模型
    permissionMode?: 'safe' | 'ask' | 'allow-all';
    thinkingLevel?: 'off' | 'think' | 'max';
    enabledSourceSlugs?: string[];     // 默认启用的数据源
  };
  
  // 预置数据（创建工作区时自动初始化）
  presetData?: {
    labels?: LabelPreset[];
    statuses?: StatusPreset[];
  };
}

interface LabelPreset {
  id: string;
  name: string;
  color: string;      // HEX 颜色值
  group?: string;     // 分组名称
}

interface StatusPreset {
  id: string;
  name: string;
  icon?: string;      // 图标名称或 SVG 路径
  color?: string;
}
```

#### 市场信息（发布时必填）

```typescript
interface MarketplaceInfo {
  category: string;           // 分类 ID
  tags: string[];             // 标签列表
  screenshots?: string[];     // 截图路径列表
  video?: string;             // 演示视频路径
  changelog?: string;         // 更新日志（Markdown）
}
```

#### 兼容性（可选）

```typescript
interface Compatibility {
  platform?: string;          // CreatorFlow 平台版本要求
  os?: ('macos' | 'windows' | 'linux')[];  // 支持的操作系统
}
```

## 3. 应用包结构

### 3.1 开发时目录结构

```text
creator-media-app/
├── manifest.json              # 应用清单（必须）
├── assets/                    # 应用资源
│   ├── icon.svg              # 应用图标（必须）
│   └── screenshots/          # 截图（发布时需要）
│       ├── dashboard.png
│       └── editor.png
├── docs/                      # 应用文档（可选）
│   ├── README.md             # 应用介绍
│   └── GUIDE.md              # 使用指南
└── CHANGELOG.md              # 版本历史（可选）
```

### 3.2 发布包结构 (.cfapp)

```text
creator-media-1.0.0.cfapp (ZIP 格式)
├── manifest.json
├── assets/
│   ├── icon.svg
│   └── screenshots/
├── docs/
└── CHANGELOG.md
```

**注意**：应用包不包含技能文件。技能通过 `skillDependencies` 声明，安装时从技能市场独立下载。

## 4. 工作区配置扩展

### 4.1 现有 WorkspaceConfig 扩展

基于现有的 `WorkspaceConfig` 类型，添加应用相关字段：

```typescript
// packages/shared/src/workspaces/types.ts

export interface WorkspaceConfig {
  id: string;
  name: string;
  slug: string;

  defaults?: {
    model?: string;
    enabledSourceSlugs?: string[];
    permissionMode?: PermissionMode;
    cyclablePermissionModes?: PermissionMode[];
    workingDirectory?: string;
    thinkingLevel?: ThinkingLevel;
  };

  localMcpServers?: LocalMcpConfig;

  // ========== 应用框架扩展字段 ==========
  
  /**
   * 绑定的主应用 ID
   * 创建工作区时从应用初始化，记录来源应用
   * 示例: 'app.creator-media'
   */
  appId?: string;

  /**
   * 应用版本（创建时的版本）
   * 用于后续升级迁移判断
   */
  appVersion?: string;

  /**
   * 已安装的插件应用 ID 列表
   * 插件应用扩展主应用的能力
   */
  installedPluginApps?: string[];

  /**
   * 应用特定设置
   * 每个应用可以存储自己的配置
   * Key 为应用 ID，Value 为应用自定义的配置对象
   */
  appSettings?: Record<string, unknown>;

  // ========================================

  createdAt: number;
  updatedAt: number;
}
```

### 4.2 创建工作区时的应用绑定

```typescript
// 创建工作区时，如果指定了应用，则：
// 1. 设置 appId 和 appVersion
// 2. 应用 workspace.defaults 覆盖默认设置
// 3. 创建 workspace.directoryStructure 定义的目录
// 4. 初始化 workspace.presetData 中的 labels 和 statuses
// 5. 下载并安装 skillDependencies 中的技能

interface CreateWorkspaceFromAppInput {
  name: string;
  appId: string;
  directory?: string;  // 可选，默认使用 ~/.creator-flow/workspaces/{slug}
  customDefaults?: Partial<WorkspaceConfig['defaults']>;  // 用户自定义覆盖
}
```

## 5. 本地存储结构

### 5.1 应用缓存目录

```text
~/.creator-flow/
├── marketplace/
│   ├── cache/
│   │   └── meta.json           # 市场元数据缓存
│   └── apps/
│       └── {app_id}/
│           └── {version}/
│               ├── manifest.json
│               └── assets/
│                   └── icon.svg
```

### 5.2 工作区目录（应用初始化后）

```text
~/.creator-flow/workspaces/{workspace_slug}/
├── .creator-flow/
│   ├── config.json             # 包含 appId, appVersion 字段
│   ├── sources/
│   ├── sessions/
│   ├── skills/                 # 从应用依赖安装的技能
│   │   ├── material-organize/
│   │   │   └── SKILL.md
│   │   └── script-create/
│   │       └── SKILL.md
│   ├── statuses/               # 从应用预置数据初始化
│   │   ├── config.json
│   │   └── icons/
│   └── labels/                 # 从应用预置数据初始化
│       └── config.json
├── 素材库/                      # 从应用目录模板创建
│   ├── 图片/
│   ├── 视频/
│   └── 文本/
└── 脚本库/
    ├── 草稿/
    └── 已发布/
```

## 6. 数据库模型（云端）

### 6.1 应用表

```sql
CREATE TABLE marketplace_apps (
    id VARCHAR(100) PRIMARY KEY,           -- app.creator-media
    name VARCHAR(200) NOT NULL,
    description TEXT,
    icon_url VARCHAR(500),
    author_id INTEGER,
    author_name VARCHAR(100),
    
    -- 定价
    pricing_type VARCHAR(20) DEFAULT 'free',
    price DECIMAL(10,2) DEFAULT 0,
    
    -- 权限
    is_private BOOLEAN DEFAULT FALSE,
    is_official BOOLEAN DEFAULT FALSE,
    
    -- 统计
    download_count INTEGER DEFAULT 0,
    
    -- 技能依赖（JSON 数组）
    -- ["material-organize@^1.0.0", "script-create@^2.0.0"]
    skill_dependencies JSONB,
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 6.2 应用版本表

```sql
CREATE TABLE marketplace_app_versions (
    id SERIAL PRIMARY KEY,
    app_id VARCHAR(100) NOT NULL,
    version VARCHAR(50) NOT NULL,
    changelog TEXT,
    
    -- 该版本的技能依赖（带版本号）
    skill_dependencies_versioned JSONB,
    
    -- 对象存储
    package_url VARCHAR(500),
    file_hash VARCHAR(64),
    file_size INTEGER,
    
    -- 状态
    is_latest BOOLEAN DEFAULT FALSE,
    
    published_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(app_id, version)
);
```

## 7. API 接口

### 7.1 应用市场 API

```text
# 浏览
GET  /api/v1/marketplace/apps                    # 应用列表
GET  /api/v1/marketplace/apps/{id}               # 应用详情
GET  /api/v1/marketplace/apps/{id}/versions      # 版本列表

# 下载
GET  /api/v1/marketplace/download/app/{id}/{version}

# 发布（需认证）
POST /api/v1/marketplace/apps                    # 发布新应用
PUT  /api/v1/marketplace/apps/{id}/versions      # 发布新版本
```

### 7.2 应用详情响应

```json
{
  "id": "app.creator-media",
  "name": "自媒体创作",
  "version": "1.0.0",
  "description": "完整的自媒体创作工作流",
  "author": {
    "name": "CreatorFlow Team",
    "verified": true
  },
  "iconUrl": "https://cdn.creatorflow.ai/apps/creator-media/icon.svg",
  "pricing": {
    "type": "free"
  },
  "skillDependencies": [
    { "id": "material-organize", "version": "^1.0.0", "name": "素材整理" },
    { "id": "script-create", "version": "^2.0.0", "name": "脚本创作" }
  ],
  "stats": {
    "downloads": 1234,
    "rating": 4.8
  },
  "marketplace": {
    "category": "content-creation",
    "tags": ["自媒体", "创作"]
  }
}
```

## 8. 安装流程

```text
用户选择安装应用
        │
        ▼
┌───────────────────┐
│ 1. 下载应用包      │
│    manifest.json  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 2. 解析技能依赖    │
│ skillDependencies │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 3. 下载缺失技能    │
│    从技能市场      │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 4. 创建工作区      │
│ - 目录结构         │
│ - 默认设置         │
│ - 预置数据         │
│ - 安装技能         │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 5. 写入 config.json│
│ - appId           │
│ - appVersion      │
└─────────┬─────────┘
          │
          ▼
    ┌─────────┐
    │ 完成安装 │
    └─────────┘
```

## 9. 版本兼容性

### 9.1 应用升级

当应用发布新版本时，已创建的工作区不会自动升级。用户可以：

1. **查看更新**：在工作区设置中查看应用是否有新版本
2. **手动升级**：选择升级后，系统会：
   - 下载新版本的技能依赖
   - 保留用户数据和自定义设置
   - 更新 `appVersion` 字段

### 9.2 技能版本解析

```typescript
// 版本范围语法（遵循 semver）
"^1.0.0"   // 兼容 1.x.x (>=1.0.0 <2.0.0)
"~1.0.0"   // 兼容 1.0.x (>=1.0.0 <1.1.0)
">=1.0.0"  // 1.0.0 及以上
"1.0.0"    // 精确版本
```

## 10. 示例：自媒体创作应用

### manifest.json

```json
{
  "$schema": "https://creatorflow.ai/schemas/app-manifest-v1.json",
  "id": "app.creator-media",
  "name": "自媒体创作",
  "version": "1.0.0",
  "description": "完整的自媒体创作工作流，从选题到发布一站式解决",
  
  "author": {
    "name": "CreatorFlow Team",
    "email": "team@creatorflow.ai"
  },
  
  "license": "MIT",
  "icon": "assets/icon.svg",
  
  "pricing": {
    "type": "free"
  },

  "skillDependencies": [
    "material-organize@^1.0.0",
    "script-create@^1.0.0",
    "topic-research@^1.0.0",
    "content-review@^1.0.0",
    "topic-to-publish-flow@^1.0.0"
  ],

  "workspace": {
    "directoryStructure": {
      "素材库": {
        "图片": {},
        "视频": {},
        "文本": {},
        "音频": {}
      },
      "脚本库": {
        "草稿": {},
        "待审核": {},
        "已发布": {}
      },
      "发布记录": {
        "小红书": {},
        "抖音": {},
        "公众号": {}
      }
    },
    "defaults": {
      "model": "claude-sonnet-4-20250514",
      "permissionMode": "ask",
      "thinkingLevel": "think"
    },
    "presetData": {
      "labels": [
        { "id": "topic", "name": "选题", "color": "#6366f1", "group": "阶段" },
        { "id": "draft", "name": "草稿", "color": "#f59e0b", "group": "阶段" },
        { "id": "review", "name": "待审核", "color": "#8b5cf6", "group": "阶段" },
        { "id": "published", "name": "已发布", "color": "#10b981", "group": "阶段" },
        { "id": "xiaohongshu", "name": "小红书", "color": "#ef4444", "group": "平台" },
        { "id": "douyin", "name": "抖音", "color": "#000000", "group": "平台" },
        { "id": "wechat", "name": "公众号", "color": "#22c55e", "group": "平台" }
      ],
      "statuses": [
        { "id": "todo", "name": "待办", "icon": "circle" },
        { "id": "in-progress", "name": "进行中", "icon": "clock" },
        { "id": "needs-review", "name": "待审核", "icon": "eye" },
        { "id": "done", "name": "完成", "icon": "check" }
      ]
    }
  },

  "marketplace": {
    "category": "content-creation",
    "tags": ["自媒体", "创作", "AI", "小红书", "抖音", "公众号", "内容创作"],
    "screenshots": [
      "assets/screenshots/workspace.png",
      "assets/screenshots/editor.png",
      "assets/screenshots/publish.png"
    ]
  },

  "compatibility": {
    "platform": ">=1.0.0"
  }
}
```

### 安装后的工作区 config.json

```json
{
  "id": "ws_a1b2c3d4",
  "name": "我的自媒体工作区",
  "slug": "my-media-workspace",
  "appId": "app.creator-media",
  "appVersion": "1.0.0",
  "defaults": {
    "model": "claude-sonnet-4-20250514",
    "permissionMode": "ask",
    "thinkingLevel": "think",
    "enabledSourceSlugs": [],
    "workingDirectory": "/Users/xxx/.creator-flow/workspaces/my-media-workspace"
  },
  "installedPluginApps": [],
  "appSettings": {},
  "createdAt": 1706345678000,
  "updatedAt": 1706345678000
}
```
