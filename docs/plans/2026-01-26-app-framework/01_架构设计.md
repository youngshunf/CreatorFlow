# 架构设计

> 版本：v1.0
> 日期：2026-01-26

## 核心理念

Sprouty AI 应用框架采用**三层架构 + 能力组合**的设计理念，旨在：

1. **降低使用门槛**：普通用户无需理解底层技术概念
2. **提高能力复用**：底层能力可以被多个应用复用
3. **支持灵活扩展**：专业用户可以自由组合能力
4. **简化开发流程**：开发者遵循约定式框架快速开发

## 三层架构

### Layer 1: 平台层（Platform Layer）

**职责**：提供可复用的底层能力

**组成**：
- **UI 组件库**：可复用的界面组件（如内容日历、作品编辑器、数据看板）
- **数据模型库**：可复用的业务对象（如作品、素材、平台账号）
- **集成能力库**：可复用的第三方平台连接（如小红书、抖音、公众号）

**特点**：
- 采用插件式定义，统一的插件接口
- 支持生命周期管理（onInstall、onLoad、onUnload 等）
- 支持 UI 扩展和配置界面
- 可以被多个应用引用和复用

**存储位置**：
```
.creator-flow/
├── platform/
│   ├── ui/              # UI 组件插件
│   ├── models/          # 数据模型插件
│   └── integrations/    # 集成插件
```

### Layer 2: 能力层（Capability Layer）

**职责**：提供独立的 AI 技能

**组成**：
- **Skills**：独立的 AI 技能，使用 Claude Agent Skill 格式（`SKILL.md`）
  - 单一领域技能：如素材整理、脚本创作、选题研究
  - 多步骤流程技能：如选题到发布流程（通过 prompt 编排实现）

**特点**：
- 完全兼容 Claude Agent Skill 格式
- 可以独立发布到技能市场
- 支持运行时动态安装和卸载
- 支持热更新
- 可以被多个应用绑定

**存储位置**：
```
~/.creator-flow/
├── workspaces/{id}/
│   ├── skills/              # 工作区级别的 skills
│   │   ├── material-organize/
│   │   │   └── SKILL.md
│   │   ├── script-create/
│   │   │   └── SKILL.md
│   │   └── topic-to-publish-flow/
│   │       └── SKILL.md
```

### Layer 3: 应用层（Application Layer）

**职责**：作为"能力组合器"，提供完整的业务解决方案

**组成**：
- **应用配置**（manifest.json）：声明依赖的底层能力和绑定的技能
- **工作区初始化配置**：目录结构模板、默认设置、预置数据
- **应用资源**：图标、截图、文档等

**特点**：
- 应用不实现能力，只声明依赖和配置
- 通过 manifest 组合平台层和能力层的能力
- 支持主应用 + 插件模式
- 可以发布到应用市场

**存储位置**：
```
.creator-flow/
├── apps/                # 已安装的应用
│   ├── creator-media/
│   │   ├── manifest.json
│   │   └── config/
│   └── project-management/
│       ├── manifest.json
│       └── config/
```

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        应用层 (Layer 3)                      │
│  ┌──────────────────┐  ┌──────────────────┐                │
│  │  自媒体创作应用   │  │  项目管理应用     │  ...           │
│  │  (能力组合器)     │  │  (能力组合器)     │                │
│  └──────────────────└──────────────────└
└───────────────────────────────────────────────────────────────┘
                            ↓ 声明依赖
┌───────────────────────────────────────────────────────────────┐
│                        能力层 (Layer 2)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │
│  │  Skills  │  │  Skills  │  │  Skills  │  ...             │
│  └──────────┘  └──────────┘  └──────────┘                  │
└───────────────────────────────────────────────────────────────┘
                            ↓ 依赖
┌─────────────────────────────────────────────────────────────┐
│                        平台层 (Layer 1)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │
│  │UI 组件库 │  │数据模型库│  │集成能力库│  ...             │
│  └──────────┘  └──────────┘  └──────────┘                  │
└─────────────────────────────────────────────────────────────┘
```

## 工作区模型

### 工作区与应用的关系

```
工作区 (Workspace)
├── 主应用 (Main App)
│   ├── 绑定的 Skills（包括单一技能和流程技能）
│   ├── 依赖的平台能力
│   └── 工作区配置
├── 插件应用 1 (Plugin App)
│   ├── 额外的 Skills
│   └── 额外的 UI 组件
└── 插件应用 2 (Plugin App)
    └── 额外的集成能力
```

### 主应用 + 插件模式

**主应用**：
- 工作区创建时必须选择一个主应用
- 主应用决定工作区的核心能力边界
- 主应用提供基础的 UI 框架和数据模型
- 主应用定义工作区的目录结构和默认配置

**插件应用**：
- 可选，用于扩展主应用的能力
- 可以注入额外的 Skills、UI 组件
- 可以扩展数据模型和集成能力
- 不能修改主应用的核心配置

**示例**：
```
工作区：我的自媒体工作区
├── 主应用：自媒体创作 (creator-media)
│   ├── Skills: 素材整理、脚本创作、选题研究、选题到发布流程
│   ├── UI: 内容日历、作品编辑器
│   └── 集成: 小红书、抖音、公众号
├── 插件：数据分析 (data-analytics)
│   ├── Skills: 数据分析、趋势预测
│   └── UI: 数据看板、报表生成器
└── 插件：SEO 优化 (seo-optimizer)
    ├── Skills: 关键词分析、SEO 建议
    └── UI: SEO 检查器
```

## 能力加载机制

### 加载顺序

1. **平台层加载**：启动时加载所有已安装的平台能力插件
2. **工作区创建**：用户选择主应用创建工作区
3. **依赖解析**：解析主应用的依赖，检查是否已安装
4. **依赖安装**：安装缺失的平台能力和技能
5. **应用加载**：加载主应用的配置和绑定的能力
6. **插件加载**：加载已安装的插件应用
7. **工作区初始化**：创建目录结构，应用默认配置

### 依赖解析

应用的 manifest 声明技能依赖：

```json
{
  "$schema": "https://creatorflow.ai/schemas/app-manifest-v1.json",
  "id": "app.creator-media",
  "name": "自媒体创作",
  "version": "1.0.0",

  "skillDependencies": [
    "material-organize@^1.0.0",
    "script-create@^1.0.0",
    "topic-to-publish-flow@^1.0.0"
  ],

  "compatibility": {
    "platform": ">=1.0.0"
  }
}
```

系统会：
1. 检查每个技能依赖是否已安装
2. 检查版本是否满足要求
3. 如果缺失，从技能市场下载安装
4. 如果版本不兼容，提示用户升级或降级

**注**: Phase 1 仅实现应用层+技能层，暂不实现平台层插件（ui/models/integrations）

### 能力注册

每个插件在加载时注册到全局注册表：

```typescript
// 全局注册表
class PluginRegistry {
  private plugins = new Map<string, Plugin>()

  register(plugin: Plugin) {
    this.plugins.set(plugin.id, plugin)
  }

  get(id: string): Plugin | undefined {
    return this.plugins.get(id)
  }

  getByType(type: 'ui' | 'model' | 'integration'): Plugin[] {
    return Array.from(this.plugins.values())
      .filter(p => p.type === type)
  }
}
```

应用可以通过注册表访问依赖的能力：

```typescript
// 在应用中使用平台能力
const calendar = registry.get('ui.content-calendar')
const postModel = registry.get('model.post')
const xiaohongshu = registry.get('integration.xiaohongshu')
```

## 数据流

### 用户操作流

```
用户操作
  ↓
UI 组件 (平台层)
  ↓
调用 Skill (能力层)
  ↓
使用数据模型 (平台层)
  ↓
调用集成 (平台层)
  ↓
返回结果
  ↓
更新 UI
```

### 示例：发布作品到小红书

```typescript
// 1. 用户在 UI 中点击"发布"
<PublishButton onClick={handlePublish} />

// 2. UI 组件调用 Skill
async function handlePublish() {
  const skill = registry.get('skill.multi-platform-publish')
  await skill.execute({
    post: currentPost,
    platforms: ['xiaohongshu']
  })
}

// 3. Skill 使用数据模型和集成
async function execute(params) {
  // 获取数据模型
  const postModel = registry.get('model.post')
  const post = await postModel.query({ id: params.post.id })

  // 获取集成
  const xiaohongshu = registry.get('integration.xiaohongshu')

  // 发布
  const result = await xiaohongshu.publish({
    title: post.title,
    content: post.content,
    images: post.images
  })

  // 更新数据
  await postModel.update(post.id, {
    publishStatus: 'published',
    publishedAt: new Date(),
    platformData: {
      xiaohongshu: result
    }
  })
}
```

## 目录结构

### 运行时目录结构

```
.creator-flow/
├── platform/                    # 平台层
│   ├── ui/                     # UI 组件插件
│   │   ├── content-calendar/
│   │   │   ├── dist/          # 构建输出
│   │   │   └── manifest.json
│   │   └── post-editor/
│   ├── models/                 # 数据模型插件
│   │   ├── post/
│   │   └── material/
│   └── integrations/           # 集成插件
│       ├── xiaohongshu/
│       └── douyin/
├── skills/                      # 能力层 - Skills
│   ├── material-organize/
│   │   └── skill.yaml
│   └── script-create/
│       └── skill.yaml
├── workflows/                   # 能力层 - Workflows
│   └── topic-to-publish/
│       └── workflow.yaml
├── apps/                        # 应用层
│   ├── creator-media/
│   │   ├── manifest.json
│   │   └── config/
│   └── project-management/
│       ├── manifest.json
│       └── config/
└── workspaces/                  # 工作区数据
    ├── my-media-workspace/
    │   ├── workspace.json      # 工作区配置
    │   ├── sessions/           # 会话数据
    │   └── data/               # 业务数据
    └── my-project-workspace/
```

### 开发时目录结构

```
creator-media-app/               # 应用开发目录
├── manifest.json                # 应用清单
├── skills/                      # 绑定的 skills
│   ├── material-organize/
│   └── script-create/
├── workflows/                   # 绑定的 workflows
│   └── topic-to-publish/
├── assets/                      # 应用资源
│   ├── icon.png
│   └── screenshots/
└── docs/                        # 应用文档
    └── README.md

content-calendar-plugin/         # 平台能力开发目录
├── src/                         # 源码（需要构建）
│   ├── index.ts                # 插件入口
│   ├── ContentCalendar.tsx     # UI 组件
│   └── settings.tsx            # 设置界面
├── package.json
├── tsconfig.json
└── manifest.json
```

## 技术实现

### 插件系统

使用动态导入和依赖注入：

```typescript
// 插件加载器
class PluginLoader {
  async load(pluginPath: string): Promise<Plugin> {
    // 动态导入插件
    const module = await import(pluginPath)
    const plugin = module.default

    // 验证插件接口
    this.validate(plugin)

    // 调用生命周期钩子
    await plugin.onLoad?.(this.context)

    // 注册到全局注册表
    registry.register(plugin)

    return plugin
  }
}
```

### 依赖注入

```typescript
// 插件上下文
interface PluginContext {
  registry: PluginRegistry
  router: Router
  menu: MenuManager
  storage: Storage
  logger: Logger
}

// 插件可以访问上下文
export default defineUIPlugin({
  async onLoad(context: PluginContext) {
    // 访问其他插件
    const postModel = context.registry.get('model.post')

    // 注册路由
    context.router.addRoute({
      path: '/calendar',
      component: ContentCalendar
    })

    // 添加菜单项
    context.menu.addItem({
      label: '内容日历',
      path: '/calendar'
    })
  }
})
```

## 扩展性

### 添加新的平台能力类型

框架支持扩展新的平台能力类型：

```typescript
// 定义新的插件类型
interface AnalyticsPlugin extends Plugin {
  type: 'analytics'
  track(event: string, data: any): void
  getReport(query: ReportQuery): Promise<Report>
}

// 注册新类型
registry.registerType('analytics', AnalyticsPlugin)
```

### 添加新的能力层类型

除了 Skills 和 Workflows，可以添加新的能力类型：

```typescript
// 例如：添加 Templates（模板）
interface Template {
  id: string
  name: string
  type: 'post' | 'script' | 'material'
  content: string
}

// 模板加载器
class TemplateLoader {
  async load(templatePath: string): Promise<Template> {
    // 加载模板
  }
}
```

## 性能优化

### 懒加载

- 平台能力按需加载，不是一次性加载所有插件
- UI 组件使用 React.lazy 和 Suspense
- 数据模型使用虚拟化和分页

### 缓存

- 插件加载结果缓存
- 数据模型查询结果缓存
- 集成 API 响应缓存

### 并行加载

- 依赖解析和安装并行进行
- 多个插件并行加载
- 工作区初始化步骤并行执行

## 安全性

### 权限系统

应用需要声明所需权限：

```json
{
  "permissions": [
    "filesystem",      // 文件系统访问
    "network",         // 网络访问
    "clipboard",       // 剪贴板访问
    "camera",          // 摄像头访问
    "microphone"       // 麦克风访问
  ]
}
```

用户在安装应用时需要授权。

### 沙箱隔离

- 插件运行在沙箱环境中
- 限制插件访问系统资源
- 插件间数据隔离

### 代码签名

- 应用和插件需要代码签名
- 验证发布者身份
- 防止恶意代码注入

## 下一步

阅读 [平台层设计](./02_平台层设计.md) 了解插件系统的详细实现。
