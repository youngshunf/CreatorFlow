# 应用/技能市场架构设计

## 1. 核心概念模型

### 1.1 实体关系

```text
App (应用) - 能力组合器，提供完整业务解决方案
├── id: string (app.creator-media)
├── versions: AppVersion[]
├── skillDependencies: string[] (依赖的技能ID列表，安装时下载)
└── metadata: 名称、描述、作者、图标、定价等

Skill (技能) - 独立的AI能力单元，可单独安装
├── id: string (material-organize)
├── versions: SkillVersion[]
├── categories: Category[]
├── tags: string[]
└── metadata: 名称、描述、作者、图标、定价等

UserSkill (用户本地技能)
├── skillId: string (原始技能ID)
├── baseVersion: string (基于的市场版本)
├── localVersion: string (本地版本号)
├── isModified: boolean
├── isPrivate: boolean (是否私有版本)
└── files: 本地文件
```

**说明**：
- App 和 Skill 在市场中是独立的实体，各自独立发布和下载
- App 的 `skillDependencies` 声明依赖的技能，客户端安装应用时自动下载所需技能包
- Skill 可以被多个 App 依赖，也可以单独安装使用

### 1.2 版本策略

- **市场版本**: 语义化版本 (1.0.0, 1.0.1, 1.1.0)
- **本地版本**: 基于市场版本 + 本地修改标记 (1.0.0-local.1)
- **私有版本**: 用户可发布到市场的个人版本

## 2. 云端架构

### 2.1 数据库模型 (PostgreSQL)

```sql
-- ========================================
-- 应用表: 应用是技能的集合，用于快速创建工作区
-- ========================================
CREATE TABLE marketplace_apps (
    id VARCHAR(100) PRIMARY KEY,           -- 应用唯一标识，如 app.creator-media
    name VARCHAR(200) NOT NULL,            -- 应用名称
    description TEXT,                      -- 应用描述
    icon_url VARCHAR(500),                 -- 应用图标URL
    author_id INTEGER,                     -- 作者用户ID
    author_name VARCHAR(100),              -- 作者名称（冗余，方便展示）
    -- 定价
    pricing_type VARCHAR(20) DEFAULT 'free',  -- free=免费 / paid=付费 / subscription=订阅
    price DECIMAL(10,2) DEFAULT 0,         -- 价格（pricing_type=paid时有效）
    -- 权限
    is_private BOOLEAN DEFAULT FALSE,      -- 是否私有（仅作者可见）
    is_official BOOLEAN DEFAULT FALSE,     -- 是否官方应用
    -- 统计
    download_count INTEGER DEFAULT 0,      -- 下载次数
    -- 依赖的技能ID列表，逗号分隔，如: material-organize,script-create
    skill_dependencies TEXT,
    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ========================================
-- 应用版本表: 记录应用的每个发布版本
-- ========================================
CREATE TABLE marketplace_app_versions (
    id SERIAL PRIMARY KEY,
    app_id VARCHAR(100) NOT NULL,          -- 关联的应用ID
    version VARCHAR(50) NOT NULL,          -- 语义化版本号，如 1.0.0
    changelog TEXT,                        -- 版本更新日志
    -- 依赖的技能及版本，JSON格式: {"material-organize": "^1.0.0", "script-create": "^2.0.0"}
    skill_dependencies_versioned JSONB,
    -- 对象存储
    package_url VARCHAR(500),              -- 完整包下载URL (S3)
    file_hash VARCHAR(64),                 -- SHA256校验值，用于验证下载完整性
    file_size INTEGER,                     -- 包大小（字节）
    -- 状态
    is_latest BOOLEAN DEFAULT FALSE,       -- 是否为最新版本
    -- 时间戳
    published_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(app_id, version)
);

-- ========================================
-- 技能表: 技能是可复用的AI能力单元，可独立安装
-- ========================================
CREATE TABLE marketplace_skills (
    id VARCHAR(100) PRIMARY KEY,           -- 技能唯一标识，如 material-organize
    name VARCHAR(200) NOT NULL,            -- 技能名称
    description TEXT,                      -- 技能描述
    icon_url VARCHAR(500),                 -- SVG图标URL (S3)
    author_id INTEGER,                     -- 作者用户ID
    author_name VARCHAR(100),              -- 作者名称（冗余，方便展示）
    -- 分类与标签
    category VARCHAR(50),                  -- 分类，如: 内容创作、数据分析、效率工具
    tags VARCHAR(500),                     -- 标签，中文逗号分隔，如: 素材,整理,自动化
    -- 定价
    pricing_type VARCHAR(20) DEFAULT 'free',  -- free=免费 / paid=付费
    price DECIMAL(10,2) DEFAULT 0,         -- 价格
    -- 权限
    is_private BOOLEAN DEFAULT FALSE,      -- 是否私有
    is_official BOOLEAN DEFAULT FALSE,     -- 是否官方技能
    -- 统计
    download_count INTEGER DEFAULT 0,      -- 下载次数
    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ========================================
-- 技能版本表: 记录技能的每个发布版本
-- ========================================
CREATE TABLE marketplace_skill_versions (
    id SERIAL PRIMARY KEY,
    skill_id VARCHAR(100) NOT NULL,        -- 关联的技能ID
    version VARCHAR(50) NOT NULL,          -- 语义化版本号
    changelog TEXT,                        -- 版本更新日志
    -- 对象存储 (技能文件夹打包为zip)
    package_url VARCHAR(500),              -- 完整包下载URL (S3)
    file_hash VARCHAR(64),                 -- SHA256校验值
    file_size INTEGER,                     -- 包大小（字节）
    -- 状态
    is_latest BOOLEAN DEFAULT FALSE,       -- 是否为最新版本
    -- 时间戳
    published_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(skill_id, version)
);

-- ========================================
-- 分类表: 技能/应用的分类（支持层级）
-- ========================================
CREATE TABLE marketplace_categories (
    id SERIAL PRIMARY KEY,
    slug VARCHAR(50) UNIQUE NOT NULL,      -- 分类标识，如 content-creation
    name VARCHAR(100) NOT NULL,            -- 分类名称，如 内容创作
    icon VARCHAR(10),                      -- emoji图标
    parent_slug VARCHAR(50),               -- 父分类标识，NULL表示顶级分类
    sort_order INTEGER DEFAULT 0           -- 排序顺序
);

-- ========================================
-- 用户下载记录: 记录用户的下载历史
-- ========================================
CREATE TABLE user_downloads (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,              -- 用户ID
    item_type VARCHAR(20) NOT NULL,        -- app=应用 / skill=技能
    item_id VARCHAR(100) NOT NULL,         -- 应用或技能ID
    version VARCHAR(50) NOT NULL,          -- 下载的版本
    downloaded_at TIMESTAMP DEFAULT NOW()
);
```

### 2.2 对象存储 (S3 兼容)

使用 S3 SDK，支持 AWS S3、阿里云 OSS、腾讯云 COS、MinIO 等兼容存储。

**存储结构:**

```text
fba-marketplace/
├── apps/{app_id}/{version}.zip           # 应用包
├── skills/{skill_id}/{version}.zip       # 技能包
└── users/{user_id}/skills/{skill_id}/{version}.zip  # 用户私有技能
```

**技能包内容 (skill.zip 解压后):**

```text
material-organize/                  # 技能文件夹
├── config.yaml                     # 市场配置元数据 (必须)
├── SKILL.md                        # Agent使用的技能内容 (必须)
├── icon.svg                        # SVG图标 (必须)
├── CHANGELOG.md                    # 版本历史 (可选)
├── scripts/                        # 脚本文件 (可选)
│   ├── analyze.py
│   └── export.sh
├── templates/                      # 模板文件 (可选)
│   └── report.md
└── examples/                       # 使用示例 (可选)
    └── ...
```

**config.yaml 示例（市场配置）:**

```yaml
id: material-organize
name: 素材整理
version: 1.0.0
description: 智能素材管理，自动分类整理媒体文件
category: 内容创作
tags: 素材,整理,自动化,文件管理
pricing: free
author:
  name: fba Team
  email: team@fba.ai
```

**SKILL.md 示例（Agent使用）:**

```markdown
---
id: material-organize
name: 素材整理
version: 1.0.0
author: fba Team
description: 帮助整理和分类创作素材
tags: ["素材管理", "内容创作"]
---

# 素材整理助手

你是一个专业的素材整理助手...
```

### 2.3 API 设计

```text
# 市场浏览
GET  /api/v1/marketplace/apps                    # 应用列表
GET  /api/v1/marketplace/apps/{id}               # 应用详情
GET  /api/v1/marketplace/apps/{id}/versions      # 应用版本列表
GET  /api/v1/marketplace/skills                  # 技能列表
GET  /api/v1/marketplace/skills/{id}             # 技能详情
GET  /api/v1/marketplace/skills/{id}/versions    # 技能版本列表
GET  /api/v1/marketplace/categories              # 分类列表
GET  /api/v1/marketplace/tags                    # 热门标签
GET  /api/v1/marketplace/search                  # 搜索

# 下载
GET  /api/v1/marketplace/download/app/{id}/{version}
GET  /api/v1/marketplace/download/skill/{id}/{version}

# 同步 (客户端启动时调用)
POST /api/v1/marketplace/sync
     Body: { installed: [{id, version, type}...] }
     Returns: { updates: [{id, latestVersion, changelog}...] }

# 发布 (需要认证)
POST /api/v1/marketplace/skills                  # 发布新技能
PUT  /api/v1/marketplace/skills/{id}/versions    # 发布新版本
POST /api/v1/marketplace/apps                    # 发布新应用

# 用户私有
GET  /api/v1/user/skills                         # 我的技能
POST /api/v1/user/skills/{id}/publish            # 发布私有为公开
```

## 3. 客户端架构

### 3.1 本地存储结构

```text
~/.creator-flow/
├── marketplace/
│   ├── cache/
│   │   └── meta.json              # 缓存的市场元数据
│   ├── apps/
│   │   └── {app_id}/
│   │       └── {version}/
│   │           └── manifest.json
│   └── skills/
│       └── {skill_id}/
│           └── {version}/
│               ├── config.yaml
│               └── SKILL.md

├── workspaces/
│   └── {workspace_id}/
│       └── skills/
│           └── {skill_id}/
│               ├── SKILL.md           # 可编辑的本地副本
│               └── .skill-meta.json   # 版本追踪
│                   {
│                     "sourceId": "material-organize",
│                     "baseVersion": "1.0.0",
│                     "localVersion": "1.0.0-local.2",
│                     "isModified": true,
│                     "lastSynced": "2024-01-26T12:00:00Z"
│                   }
```

### 3.2 应用安装流程

```text
用户选择安装应用
        │
        ▼
┌───────────────────┐
│ 下载应用 manifest │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 解析 skill 依赖   │
│ skillDependencies │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 检查本地已安装技能 │
└─────────┬─────────┘
          │
    ┌─────┴─────┐
    ▼           ▼
 [有缺失]    [全部已有]
    │           │
    ▼           ▼
┌─────────┐  ┌─────────┐
│下载缺失  │  │ 完成安装 │
│技能包    │  └─────────┘
└────┬────┘
     │
     ▼
┌─────────────────┐
│ 安装技能到本地   │
└─────────┬───────┘
          │
          ▼
    ┌─────────┐
    │ 完成安装 │
    └─────────┘
```

### 3.3 版本对比与合并流程

```text
用户打开技能市场
        │
        ▼
┌───────────────────┐
│ 获取已安装技能列表  │
│ 对比市场最新版本   │
└─────────┬─────────┘
          │
          ▼
    ┌─────────────┐
    │ 有新版本？   │
    └──────┬──────┘
           │
     ┌─────┴─────┐
     ▼           ▼
   [是]        [否]
     │           │
     ▼           ▼
┌─────────┐  ┌─────────┐
│本地已修改?│  │ 无操作  │
└────┬────┘  └─────────┘
     │
  ┌──┴──┐
  ▼     ▼
[是]   [否]
  │     │
  ▼     ▼
┌─────────────────┐  ┌─────────────┐
│ 显示对比界面     │  │ 直接更新    │
│ - 查看差异       │  └─────────────┘
│ - 使用市场版本   │
│ - 保留本地版本   │
│ - 合并(手动)     │
│ - 创建私有分支   │
└─────────────────┘
```

## 4. 自动化发布管理

### 4.1 技能包结构规范

```text
material-organize/              # 技能文件夹（名称 = 技能ID）
├── config.yaml                 # 市场配置元数据 (必须)
├── SKILL.md                    # Agent使用的技能内容 (必须)
├── icon.svg                    # SVG图标 (必须)
├── CHANGELOG.md                # 版本历史 (可选)
├── scripts/                    # 脚本文件 (可选)
│   ├── analyze.py
│   ├── export.sh
│   └── process.js
├── templates/                  # 模板文件 (可选)
│   ├── report.md
│   └── summary.json
├── prompts/                    # 子Prompt (可选)
│   ├── step1-analyze.md
│   └── step2-organize.md
└── examples/                   # 使用示例 (可选)
    └── demo-input/
```

**config.yaml 完整示例:**

```yaml
# 技能市场配置文件
id: material-organize
name: 素材整理
version: 1.0.0
description: 智能素材管理，自动分类整理媒体文件
category: 内容创作
tags: 素材,整理,自动化,文件管理
pricing: free
author:
  name: fba Team
  email: team@fba.ai
```

### 4.2 CLI 发布工具

```bash
# 验证技能包
fba skill validate ./my-skill

# 发布新版本 (自动递增版本号)
fba skill publish ./my-skill --bump patch
fba skill publish ./my-skill --bump minor
fba skill publish ./my-skill --version 2.0.0

# 批量发布 (CI/CD)
fba skill publish-all ./skills-directory
```

### 4.3 GitHub Actions 自动发布

```yaml
# .github/workflows/publish-skills.yml
name: Publish Skills
on:
  push:
    paths:
      - 'skills/**'
    branches: [main]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changed skills
        id: changes
        run: |
          changed=$(git diff --name-only HEAD~1 | grep '^skills/' | cut -d'/' -f2 | sort -u)
          echo "skills=$changed" >> $GITHUB_OUTPUT
      
      - name: Publish changed skills
        env:
          MARKETPLACE_API_KEY: ${{ secrets.MARKETPLACE_API_KEY }}
        run: |
          for skill in ${{ steps.changes.outputs.skills }}; do
            fba skill publish ./skills/$skill --bump patch
          done
```

## 5. 实施路线

### Phase 1: 基础架构 (1-2周)

- [ ] 设计并创建数据库表
- [ ] 配置对象存储 (S3 兼容)
- [ ] 实现基础 CRUD API
- [ ] 实现技能/应用下载 API

### Phase 2: 客户端集成 (1-2周)

- [ ] 实现市场元数据同步
- [ ] 实现技能下载安装
- [ ] 实现应用安装及技能依赖下载
- [ ] 实现本地版本追踪
- [ ] 实现更新检测

### Phase 3: 发布工具 (1周)

- [ ] 实现 CLI 发布工具
- [ ] 实现 GitHub Actions 集成
- [ ] 迁移现有 bundled-skills 到市场

### Phase 4: 高级功能 (后续)

- [ ] 版本对比与合并 UI
- [ ] 私有技能发布
- [ ] 付费技能支持
- [ ] 评分评论系统
