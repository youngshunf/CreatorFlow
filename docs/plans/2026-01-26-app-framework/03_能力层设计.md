# 能力层设计

> 版本：v1.0
> 日期：2026-01-26

## 概述

能力层提供独立的 Skills，可以单独发布到技能市场，支持运行时动态安装和热更新。

**重要说明**：CreatorFlow 的 Skills **就是** Claude Agent Skill，完全使用现有的 `packages/shared/src/skills` 实现，无需重新定义格式。Skills 使用标准的 `SKILL.md` 文件格式（YAML frontmatter + Markdown 内容）。

**关于工作流**：CreatorFlow 不引入独立的 Workflow 引擎。复杂的多步骤任务通过 Claude Agent SDK 的原生 agentic loop 实现，即通过 prompt 引导 agent 调用多个 skills 和 tools 完成任务，agent 自主决定执行顺序和条件分支。

## Skills（技能）

### Claude Agent Skill 兼容性

CreatorFlow 完全支持 Claude Agent Skill 标准格式，这意味着：

1. **直接使用官方 Skills**：可以直接导入和使用 Claude 官方提供的 skills
2. **兼容社区 Skills**：支持使用社区开源的 Claude Agent Skills
3. **无需修改**：现有的 Claude Agent Skills 可以直接在 CreatorFlow 中运行
4. **生态共享**：可以将 CreatorFlow 开发的 skills 分享给 Claude Agent 社区

### 定义格式

Skills 使用现有的 `SKILL.md` 格式（与项目中 `packages/shared/src/skills/storage.ts` 定义一致）：

```markdown
---
id: material-organize
name: 素材整理
version: 1.0.0
author: CreatorFlow Team
description: 帮助整理和分类创作素材

tags: ["素材管理", "内容创作"]
---

# 素材整理助手

你是一个专业的素材整理助手，帮助创作者整理和分类各种创作素材。

## 你的职责

1. 分析素材内容（图片、文本、视频等）
2. 提取关键信息和标签
3. 建议分类和归档方式
4. 识别素材之间的关联关系

## 可用工具

你可以调用以下 MCP tools 或系统功能：
- 文件系统操作（读取、移动、重命名文件）
- 图片分析（通过 vision API）
- 素材数据库操作（通过平台层的 model.material）

## 工作流程

当用户提供素材时：
1. 分析素材类型和内容
2. 提取关键信息（标题、描述、关键词）
3. 建议分类方式
4. 询问用户确认后保存到素材库

请以友好、专业的方式与用户交流。
```

**说明**：
- Skills 存储在 `~/.creator-flow/workspaces/{id}/skills/` 或全局 skills 目录
- 使用现有的 `SkillStorage` 类加载和管理（见 `packages/shared/src/skills/storage.ts`）
- Frontmatter 中的 metadata 可被应用框架读取用于依赖管理
- Markdown 内容即为 skill 的 system prompt

### Skill 特点

所有 Skills 本质上都是提供给 agent 的 system prompt 和上下文：

#### 1. 专业领域的 Prompt

Skill 定义了特定领域的专业知识和指令，例如：

```markdown
---
id: script-create
name: 脚本创作
---

你是一个专业的脚本创作助手，帮助创作者撰写各种平台的内容脚本。

你擅长：
- 小红书图文脚本（标题、正文、标签）
- 抖音短视频脚本（口播稿、分镜）
- 公众号长文（结构、段落、配图建议）

请根据用户的选题和素材，创作吸引人的内容。
```

#### 2. 工具和能力的说明

Skill 可以描述可用的工具，agent 会根据这些说明调用合适的 MCP tools：

```markdown
---
id: seo-analyzer
name: SEO 分析
---

你是 SEO 分析专家。你可以：

1. 分析关键词密度和相关性
2. 检查内容可读性（使用 Flesch-Kincaid 等指标）
3. 提供 SEO 优化建议

## 可用工具

- `analyze_text`：分析文本的 SEO 指标
- `suggest_keywords`：建议相关关键词
- `check_readability`：评估可读性得分

根据用户提供的内容，使用这些工具进行分析并给出专业建议。
```

#### 3. 复杂任务的指引

对于多步骤任务，Skill 提供清晰的流程指引，agent 自主执行：

```markdown
---
id: content-review
name: 内容审核
---

你是内容审核助手，负责检查内容是否符合发布标准。

## 审核流程

1. **敏感词检查**：检查是否包含敏感词汇
2. **语法检查**：识别语法错误和拼写错误
3. **平台规则检查**：确保符合目标平台的内容规范
4. **生成审核报告**：总结发现的问题并给出修改建议

按顺序执行上述检查，每一步都要给出明确的结果。
```

**重要**：agent 会根据 skill 的描述自主决定如何执行，包括调用哪些工具、按什么顺序执行。不需要显式定义"步骤引擎"。

### Skill 加载机制

Skills 使用现有的 `SkillStorage` 加载：

```typescript
// 使用现有的 SkillStorage
import { SkillStorage } from '@creator-flow/shared/skills'

// 加载 skill
const skillStorage = new SkillStorage(workspaceId)
const skill = await skillStorage.get('material-organize')

// Skill 结构
interface Skill {
  id: string
  name: string
  description: string
  content: string  // Markdown 内容，即 system prompt
  tags?: string[]
  // ... 其他 frontmatter metadata
}
```

### Skill 在 Agent 中的使用

Skills 通过现有的 `CreatorFlowAgent` 集成：

```typescript
import { CreatorFlowAgent } from '@creator-flow/shared/agent'

// 创建 agent 并加载 skill
const agent = new CreatorFlowAgent({
  workspaceId,
  skillId: 'material-organize', // agent 会加载对应的 skill
  // ...
})

// Agent 会自动：
// 1. 加载 skill 的 system prompt
// 2. 提供 MCP tools 和 bash 工具
// 3. 根据 skill 的指引执行任务
```

## 复杂任务的流程编排

### 基于 Prompt 的流程编排

对于复杂的多步骤任务，**不引入独立的 Workflow 引擎**。而是通过精心设计的 Skill Prompt 引导 Agent 完成多步骤任务。

#### 示例：选题到发布流程

创建一个包含完整流程的 Skill：

```markdown
---
id: topic-to-publish-flow
name: 选题到发布流程
version: 1.0.0
author: CreatorFlow Team
description: 引导 agent 完成从选题研究到内容发布的完整流程
tags: ["内容创作", "工作流"]
---

# 选题到发布完整流程助手

你是一个专业的内容创作流程管理助手，帮助创作者从选题研究一直到内容发布。

## 工作流程

按照以下步骤引导用户完成整个创作流程：

### 1. 选题研究

- 分析当前热点和用户需求
- 确定目标受众和关键词
- 生成选题简报（topic brief）

使用可用的网络搜索、趋势分析工具完成研究。

### 2. 素材收集与整理

- 根据选题关键词收集相关素材（图片、文本、视频）
- 分析和标记素材
- 将素材保存到素材库以便后续使用

可以使用文件系统工具和数据库操作。

### 3. 脚本创作

- 根据选题简报和收集的素材创作内容脚本
- 适配目标平台（小红书、抖音、公众号）的写作风格
- 确保内容吸引人、符合平台规范

创作完成后，将脚本呈现给用户审阅。

### 4. 用户审核

- 询问用户对脚本的意见
- **如果通过审核**：进入平台适配步骤
- **如果需要修改**：收集反馈并进入优化步骤

一定要等待用户明确的反馈。

### 5. 内容优化（如需）

如果用户提出了修改建议：
- 根据用户反馈优化内容
- 再次呈现给用户审核
- 重复此过程直到用户满意

### 6. 平台适配

将通过审核的内容适配到不同平台：
- **小红书**：调整标题、标签、图片格式
- **抖音**：生成视频脚本、口播稿、分镜
- **公众号**：调整格式、添加配图建议

使用平台集成 API 获取平台特定要求。

### 7. 发布执行

- 使用平台 API 发布内容
- 可以支持定时发布功能
- 记录发布结果和链接

发布前询问用户确认，发布后告知结果。

## 注意事项

1. **在每个关键步骤后等待用户确认**
2. **保存中间结果**，以便用户随时查看和修改
3. **提供清晰的进度反馈**，让用户知道当前处于哪个阶段
4. **允许用户跳过或返回某个步骤**

## 可用能力

- 网络搜索和趋势分析
- 文件系统操作
- 数据库读写（素材库、内容库）
- 平台 API 集成（小红书、抖音、公众号）
- 图片和视频分析
```

### 关键设计原则

1. **Prompt 驱动**：所有流程逻辑写在 skill prompt 中，agent 自主决定执行
2. **人机交互**：在关键步骤明确要求等待用户确认
3. **状态管理**：通过保存中间结果到文件/数据库维持上下文
4. **工具调用**：Agent 根据 prompt 描述自动调用所需的 MCP tools
5. **错误处理**：Agent 自主判断错误并重试或向用户报告

### 优势

相比独立的 Workflow 引擎，基于 Prompt 的流程编排有以下优势：

1. **简单灵活**：无需维护复杂的引擎代码，只需编写清晰的 prompt
2. **AI 原生**：充分利用 Claude Agent SDK 的 agentic loop 能力
3. **易于调试**：可以通过修改 prompt 调整行为，无需修改代码
4. **更好的适应性**：Agent 可以根据实际情况灵活调整执行顺序
5. **跨平台兼容**：仍然使用 SKILL.md 格式，与 Claude Agent 生态完全兼容

## Skill 存储和管理

### 存储位置

Skills 存储在以下位置：

```
~/.creator-flow/
├── workspaces/{id}/
│   ├── skills/           # 工作区级别的 skills
│   │   ├── material-organize/
│   │   │   └── SKILL.md
│   │   └── script-create/
│   │       └── SKILL.md
```

### 使用现有的 SkillStorage

```typescript
import { SkillStorage } from '@creator-flow/shared/skills'

// 列出所有 skills
const skillStorage = new SkillStorage(workspaceId)
const skills = await skillStorage.list()

// 加载单个 skill
const skill = await skillStorage.get('material-organize')

// 创建 skill
await skillStorage.create({
  id: 'my-skill',
  name: '我的技能',
  content: '...markdown content...'
})

// 更新 skill
await skillStorage.update('my-skill', {
  content: '...updated content...'
})

// 删除 skill
await skillStorage.delete('my-skill')
```

## 技能市场集成

技能市场允许用户分享和发现 skills。具体设计见 [05_市场设计.md](./05_市场设计.md)。

**兼容性保证**：由于 CreatorFlow 的 skills 完全使用 Claude Agent Skill 格式，可以与 Claude 官方和社区 skills 无缝互操作。

## 下一步

阅读 [应用层设计](./04_应用层设计.md) 了解如何组合这些能力创建应用。
