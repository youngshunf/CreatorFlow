# 市场体系设计

> 版本：v1.0
> 日期：2026-01-26

## 概述

CreatorFlow 提供双市场体系：应用市场和技能市场，支持开发者发布和用户购买应用、技能和工作流。

## 应用市场（App Marketplace）

### 市场结构

```typescript
interface AppMarketplace {
  // 应用列表
  apps: AppListing[]

  // 分类
  categories: Category[]

  // 精选内容
  featured: FeaturedSection[]

  // 排行榜
  rankings: Ranking[]
}

interface AppListing {
  // 应用信息
  app: AppManifest

  // 发布者信息
  publisher: Publisher

  // 市场数据
  stats: MarketStats

  // 定价信息
  pricing: PricingInfo

  // 评价
  reviews: Review[]

  // 更新信息
  changelog: Changelog[]
}

interface Publisher {
  id: string
  name: string
  email: string
  url?: string
  verified: boolean
  avatar?: string
  bio?: string
  joinedAt: Date
}

interface MarketStats {
  downloads: number
  activeUsers: number
  rating: number
  reviewCount: number
  lastUpdated: Date
}

interface PricingInfo {
  type: 'free' | 'paid' | 'freemium'
  price?: number
  subscription?: {
    monthly: number
    yearly: number
  }
  trial?: {
    enabled: boolean
    days: number
  }
  currency: string
}

interface Review {
  id: string
  userId: string
  userName: string
  rating: number
  title: string
  content: string
  createdAt: Date
  helpful: number
}
```

### 应用分类

```typescript
const categories: Category[] = [
  {
    id: 'content-creation',
    name: '内容创作',
    description: '自媒体、视频、写作等创作工具',
    icon: 'edit'
  },
  {
    id: 'project-management',
    name: '项目管理',
    description: '任务管理、团队协作工具',
    icon: 'briefcase'
  },
  {
    id: 'data-analytics',
    name: '数据分析',
    description: '数据可视化、报表生成工具',
    icon: 'chart'
  },
  {
    id: 'marketing',
    name: '营销推广',
    description: 'SEO、广告投放、社交媒体工具',
    icon: 'megaphone'
  },
  {
    id: 'education',
    name: '教育培训',
    description: '课程制作、知识管理工具',
    icon: 'book'
  },
  {
    id: 'development',
    name: '开发工具',
    description: '代码生成、API 测试工具',
    icon: 'code'
  }
]
```

### 精选内容

```typescript
interface FeaturedSection {
  id: string
  title: string
  description: string
  apps: string[]  // App IDs
  order: number
}

const featuredSections: FeaturedSection[] = [
  {
    id: 'editor-picks',
    title: '编辑精选',
    description: '由 CreatorFlow 团队精心挑选的优质应用',
    apps: ['app.creator-media', 'app.project-management'],
    order: 1
  },
  {
    id: 'trending',
    title: '热门应用',
    description: '最近下载量最高的应用',
    apps: [],
    order: 2
  },
  {
    id: 'new-releases',
    title: '新品上架',
    description: '最新发布的应用',
    apps: [],
    order: 3
  }
]
```

### 排行榜

```typescript
interface Ranking {
  type: 'downloads' | 'rating' | 'revenue'
  period: 'daily' | 'weekly' | 'monthly' | 'all-time'
  apps: RankingEntry[]
}

interface RankingEntry {
  rank: number
  appId: string
  value: number
  change: number  // 排名变化
}

// 获取排行榜
async function getRanking(
  type: Ranking['type'],
  period: Ranking['period']
): Promise<Ranking> {
  const apps = await queryApps()

  // 根据类型排序
  const sorted = apps.sort((a, b) => {
    switch (type) {
      case 'downloads':
        return b.stats.downloads - a.stats.downloads
      case 'rating':
        return b.stats.rating - a.stats.rating
      case 'revenue':
        return b.revenue - a.revenue
    }
  })

  // 限制时间范围
  const filtered = filterByPeriod(sorted, period)

  return {
    type,
    period,
    apps: filtered.map((app, index) => ({
      rank: index + 1,
      appId: app.id,
      value: getValue(app, type),
      change: calculateChange(app, type, period)
    }))
  }
}
```

### 搜索和过滤

```typescript
interface SearchQuery {
  keyword?: string
  category?: string
  tags?: string[]
  pricing?: 'free' | 'paid' | 'freemium'
  rating?: number
  sortBy?: 'relevance' | 'downloads' | 'rating' | 'date'
  page?: number
  pageSize?: number
}

async function searchApps(query: SearchQuery): Promise<SearchResult> {
  let apps = await queryApps()

  // 关键词搜索
  if (query.keyword) {
    apps = apps.filter(app =>
      app.name.toLowerCase().includes(query.keyword.toLowerCase()) ||
      app.description.toLowerCase().includes(query.keyword.toLowerCase()) ||
      app.tags.some(tag => tag.toLowerCase().includes(query.keyword.toLowerCase()))
    )
  }

  // 分类过滤
  if (query.category) {
    apps = apps.filter(app => app.category === query.category)
  }

  // 标签过滤
  if (query.tags && query.tags.length > 0) {
    apps = apps.filter(app =>
      query.tags.some(tag => app.tags.includes(tag))
    )
  }

  // 定价过滤
  if (query.pricing) {
    apps = apps.filter(app => app.pricing.type === query.pricing)
  }

  // 评分过滤
  if (query.rating) {
    apps = apps.filter(app => app.stats.rating >= query.rating)
  }

  // 排序
  apps = sortApps(apps, query.sortBy || 'relevance')

  // 分页
  const page = query.page || 1
  const pageSize = query.pageSize || 20
  const start = (page - 1) * pageSize
  const end = start + pageSize

  return {
    apps: apps.slice(start, end),
    total: apps.length,
    page,
    pageSize
  }
}
```

### 应用详情页

```typescript
function AppDetailPage({ appId }: Props) {
  const [app, setApp] = useState<AppListing | null>(null)
  const [activeTab, setActiveTab] = useState<'overview' | 'reviews' | 'changelog'>('overview')

  useEffect(() => {
    loadAppListing(appId).then(setApp)
  }, [appId])

  if (!app) return <LoadingSpinner />

  return (
    <div className="app-detail-page">
      <div className="app-header">
        <img src={app.app.icon} alt={app.app.name} />
        <div className="app-info">
          <h1>{app.app.name}</h1>
          <p>{app.app.description}</p>
          <div className="app-meta">
            <span className="category">{app.app.category}</span>
            <span className="rating">
              ⭐ {app.stats.rating.toFixed(1)} ({app.stats.reviewCount} 评价)
            </span>
            <span className="downloads">
              {formatNumber(app.stats.downloads)} 次下载
            </span>
          </div>
          <div className="publisher">
            <Avatar src={app.publisher.avatar} />
            <span>{app.publisher.name}</span>
            {app.publisher.verified && <Badge>已认证</Badge>}
          </div>
        </div>
        <div className="app-actions">
          <PricingDisplay pricing={app.pricing} />
          <InstallButton app={app} />
        </div>
      </div>

      <div className="app-screenshots">
        {app.app.screenshots.map((screenshot, index) => (
          <img key={index} src={screenshot} alt={`Screenshot ${index + 1}`} />
        ))}
      </div>

      <div className="app-tabs">
        <button
          className={activeTab === 'overview' ? 'active' : ''}
          onClick={() => setActiveTab('overview')}
        >
          概览
        </button>
        <button
          className={activeTab === 'reviews' ? 'active' : ''}
          onClick={() => setActiveTab('reviews')}
        >
          评价 ({app.stats.reviewCount})
        </button>
        <button
          className={activeTab === 'changelog' ? 'active' : ''}
          onClick={() => setActiveTab('changelog')}
        >
          更新日志
        </button>
      </div>

      <div className="app-content">
        {activeTab === 'overview' && (
          <OverviewTab app={app} />
        )}
        {activeTab === 'reviews' && (
          <ReviewsTab reviews={app.reviews} />
        )}
        {activeTab === 'changelog' && (
          <ChangelogTab changelog={app.changelog} />
        )}
      </div>
    </div>
  )
}

function InstallButton({ app }: Props) {
  const [installing, setInstalling] = useState(false)
  const [installed, setInstalled] = useState(false)

  useEffect(() => {
    checkInstalled(app.app.id).then(setInstalled)
  }, [app.app.id])

  const handleInstall = async () => {
    setInstalling(true)
    try {
      await installApp(app.app.id)
      setInstalled(true)
    } catch (error) {
      showError(error.message)
    } finally {
      setInstalling(false)
    }
  }

  if (installed) {
    return <button disabled>已安装</button>
  }

  if (app.pricing.type === 'free') {
    return (
      <button onClick={handleInstall} disabled={installing}>
        {installing ? '安装中...' : '免费安装'}
      </button>
    )
  }

  return (
    <button onClick={() => showPurchaseDialog(app)}>
      购买 ¥{app.pricing.price}
    </button>
  )
}
```

## 技能市场（Skill Marketplace）

### 市场结构

```typescript
interface SkillMarketplace {
  skills: SkillListing[]
  workflows: WorkflowListing[]
  categories: Category[]
  featured: FeaturedSection[]
}

interface SkillListing {
  skill: SkillManifest
  publisher: Publisher
  stats: MarketStats
  pricing: PricingInfo
  reviews: Review[]
  compatibleApps: string[]  // 兼容的应用 ID
}

interface WorkflowListing {
  workflow: WorkflowManifest
  publisher: Publisher
  stats: MarketStats
  pricing: PricingInfo
  reviews: Review[]
  compatibleApps: string[]
}
```

### 技能分类

```typescript
const skillCategories: Category[] = [
  {
    id: 'content',
    name: '内容创作',
    description: '写作、编辑、创意相关技能',
    icon: 'edit'
  },
  {
    id: 'analysis',
    name: '数据分析',
    description: '数据处理、分析、可视化技能',
    icon: 'chart'
  },
  {
    id: 'automation',
    name: '自动化',
    description: '流程自动化、批处理技能',
    icon: 'zap'
  },
  {
    id: 'integration',
    name: '平台集成',
    description: '第三方平台连接技能',
    icon: 'link'
  }
]
```

### 技能详情页

```typescript
function SkillDetailPage({ skillId }: Props) {
  const [skill, setSkill] = useState<SkillListing | null>(null)

  useEffect(() => {
    loadSkillListing(skillId).then(setSkill)
  }, [skillId])

  if (!skill) return <LoadingSpinner />

  return (
    <div className="skill-detail-page">
      <div className="skill-header">
        <div className="skill-info">
          <h1>{skill.skill.name}</h1>
          <p>{skill.skill.description}</p>
          <div className="skill-meta">
            <span className="type">{skill.skill.type}</span>
            <span className="rating">
              ⭐ {skill.stats.rating.toFixed(1)}
            </span>
            <span className="downloads">
              {formatNumber(skill.stats.downloads)} 次下载
            </span>
          </div>
        </div>
        <div className="skill-actions">
          <PricingDisplay pricing={skill.pricing} />
          <InstallButton skill={skill} />
        </div>
      </div>

      <div className="skill-details">
        <h3>技能详情</h3>
        <ul>
          <li><strong>类型：</strong>{skill.skill.type}</li>
          <li><strong>模型：</strong>{skill.skill.model}</li>
          <li><strong>版本：</strong>{skill.skill.version}</li>
        </ul>

        {skill.skill.tools && skill.skill.tools.length > 0 && (
          <div className="skill-tools">
            <h4>工具能力</h4>
            <ul>
              {skill.skill.tools.map(tool => (
                <li key={tool.name}>
                  <strong>{tool.name}</strong>: {tool.description}
                </li>
              ))}
            </ul>
          </div>
        )}

        {skill.compatibleApps.length > 0 && (
          <div className="compatible-apps">
            <h4>兼容应用</h4>
            <div className="app-list">
              {skill.compatibleApps.map(appId => (
                <AppBadge key={appId} appId={appId} />
              ))}
            </div>
          </div>
        )}
      </div>

      <div className="skill-examples">
        <h3>使用示例</h3>
        {skill.skill.examples?.map((example, index) => (
          <div key={index} className="example">
            <div className="user-message">
              <strong>用户：</strong>{example.user}
            </div>
            <div className="assistant-message">
              <strong>助手：</strong>{example.assistant}
            </div>
          </div>
        ))}
      </div>

      <ReviewsSection reviews={skill.reviews} />
    </div>
  )
}
```

## 发布流程

### 开发者注册

```typescript
interface DeveloperAccount {
  id: string
  name: string
  email: string
  verified: boolean
  paymentInfo?: PaymentInfo
  taxInfo?: TaxInfo
  createdAt: Date
}

interface PaymentInfo {
  type: 'bank' | 'paypal' | 'alipay'
  accountNumber: string
  accountName: string
}

async function registerDeveloper(data: {
  name: string
  email: string
  password: string
}): Promise<DeveloperAccount> {
  // 创建账号
  const account = await createAccount(data)

  // 发送验证邮件
  await sendVerificationEmail(account.email)

  return account
}
```

### 应用提交

```typescript
interface AppSubmission {
  id: string
  appId: string
  version: string
  packagePath: string
  status: 'pending' | 'reviewing' | 'approved' | 'rejected'
  submittedAt: Date
  reviewedAt?: Date
  reviewNotes?: string
}

async function submitApp(packagePath: string): Promise<AppSubmission> {
  // 验证包
  const manifest = await validatePackage(packagePath)

  // 创建提交记录
  const submission: AppSubmission = {
    id: generateId(),
    appId: manifest.id,
    version: manifest.version,
    packagePath,
    status: 'pending',
    submittedAt: new Date()
  }

  // 保存提交记录
  await saveSubmission(submission)

  // 触发审核流程
  await triggerReview(submission)

  return submission
}
```

### 审核流程

```typescript
interface ReviewProcess {
  submissionId: string
  checks: ReviewCheck[]
  status: 'pending' | 'in-progress' | 'completed'
}

interface ReviewCheck {
  type: 'security' | 'quality' | 'content' | 'legal'
  status: 'pending' | 'passed' | 'failed'
  notes?: string
}

async function reviewSubmission(submissionId: string): Promise<void> {
  const submission = await getSubmission(submissionId)

  // 自动检查
  const autoChecks = await runAutoChecks(submission)

  // 人工审核
  const manualReview = await requestManualReview(submission)

  // 汇总结果
  const allPassed = [...autoChecks, manualReview].every(
    check => check.status === 'passed'
  )

  if (allPassed) {
    await approveSubmission(submission)
  } else {
    await rejectSubmission(submission, getFailureNotes(autoChecks, manualReview))
  }
}

async function runAutoChecks(submission: AppSubmission): Promise<ReviewCheck[]> {
  return [
    await checkSecurity(submission),
    await checkQuality(submission),
    await checkContent(submission)
  ]
}

async function checkSecurity(submission: AppSubmission): Promise<ReviewCheck> {
  // 扫描恶意代码
  const malwareFound = await scanMalware(submission.packagePath)

  // 检查权限使用
  const suspiciousPermissions = await checkPermissions(submission.packagePath)

  return {
    type: 'security',
    status: malwareFound || suspiciousPermissions ? 'failed' : 'passed',
    notes: malwareFound ? '检测到恶意代码' : suspiciousPermissions ? '权限使用异常' : undefined
  }
}
```

### 发布上架

```typescript
async function publishApp(submissionId: string): Promise<void> {
  const submission = await getSubmission(submissionId)

  // 复制包到市场存储
  const marketPath = await copyToMarketStorage(submission.packagePath)

  // 创建市场列表
  const listing: AppListing = {
    app: await readManifest(marketPath),
    publisher: await getPublisher(submission.developerId),
    stats: {
      downloads: 0,
      activeUsers: 0,
      rating: 0,
      reviewCount: 0,
      lastUpdated: new Date()
    },
    pricing: await getPricingInfo(submission.appId),
    reviews: [],
    changelog: []
  }

  // 保存到市场
  await saveToMarketplace(listing)

  // 通知开发者
  await notifyPublisher(submission.developerId, {
    type: 'app-published',
    appId: submission.appId,
    version: submission.version
  })
}
```

## 支付和分成

### 定价模型

```typescript
interface Pricing {
  type: 'free' | 'paid' | 'freemium'

  // 一次性付费
  oneTime?: {
    price: number
    currency: string
  }

  // 订阅制
  subscription?: {
    monthly: number
    yearly: number
    currency: string
  }

  // 试用
  trial?: {
    enabled: boolean
    days: number
  }

  // Freemium
  freemium?: {
    freeFeatures: string[]
    paidFeatures: string[]
    upgradePrice: number
  }
}
```

### 支付流程

```typescript
async function purchaseApp(appId: string, pricingOption: 'oneTime' | 'monthly' | 'yearly'): Promise<Purchase> {
  const app = await getApp(appId)
  const pricing = app.pricing

  // 计算价格
  const amount = calculateAmount(pricing, pricingOption)

  // 创建订单
  const order: Order = {
    id: generateId(),
    userId: getCurrentUserId(),
    appId,
    pricingOption,
    amount,
    currency: pricing.currency,
    status: 'pending',
    createdAt: new Date()
  }

  await saveOrder(order)

  // 调用支付网关
  const paymentResult = await processPayment(order)

  if (paymentResult.success) {
    // 更新订单状态
    order.status = 'completed'
    order.paidAt = new Date()
    await saveOrder(order)

    // 授予访问权限
    await grantAccess(order.userId, appId)

    // 分成给开发者
    await distributRevenue(order)

    return {
      success: true,
      orderId: order.id
    }
  } else {
    order.status = 'failed'
    order.failureReason = paymentResult.error
    await saveOrder(order)

    return {
      success: false,
      error: paymentResult.error
    }
  }
}
```

### 收入分成

```typescript
interface RevenueShare {
  orderId: string
  totalAmount: number
  platformFee: number  // 30%
  developerRevenue: number  // 70%
  currency: string
}

async function distributeRevenue(order: Order): Promise<void> {
  const platformFeeRate = 0.3
  const developerRate = 0.7

  const share: RevenueShare = {
    orderId: order.id,
    totalAmount: order.amount,
    platformFee: order.amount * platformFeeRate,
    developerRevenue: order.amount * developerRate,
    currency: order.currency
  }

  // 记录分成
  await saveRevenueShare(share)

  // 转账给开发者（累积到月底结算）
  await addToDeveloperBalance(order.developerId, share.developerRevenue)
}

// 月度结算
async function monthlySettlement(): Promise<void> {
  const developers = await getAllDevelopers()

  for (const developer of developers) {
    const balance = await getDeveloperBalance(developer.id)

    if (balance > 0) {
      // 转账
      await transferToDeveloper(developer, balance)

      // 清零余额
      await resetDeveloperBalance(developer.id)

      // 发送结算通知
      await notifySettlement(developer, balance)
    }
  }
}
```

## 评价系统

### 提交评价

```typescript
interface Review {
  id: string
  userId: string
  appId: string
  rating: number  // 1-5
  title: string
  content: string
  createdAt: Date
  helpful: number
}

async function submitReview(data: {
  appId: string
  rating: number
  title: string
  content: string
}): Promise<Review> {
  // 检查是否已购买
  const hasPurchased = await checkPurchase(getCurrentUserId(), data.appId)
  if (!hasPurchased) {
    throw new Error('只有购买用户才能评价')
  }

  // 检查是否已评价
  const existingReview = await findReview(getCurrentUserId(), data.appId)
  if (existingReview) {
    throw new Error('已经评价过此应用')
  }

  // 创建评价
  const review: Review = {
    id: generateId(),
    userId: getCurrentUserId(),
    appId: data.appId,
    rating: data.rating,
    title: data.title,
    content: data.content,
    createdAt: new Date(),
    helpful: 0
  }

  await saveReview(review)

  // 更新应用评分
  await updateAppRating(data.appId)

  return review
}
```

### 评分计算

```typescript
async function updateAppRating(appId: string): Promise<void> {
  const reviews = await getAppReviews(appId)

  // 计算平均分
  const totalRating = reviews.reduce((sum, r) => sum + r.rating, 0)
  const averageRating = totalRating / reviews.length

  // 更新应用统计
  await updateAppStats(appId, {
    rating: averageRating,
    reviewCount: reviews.length
  })
}
```

## 下一步

阅读 [开发者指南](./07_开发者指南.md) 了解如何开发和发布应用。
