# 应用层设计

> 版本：v1.0
> 日期：2026-01-26

## 概述

应用层作为"能力组合器"，通过声明式配置组合平台层和能力层的能力，提供完整的业务解决方案。

## 应用 Manifest

### 完整结构

```json
{
  "$schema": "https://creatorflow.ai/schemas/app-manifest-v1.json",

  "id": "app.creator-media",
  "name": "自媒体创作",
  "version": "1.0.0",
  "description": "完整的自媒体创作工作流，支持小红书、抖音、公众号",

  "author": {
    "name": "CreatorFlow Team",
    "email": "team@creatorflow.ai",
    "url": "https://creatorflow.ai"
  },

  "license": "MIT",
  "homepage": "https://creatorflow.ai/apps/creator-media",
  "repository": "https://github.com/creatorflow/creator-media-app",

  "icon": "assets/icon.svg",

  "pricing": {
    "type": "free"
  },

  "skillDependencies": [
    "material-organize@^1.0.0",
    "script-create@^1.0.0",
    "topic-research@^1.0.0",
    "content-optimizer@^1.0.0",
    "platform-adapter@^1.0.0",
    "multi-platform-publish@^1.0.0",
    "topic-to-publish-flow@^1.0.0"
  ],

  "workspace": {
    "directoryStructure": {
      "素材库": {
        "图片": {},
        "视频": {},
        "文本": {},
        "音频": {}
      },
      "脚本库": {
        "草稿": {},
        "待审核": {},
        "已发布": {}
      },
      "发布记录": {
        "小红书": {},
        "抖音": {},
        "公众号": {}
      }
    },
    "defaults": {
      "model": "claude-sonnet-4-20250514",
      "permissionMode": "ask",
      "thinkingLevel": "think"
    },
    "presetData": {
      "labels": [
        { "id": "待创作", "name": "待创作", "color": "#3b82f6" },
        { "id": "创作中", "name": "创作中", "color": "#f59e0b" },
        { "id": "待审核", "name": "待审核", "color": "#8b5cf6" },
        { "id": "已发布", "name": "已发布", "color": "#10b981" }
      ],
      "statuses": [
        { "id": "draft", "name": "草稿", "icon": "circle" },
        { "id": "review", "name": "待审核", "icon": "eye" },
        { "id": "published", "name": "已发布", "icon": "check" }
      ]
    }
  },

  "marketplace": {
    "category": "content-creation",
    "tags": ["自媒体", "创作", "AI", "小红书", "抖音", "公众号"],
    "screenshots": [
      "assets/screenshots/dashboard.png",
      "assets/screenshots/editor.png",
      "assets/screenshots/calendar.png"
    ]
  },

  "compatibility": {
    "platform": ">=1.0.0"
  }
}
```

### Manifest 字段说明

#### 基础信息
- `id`: 应用唯一标识，格式 `app.<name>`
- `name`: 应用显示名称
- `version`: 语义化版本号
- `author`: 作者信息
- `description`: 应用描述
- `license`: 开源协议
- `homepage`: 应用主页
- `repository`: 代码仓库

#### 定价信息
```json
{
  "pricing": {
    "type": "free" | "paid" | "freemium",
    "price": 99,  // 一次性付费价格
    "subscription": {
      "monthly": 9.9,
      "yearly": 99
    },
    "trial": {
      "enabled": true,
      "days": 7
    }
  }
}
```

#### 依赖声明
- `dependencies.platform`: 平台版本要求
- `dependencies.ui`: UI 组件依赖
- `dependencies.models`: 数据模型依赖
- `dependencies.integrations`: 集成依赖

#### 能力绑定
- `capabilities.skills`: 绑定的 Skills
- `capabilities.workflows`: 绑定的 Workflows

#### 工作区配置
- `workspace.defaultDirectory`: 默认工作目录
- `workspace.directoryStructure`: 目录结构模板
- `workspace.defaultSettings`: 默认设置
- `workspace.presetData`: 预置数据（标签、状态等）

#### 权限声明
- `filesystem`: 文件系统访问
- `network`: 网络访问
- `clipboard`: 剪贴板访问
- `camera`: 摄像头访问
- `microphone`: 麦克风访问

#### 兼容性
- `compatibility.platform`: 平台版本要求
- `compatibility.os`: 支持的操作系统
- `compatibility.node`: Node.js 版本要求

#### 市场信息
- `marketplace.category`: 应用分类
- `marketplace.tags`: 标签
- `marketplace.screenshots`: 截图
- `marketplace.video`: 演示视频
- `marketplace.changelog`: 更新日志

#### 插件兼容性
- `plugins.compatible`: 兼容的插件应用
- `plugins.recommended`: 推荐的插件应用

## 应用目录结构

### 开发时结构

```
creator-media-app/
├── manifest.json                # 应用清单
├── skills/                      # 绑定的 skills
│   ├── material-organize/
│   │   └── skill.yaml
│   ├── script-create/
│   │   └── skill.yaml
│   └── topic-research/
│       └── skill.yaml
├── workflows/                   # 绑定的 workflows
│   └── topic-to-publish/
│       └── workflow.yaml
├── assets/                      # 应用资源
│   ├── icon.png                # 应用图标
│   ├── screenshots/            # 截图
│   │   ├── dashboard.png
│   │   ├── editor.png
│   │   └── calendar.png
│   └── demo.mp4                # 演示视频
├── docs/                        # 应用文档
│   ├── README.md               # 应用介绍
│   ├── GUIDE.md                # 使用指南
│   └── API.md                  # API 文档（如果有）
├── templates/                   # 模板文件（可选）
│   ├── xiaohongshu-template.md
│   ├── douyin-template.md
│   └── wechat-template.md
└── package.json                 # 开发依赖（如果需要）
```

### 运行时结构

```
.creator-flow/apps/creator-media/
├── manifest.json
├── config/
│   ├── workspace.json          # 工作区配置
│   ├── settings.json           # 默认设置
│   └── presets.json            # 预置数据
├── assets/
│   └── icon.png
└── installed-at.json           # 安装信息
```

## 应用加载流程

### 1. 依赖解析

```typescript
class AppLoader {
  async load(appId: string): Promise<App> {
    // 读取 manifest
    const manifest = await this.readManifest(appId)

    // 解析依赖
    const dependencies = await this.resolveDependencies(manifest)

    // 检查缺失的依赖
    const missing = dependencies.filter(dep => !dep.installed)

    if (missing.length > 0) {
      // 提示用户安装缺失的依赖
      await this.installDependencies(missing)
    }

    return new App(manifest, dependencies)
  }

  private async resolveDependencies(manifest: AppManifest): Promise<Dependency[]> {
    const deps: Dependency[] = []

    // 解析 UI 依赖
    for (const uiDep of manifest.dependencies.ui) {
      const [id, version] = uiDep.split('@')
      const plugin = registry.get(id)

      deps.push({
        type: 'ui',
        id,
        version,
        installed: !!plugin,
        satisfies: plugin ? this.satisfiesVersion(plugin.version, version) : false
      })
    }

    // 解析数据模型依赖
    for (const modelDep of manifest.dependencies.models) {
      const [id, version] = modelDep.split('@')
      const plugin = registry.get(id)

      deps.push({
        type: 'model',
        id,
        version,
        installed: !!plugin,
        satisfies: plugin ? this.satisfiesVersion(plugin.version, version) : false
      })
    }

    // 解析集成依赖
    for (const integrationDep of manifest.dependencies.integrations) {
      const [id, version] = integrationDep.split('@')
      const plugin = registry.get(id)

      deps.push({
        type: 'integration',
        id,
        version,
        installed: !!plugin,
        satisfies: plugin ? this.satisfiesVersion(plugin.version, version) : false
      })
    }

    // 解析 Skill 依赖
    for (const skillDep of manifest.capabilities.skills) {
      const [id, version] = skillDep.split('@')
      const skill = await skillLoader.find(id)

      deps.push({
        type: 'skill',
        id,
        version,
        installed: !!skill,
        satisfies: skill ? this.satisfiesVersion(skill.version, version) : false
      })
    }

    // 解析 Workflow 依赖
    for (const workflowDep of manifest.capabilities.workflows) {
      const [id, version] = workflowDep.split('@')
      const workflow = await workflowLoader.find(id)

      deps.push({
        type: 'workflow',
        id,
        version,
        installed: !!workflow,
        satisfies: workflow ? this.satisfiesVersion(workflow.version, version) : false
      })
    }

    return deps
  }
}
```

### 2. 依赖安装

```typescript
class DependencyInstaller {
  async install(dependencies: Dependency[]): Promise<void> {
    // 按类型分组
    const grouped = this.groupByType(dependencies)

    // 并行安装
    await Promise.all([
      this.installPlugins(grouped.ui),
      this.installPlugins(grouped.model),
      this.installPlugins(grouped.integration),
      this.installSkills(grouped.skill),
      this.installWorkflows(grouped.workflow)
    ])
  }

  private async installPlugins(deps: Dependency[]): Promise<void> {
    for (const dep of deps) {
      // 从市场下载
      const packagePath = await marketplace.download(dep.id, dep.version)

      // 安装插件
      await pluginInstaller.install(packagePath)
    }
  }

  private async installSkills(deps: Dependency[]): Promise<void> {
    for (const dep of deps) {
      // 从市场下载
      const packagePath = await marketplace.download(dep.id, dep.version)

      // 安装 Skill
      await skillInstaller.install(packagePath)
    }
  }
}
```

### 3. 工作区初始化

```typescript
class WorkspaceInitializer {
  async initialize(app: App, config: WorkspaceConfig): Promise<Workspace> {
    // 创建工作区目录
    await this.createDirectoryStructure(
      config.directory,
      app.manifest.workspace.directoryStructure
    )

    // 应用默认设置
    const settings = {
      ...app.manifest.workspace.defaultSettings,
      ...config.customSettings
    }

    // 创建预置数据
    await this.createPresetData(app.manifest.workspace.presetData)

    // 创建工作区实例
    const workspace = new Workspace({
      id: generateId(),
      name: config.name,
      appId: app.id,
      directory: config.directory,
      settings,
      createdAt: new Date()
    })

    // 保存工作区配置
    await this.saveWorkspace(workspace)

    return workspace
  }

  private async createDirectoryStructure(
    baseDir: string,
    structure: DirectoryStructure
  ): Promise<void> {
    for (const [name, children] of Object.entries(structure)) {
      const dirPath = path.join(baseDir, name)
      await fs.mkdir(dirPath, { recursive: true })

      if (Object.keys(children).length > 0) {
        await this.createDirectoryStructure(dirPath, children)
      }
    }
  }

  private async createPresetData(presets: PresetData): Promise<void> {
    // 创建标签
    if (presets.labels) {
      const labelModel = registry.get('model.label')
      for (const label of presets.labels) {
        await labelModel.create(label)
      }
    }

    // 创建状态
    if (presets.statuses) {
      const statusModel = registry.get('model.status')
      for (const status of presets.statuses) {
        await statusModel.create(status)
      }
    }
  }
}
```

## 插件应用

### 插件应用 Manifest

插件应用是扩展主应用能力的轻量级应用：

```json
{
  "id": "plugin.data-analytics",
  "name": "数据分析插件",
  "version": "1.0.0",
  "type": "plugin",

  "compatibleApps": [
    "app.creator-media@^1.0.0",
    "app.project-management@^1.0.0"
  ],

  "dependencies": {
    "ui": [
      "ui.analytics-dashboard@^1.0.0",
      "ui.chart-library@^1.0.0"
    ],
    "models": [
      "model.analytics@^1.0.0"
    ]
  },

  "capabilities": {
    "skills": [
      "skill.data-analyzer@^1.0.0",
      "skill.trend-predictor@^1.0.0"
    ]
  },

  "extensions": {
    "menu": [
      {
        "id": "analytics",
        "label": "数据分析",
        "icon": "chart",
        "path": "/analytics"
      }
    ],
    "toolbar": [
      {
        "id": "export-report",
        "label": "导出报告",
        "icon": "download"
      }
    ]
  }
}
```

### 插件加载

```typescript
class PluginAppLoader {
  async load(pluginId: string, workspace: Workspace): Promise<void> {
    // 读取插件 manifest
    const manifest = await this.readManifest(pluginId)

    // 检查兼容性
    if (!this.isCompatible(manifest, workspace.appId)) {
      throw new Error(`Plugin ${pluginId} is not compatible with ${workspace.appId}`)
    }

    // 安装依赖
    await this.installDependencies(manifest)

    // 注入扩展
    await this.injectExtensions(manifest, workspace)

    // 标记为已安装
    workspace.installedPlugins.push(pluginId)
    await this.saveWorkspace(workspace)
  }

  private isCompatible(manifest: PluginManifest, appId: string): boolean {
    return manifest.compatibleApps.some(compatibleApp => {
      const [id, version] = compatibleApp.split('@')
      return id === appId && this.satisfiesVersion(appId, version)
    })
  }

  private async injectExtensions(
    manifest: PluginManifest,
    workspace: Workspace
  ): Promise<void> {
    // 注入菜单项
    if (manifest.extensions.menu) {
      for (const menuItem of manifest.extensions.menu) {
        workspace.menu.addItem(menuItem)
      }
    }

    // 注入工具栏项
    if (manifest.extensions.toolbar) {
      for (const toolbarItem of manifest.extensions.toolbar) {
        workspace.toolbar.addItem(toolbarItem)
      }
    }
  }
}
```

## 应用更新

### 版本检查

```typescript
class AppUpdater {
  async checkUpdates(appId: string): Promise<UpdateInfo | null> {
    const currentVersion = await this.getCurrentVersion(appId)
    const latestVersion = await marketplace.getLatestVersion(appId)

    if (this.isNewer(latestVersion, currentVersion)) {
      return {
        currentVersion,
        latestVersion,
        changelog: await marketplace.getChangelog(appId, latestVersion),
        releaseDate: await marketplace.getReleaseDate(appId, latestVersion)
      }
    }

    return null
  }

  async update(appId: string): Promise<void> {
    // 下载新版本
    const packagePath = await marketplace.downloadLatest(appId)

    // 备份当前版本
    await this.backup(appId)

    // 安装新版本
    await this.install(packagePath)

    // 迁移数据（如果需要）
    await this.migrate(appId)

    // 重新加载应用
    await this.reload(appId)
  }
}
```

### 数据迁移

```typescript
interface AppMigration {
  from: string  // 源版本
  to: string    // 目标版本
  migrate(workspace: Workspace): Promise<void>
}

// 示例：从 1.0.0 迁移到 2.0.0
const migration_1_0_0_to_2_0_0: AppMigration = {
  from: '1.0.0',
  to: '2.0.0',

  async migrate(workspace: Workspace) {
    // 迁移数据结构
    const posts = await workspace.query('posts')

    for (const post of posts) {
      // 添加新字段
      await workspace.update('posts', post.id, {
        ...post,
        newField: 'default value'
      })
    }

    // 更新配置
    workspace.settings.newSetting = true
    await workspace.save()
  }
}
```

## 应用卸载

### 卸载流程

```typescript
class AppUninstaller {
  async uninstall(appId: string, options: UninstallOptions): Promise<void> {
    // 检查是否有工作区使用此应用
    const workspaces = await this.findWorkspaces(appId)

    if (workspaces.length > 0 && !options.force) {
      throw new Error(`Cannot uninstall: ${workspaces.length} workspaces are using this app`)
    }

    // 卸载插件应用
    const plugins = await this.findInstalledPlugins(appId)
    for (const plugin of plugins) {
      await this.uninstallPlugin(plugin.id)
    }

    // 卸载依赖（如果没有其他应用使用）
    await this.uninstallUnusedDependencies(appId)

    // 删除应用文件
    await this.deleteAppFiles(appId)

    // 清理数据（可选）
    if (options.cleanData) {
      await this.cleanAppData(appId)
    }
  }

  private async uninstallUnusedDependencies(appId: string): Promise<void> {
    const manifest = await this.readManifest(appId)
    const allDeps = [
      ...manifest.dependencies.ui,
      ...manifest.dependencies.models,
      ...manifest.dependencies.integrations,
      ...manifest.capabilities.skills,
      ...manifest.capabilities.workflows
    ]

    for (const dep of allDeps) {
      const [id] = dep.split('@')

      // 检查是否有其他应用使用此依赖
      const isUsed = await this.isDependencyUsed(id, appId)

      if (!isUsed) {
        await this.uninstallDependency(id)
      }
    }
  }
}
```

## 应用打包

### 打包命令

```bash
# 打包应用
creatorflow pack

# 生成 creator-media-1.0.0.cfapp
```

### 打包流程

```typescript
class AppPacker {
  async pack(appDir: string): Promise<string> {
    // 读取 manifest
    const manifest = await this.readManifest(appDir)

    // 验证 manifest
    this.validate(manifest)

    // 收集文件
    const files = await this.collectFiles(appDir)

    // 创建压缩包
    const packagePath = path.join(
      os.tmpdir(),
      `${manifest.id}-${manifest.version}.cfapp`
    )

    await this.createArchive(files, packagePath)

    // 生成签名
    await this.sign(packagePath)

    return packagePath
  }

  private async collectFiles(appDir: string): Promise<string[]> {
    const files: string[] = []

    // 必需文件
    files.push('manifest.json')

    // Skills
    const skillsDir = path.join(appDir, 'skills')
    if (await fs.exists(skillsDir)) {
      const skillFiles = await glob('**/*', { cwd: skillsDir })
      files.push(...skillFiles.map(f => `skills/${f}`))
    }

    // Workflows
    const workflowsDir = path.join(appDir, 'workflows')
    if (await fs.exists(workflowsDir)) {
      const workflowFiles = await glob('**/*', { cwd: workflowsDir })
      files.push(...workflowFiles.map(f => `workflows/${f}`))
    }

    // Assets
    const assetsDir = path.join(appDir, 'assets')
    if (await fs.exists(assetsDir)) {
      const assetFiles = await glob('**/*', { cwd: assetsDir })
      files.push(...assetFiles.map(f => `assets/${f}`))
    }

    // Docs
    const docsDir = path.join(appDir, 'docs')
    if (await fs.exists(docsDir)) {
      const docFiles = await glob('**/*', { cwd: docsDir })
      files.push(...docFiles.map(f => `docs/${f}`))
    }

    return files
  }
}
```

## 下一步

阅读 [工作区初始化](./05_工作区初始化.md) 了解用户创建工作区的完整流程。
