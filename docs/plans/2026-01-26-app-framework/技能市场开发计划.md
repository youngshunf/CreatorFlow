# 技能市场开发计划

## 📋 项目概述

基于设计文档 `docs/plans/2026-01-26-app-framework/技能市场设计.md`，实现技能市场的核心功能，包括技能/应用的浏览、下载、安装和发布。

**开发范围**: 后端 API + 前端基础功能（浏览、下载、安装）
**付费模式**: 先实现免费功能，数据库预留付费字段
**存储方案**: 已配置 MinIO/S3

## 🎯 核心功能优先级

1. ✅ **技能市场浏览和下载** - P0（最高优先级）
2. ✅ **应用市场（含依赖管理）** - P0
3. ✅ **技能发布功能** - P1
4. ⏸️ **版本管理和更新** - P2（后续迭代）

## 📁 关键文件路径

### 后端关键文件

**新增模块**: `clound-backend/backend/app/marketplace/`

数据库迁移脚本:
- `clound-backend/backend/sql/tables/marketplace_*.sql` (6个表)

API 路由:
- `clound-backend/backend/app/marketplace/api/router.py`
- `clound-backend/backend/app/marketplace/api/v1/*.py`

数据模型:
- `clound-backend/backend/app/marketplace/model/*.py`

业务服务:
- `clound-backend/backend/app/marketplace/service/*.py`

CRUD 操作:
- `clound-backend/backend/app/marketplace/crud/*.py`

Schema 定义:
- `clound-backend/backend/app/marketplace/schema/*.py`

对象存储:
- `clound-backend/backend/app/marketplace/storage/s3_storage.py`

**修改文件**:
- `clound-backend/backend/app/router.py` - 注册 marketplace 路由

### 前端关键文件

**新增模块**: `clound-frontend/apps/web-antd/src/views/marketplace/`

路由配置:
- `clound-frontend/apps/web-antd/src/router/routes/modules/marketplace.ts`

API 调用:
- `clound-frontend/apps/web-antd/src/api/marketplace/*.ts`

页面组件:
- `clound-frontend/apps/web-antd/src/views/marketplace/skills/` - 技能市场
- `clound-frontend/apps/web-antd/src/views/marketplace/apps/` - 应用市场
- `clound-frontend/apps/web-antd/src/views/marketplace/publish/` - 发布页面

**修改文件**:
- `clound-frontend/apps/web-antd/src/router/routes/index.ts` - 导入 marketplace 路由

## 🗄️ 数据库设计

### Phase 1: 核心表结构（6张表）

按照设计文档创建以下数据库表：

1. **marketplace_skills** - 技能主表
2. **marketplace_skill_versions** - 技能版本表
3. **marketplace_apps** - 应用主表
4. **marketplace_app_versions** - 应用版本表
5. **marketplace_categories** - 分类表
6. **user_downloads** - 用户下载记录表

**重要字段说明**:
- `pricing_type`: 先支持 'free'，预留 'paid' 和 'subscription'
- `skill_dependencies`: 应用依赖的技能ID列表（逗号分隔）
- `skill_dependencies_versioned`: 带版本号的技能依赖（JSONB格式）
- `package_url`: S3 存储的下载链接
- `file_hash`: SHA256 校验值

### Phase 2: 索引优化

为常用查询创建索引：
- 技能/应用的分类、标签查询
- 用户下载历史查询
- 版本号查询

## 🏗️ 后端实现（FastAPI）

### 1. 模块结构

参考现有的 `user_tier` 模块组织方式：

```
backend/app/marketplace/
├── __init__.py
├── model/                          # SQLAlchemy 模型
│   ├── __init__.py
│   ├── skill.py                    # MarketplaceSkill
│   ├── skill_version.py            # MarketplaceSkillVersion
│   ├── app.py                      # MarketplaceApp
│   ├── app_version.py              # MarketplaceAppVersion
│   ├── category.py                 # MarketplaceCategory
│   └── download.py                 # UserDownload
├── schema/                         # Pydantic Schema
│   ├── __init__.py
│   ├── skill.py                    # SkillCreate, SkillUpdate, SkillOut
│   ├── skill_version.py
│   ├── app.py
│   ├── app_version.py
│   └── common.py                   # 共用的Schema
├── crud/                           # CRUD 操作
│   ├── __init__.py
│   ├── crud_skill.py
│   ├── crud_skill_version.py
│   ├── crud_app.py
│   ├── crud_app_version.py
│   ├── crud_category.py
│   └── crud_download.py
├── service/                        # 业务服务层
│   ├── __init__.py
│   ├── skill_service.py            # 技能业务逻辑
│   ├── app_service.py              # 应用业务逻辑
│   ├── download_service.py         # 下载安装逻辑
│   ├── publish_service.py          # 发布逻辑
│   └── sync_service.py             # 同步服务
├── storage/                        # 对象存储
│   ├── __init__.py
│   └── s3_storage.py               # S3 上传下载
├── api/                            # API 路由
│   ├── __init__.py
│   ├── router.py                   # 路由汇总
│   └── v1/
│       ├── __init__.py
│       ├── skills.py               # GET /api/v1/marketplace/skills
│       ├── apps.py                 # GET /api/v1/marketplace/apps
│       ├── categories.py           # GET /api/v1/marketplace/categories
│       ├── download.py             # GET /api/v1/marketplace/download/*
│       ├── publish.py              # POST /api/v1/marketplace/skills (发布)
│       └── sync.py                 # POST /api/v1/marketplace/sync
└── utils/                          # 工具函数
    ├── __init__.py
    ├── package.py                  # 压缩包处理
    └── validator.py                # config.yaml 验证
```

### 2. 核心 API 端点

#### 浏览类 API（只读，无需认证）
- `GET /api/v1/marketplace/skills` - 技能列表（支持分页、分类、标签过滤）
- `GET /api/v1/marketplace/skills/{id}` - 技能详情
- `GET /api/v1/marketplace/skills/{id}/versions` - 技能版本列表
- `GET /api/v1/marketplace/apps` - 应用列表
- `GET /api/v1/marketplace/apps/{id}` - 应用详情
- `GET /api/v1/marketplace/apps/{id}/versions` - 应用版本列表
- `GET /api/v1/marketplace/categories` - 分类列表
- `GET /api/v1/marketplace/search?q=关键词` - 搜索

#### 下载类 API（需要记录下载）
- `GET /api/v1/marketplace/download/skill/{id}/{version}` - 下载技能包
- `GET /api/v1/marketplace/download/app/{id}/{version}` - 下载应用包

#### 同步类 API（需要认证）
- `POST /api/v1/marketplace/sync` - 客户端同步已安装项，检查更新

#### 发布类 API（需要认证）
- `POST /api/v1/marketplace/skills` - 发布新技能
- `PUT /api/v1/marketplace/skills/{id}/versions` - 发布新版本
- `POST /api/v1/marketplace/apps` - 发布新应用
- `PUT /api/v1/marketplace/apps/{id}/versions` - 发布应用新版本

### 3. S3 对象存储集成

**存储路径设计**:
```
creatorflow-marketplace/
├── skills/{skill_id}/{version}.zip          # 技能包
├── skills/{skill_id}/icon.svg               # 技能图标
├── apps/{app_id}/{version}.zip              # 应用包
└── apps/{app_id}/icon.svg                   # 应用图标
```

**关键功能**:
- 上传技能/应用包到 S3
- 生成预签名下载 URL（24小时有效）
- 计算文件 SHA256 校验值
- 删除旧版本文件（可选）

### 4. 业务逻辑实现

#### 技能发布流程（publish_service.py）
1. 验证 JWT 令牌，获取用户信息
2. 解析上传的 ZIP 包
3. 验证 `config.yaml` 格式
4. 检查 `SKILL.md` 和 `icon.svg` 是否存在
5. 检查技能 ID 是否已存在（新发布 vs 更新版本）
6. 上传包文件到 S3
7. 计算 SHA256 哈希值
8. 创建数据库记录（skill + skill_version）
9. 更新 `is_latest` 标志
10. 返回发布结果

#### 应用安装流程（download_service.py）
1. 获取应用 manifest（包含 `skill_dependencies`）
2. 解析依赖的技能列表
3. 检查本地已安装技能（从客户端传入的已安装列表）
4. 生成缺失技能的下载 URL
5. 返回应用包 URL + 缺失技能的下载清单

#### 版本同步流程（sync_service.py）
1. 接收客户端已安装的技能/应用列表 `[{id, version, type}]`
2. 查询数据库获取每个项的最新版本
3. 对比版本号，找出有更新的项
4. 返回更新列表 `[{id, latestVersion, changelog}]`

## 🎨 前端实现（Vue 3 + Ant Design Vue）

### 1. 路由配置

创建 `marketplace.ts` 路由模块：

```typescript
// clound-frontend/apps/web-antd/src/router/routes/modules/marketplace.ts
const routes: RouteRecordRaw[] = [
  {
    path: '/marketplace',
    name: 'Marketplace',
    redirect: '/marketplace/skills',
    meta: { title: '技能市场', icon: 'lucide:store' },
    children: [
      {
        path: 'skills',
        name: 'MarketplaceSkills',
        component: () => import('#/views/marketplace/skills/index.vue'),
        meta: { title: '技能市场' }
      },
      {
        path: 'skills/:id',
        name: 'SkillDetail',
        component: () => import('#/views/marketplace/skills/detail.vue'),
        meta: { title: '技能详情', hideInMenu: true }
      },
      {
        path: 'apps',
        name: 'MarketplaceApps',
        component: () => import('#/views/marketplace/apps/index.vue'),
        meta: { title: '应用市场' }
      },
      {
        path: 'apps/:id',
        name: 'AppDetail',
        component: () => import('#/views/marketplace/apps/detail.vue'),
        meta: { title: '应用详情', hideInMenu: true }
      },
      {
        path: 'publish',
        name: 'MarketplacePublish',
        component: () => import('#/views/marketplace/publish/index.vue'),
        meta: { title: '发布技能' }
      }
    ]
  }
];
```

### 2. API 封装层

```typescript
// clound-frontend/apps/web-antd/src/api/marketplace/skills.ts
import { requestClient } from '#/api/request';

export interface Skill {
  id: string;
  name: string;
  description: string;
  icon_url: string;
  category: string;
  tags: string;
  pricing_type: 'free' | 'paid';
  price: number;
  download_count: number;
  author_name: string;
  is_official: boolean;
}

// 获取技能列表
export async function getSkills(params?: {
  page?: number;
  page_size?: number;
  category?: string;
  tags?: string;
  pricing_type?: string;
}) {
  return requestClient.get<{ items: Skill[]; total: number }>(
    '/api/v1/marketplace/skills',
    { params }
  );
}

// 获取技能详情
export async function getSkillDetail(id: string) {
  return requestClient.get<Skill>(`/api/v1/marketplace/skills/${id}`);
}

// 下载技能
export async function downloadSkill(id: string, version: string) {
  return requestClient.get<{ download_url: string; file_hash: string }>(
    `/api/v1/marketplace/download/skill/${id}/${version}`
  );
}
```

### 3. 页面组件

#### 技能市场列表页（skills/index.vue）

**布局**:
- 顶部：搜索栏 + 分类筛选
- 左侧：分类导航（树形）
- 右侧：技能卡片网格（支持分页）

**技能卡片内容**:
- 图标（icon.svg）
- 技能名称
- 简短描述（1行）
- 分类标签
- 下载次数
- 官方标识（is_official）
- 下载按钮

#### 技能详情页（skills/detail.vue）

**布局**:
- 左侧：技能信息
  - 大图标
  - 技能名称
  - 作者信息
  - 下载统计
  - 分类和标签
  - 下载按钮（选择版本）
- 右侧：详细说明
  - 完整描述（从 SKILL.md 渲染）
  - 版本历史（changelog）
  - 使用示例

#### 应用市场页（apps/index.vue）

类似技能市场，额外显示：
- 应用依赖的技能数量
- 一键安装（自动下载依赖技能）

#### 发布页面（publish/index.vue）

**表单内容**:
- ZIP 包上传（拖拽上传）
- 自动解析并显示 config.yaml 内容
- 版本号选择（自动递增 or 手动输入）
- 更新日志输入
- 发布按钮

**验证逻辑**:
- 检查 ZIP 结构是否符合规范
- 验证 config.yaml 格式
- 确认 SKILL.md 和 icon.svg 存在

## 🔧 开发步骤

### Phase 1: 后端基础架构（第1-2周）

#### 第1步：数据库建表
- [ ] 创建 6 张数据库表的 SQL 脚本
- [ ] 执行迁移，验证表结构
- [ ] 创建必要的索引

#### 第2步：SQLAlchemy 模型
- [ ] 实现 6 个模型类（参考 `credit_transaction.py` 的写法）
- [ ] 定义字段映射和关系

#### 第3步：CRUD 层
- [ ] 实现基础 CRUD 操作（Create, Read, Update, Delete）
- [ ] 使用 SQLAlchemy 2.0 的异步 API

#### 第4步：S3 存储服务
- [ ] 实现 `s3_storage.py`，封装上传/下载/删除操作
- [ ] 配置 MinIO 客户端（使用现有配置）
- [ ] 实现预签名 URL 生成

#### 第5步：业务服务层
- [ ] 实现 `skill_service.py` - 技能列表、详情、搜索
- [ ] 实现 `app_service.py` - 应用列表、详情、依赖解析
- [ ] 实现 `download_service.py` - 下载逻辑
- [ ] 实现 `publish_service.py` - 发布逻辑
- [ ] 实现 `sync_service.py` - 同步逻辑

#### 第6步：API 路由
- [ ] 实现 7 个 API 端点文件（v1/skills.py 等）
- [ ] 在 `router.py` 中注册路由
- [ ] 在 `backend/app/router.py` 中引入 marketplace 路由

### Phase 2: 前端基础功能（第3-4周）

#### 第7步：API 调用层
- [ ] 创建 `api/marketplace/skills.ts`
- [ ] 创建 `api/marketplace/apps.ts`
- [ ] 创建 `api/marketplace/categories.ts`
- [ ] 创建 `api/marketplace/publish.ts`

#### 第8步：路由配置
- [ ] 创建 `router/routes/modules/marketplace.ts`
- [ ] 在 `router/routes/index.ts` 中导入

#### 第9步：页面开发
- [ ] 实现技能市场列表页（skills/index.vue）
- [ ] 实现技能详情页（skills/detail.vue）
- [ ] 实现应用市场列表页（apps/index.vue）
- [ ] 实现应用详情页（apps/detail.vue）

#### 第10步：公共组件
- [ ] 技能卡片组件（SkillCard.vue）
- [ ] 应用卡片组件（AppCard.vue）
- [ ] 分类导航组件（CategoryNav.vue）
- [ ] 版本选择器组件（VersionSelector.vue）

### Phase 3: 发布功能（第5周）

#### 第11步：发布页面
- [ ] 实现 ZIP 上传组件
- [ ] 实现 config.yaml 解析和预览
- [ ] 实现版本号选择逻辑
- [ ] 实现发布表单和提交

#### 第12步：打包工具验证
- [ ] 验证 config.yaml 的结构
- [ ] 检查必需文件（SKILL.md, icon.svg）
- [ ] 计算 SHA256 哈希值

### Phase 4: 集成测试（第6周）

#### 第13步：端到端测试
- [ ] 测试技能浏览 → 详情 → 下载流程
- [ ] 测试应用安装（含依赖下载）
- [ ] 测试技能发布 → 审核 → 上架流程
- [ ] 测试版本同步 API

#### 第14步：初始数据导入
- [ ] 创建初始分类数据（内容创作、数据分析等）
- [ ] 导入 3-5 个示例技能
- [ ] 创建 1-2 个示例应用

## ✅ 验证方案

### 后端验证

#### 1. 数据库验证
```bash
# 连接到 PostgreSQL
psql -U postgres -d creatorflow

# 检查表是否创建成功
\dt marketplace_*

# 查看表结构
\d marketplace_skills
\d marketplace_skill_versions
```

#### 2. API 验证
```bash
# 测试技能列表 API
curl http://localhost:8000/api/v1/marketplace/skills

# 测试技能详情 API
curl http://localhost:8000/api/v1/marketplace/skills/material-organize

# 测试分类列表 API
curl http://localhost:8000/api/v1/marketplace/categories
```

#### 3. S3 验证
```bash
# 使用 MinIO 客户端检查文件
mc ls minio/creatorflow-marketplace/skills/

# 检查上传的技能包
mc cat minio/creatorflow-marketplace/skills/material-organize/1.0.0.zip
```

### 前端验证

#### 1. 路由验证
- 访问 `http://localhost:5173/marketplace/skills` 查看技能列表
- 访问 `http://localhost:5173/marketplace/apps` 查看应用列表
- 访问 `http://localhost:5173/marketplace/publish` 查看发布页面

#### 2. 功能验证
- 在技能市场页面进行分类筛选
- 点击技能卡片查看详情
- 点击下载按钮触发下载
- 在应用市场安装应用，验证依赖技能自动下载
- 上传一个技能 ZIP 包，验证发布流程

### 集成验证

#### 端到端流程测试
1. **浏览流程**: 打开技能市场 → 选择分类 → 查看技能列表 → 点击技能详情
2. **下载流程**: 技能详情页 → 选择版本 → 点击下载 → 验证 ZIP 文件下载成功
3. **应用安装**: 应用市场 → 点击安装应用 → 验证依赖技能自动下载 → 检查本地文件
4. **发布流程**: 准备技能 ZIP 包 → 上传到发布页面 → 填写信息 → 发布 → 在市场中查看

## 📊 数据流图

### 技能下载流程
```
用户点击下载
    ↓
前端调用 downloadSkill(id, version)
    ↓
后端生成 S3 预签名 URL
    ↓
返回 { download_url, file_hash }
    ↓
前端直接从 S3 下载 ZIP 包
    ↓
下载完成后验证 SHA256 哈希
    ↓
解压到本地 ~/.creator-flow/marketplace/skills/{id}/{version}/
```

### 应用安装流程
```
用户点击安装应用
    ↓
前端调用 downloadApp(id, version)
    ↓
后端解析 skill_dependencies
    ↓
返回 { app_url, missing_skills: [{id, version, download_url}] }
    ↓
前端先下载所有缺失的技能
    ↓
技能下载完成后，下载应用包
    ↓
解压应用到本地 ~/.creator-flow/marketplace/apps/{id}/{version}/
```

## 🔐 权限控制

- **浏览和下载**: 无需认证（公开访问）
- **发布技能/应用**: 需要 JWT 认证
- **查看私有技能**: 仅技能作者可见（`is_private=true`）
- **更新技能版本**: 仅技能作者可操作（通过 `author_id` 校验）

## 🚀 后续扩展（Phase 5+）

这些功能暂不实现，但数据库已预留字段：

- [ ] 付费技能支持（集成 credit_transaction 系统）
- [ ] 评分评论系统
- [ ] 技能使用统计和分析
- [ ] 版本对比和合并 UI
- [ ] 私有技能发布到公开市场
- [ ] CLI 发布工具（`creatorflow skill publish`）
- [ ] GitHub Actions 自动发布

## 📝 注意事项

1. **代码风格**: 严格遵循项目现有的代码规范，参考 `user_tier` 模块
2. **中文注释**: 所有代码注释、提交信息、文档必须使用中文
3. **错误处理**: 使用 FastAPI 的异常处理机制，返回规范的错误响应
4. **日志记录**: 关键操作需要记录日志（发布、下载、删除等）
5. **性能优化**:
   - 技能列表 API 需要分页（默认 20 条/页）
   - 图标等静态资源使用 CDN 加速
   - S3 预签名 URL 设置合理的过期时间（24小时）
6. **安全性**:
   - 上传的 ZIP 包需要验证大小限制（如 50MB）
   - 防止路径遍历攻击（ZIP 解压时检查文件路径）
   - config.yaml 需要严格验证，防止注入攻击

## 📅 预估工期

- **Phase 1 (后端基础)**: 2 周
- **Phase 2 (前端基础)**: 2 周
- **Phase 3 (发布功能)**: 1 周
- **Phase 4 (集成测试)**: 1 周

**总计**: 约 6 周

---

**计划创建时间**: 2026-01-28
**基于设计文档**: `docs/plans/2026-01-26-app-framework/技能市场设计.md`
