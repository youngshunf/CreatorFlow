双轨并行创作流程设计
====================

:日期: 2026-02-17
:状态: 待实施

背景与问题
----------

当前自媒体创作流程是 **线性分叉** 的：用户选题后选择"图文脚本"或"视频脚本"，一旦选择就只走单一轨道，无法同时产出两种内容形态。

理想流程：一个选题同时产出图文和视频两种内容，各自走平台适配和多平台分发。

设计目标
--------

::

    选题 → 研究（共享）
             ↓
        ┌────┴────┐
        ▼         ▼
     图文轨道   视频轨道    ← 默认同时启动，可关闭任一轨道
        │         │
     图文脚本   视频脚本    ← 并行生成，互不等待
        │         │
     图文内容   视频内容
        │         │
     平台适配   平台适配    ← 各自适配各自的目标平台
        │         │
      发布       发布

核心设计决策
------------

========== =====================================================
决策项      结论
========== =====================================================
内容关系    同一个 content 记录，双轨并行
执行方式    完全并行，图文和视频同时推进，互不等待
状态管理    各轨道在 content_stages 独立追踪，content.status 取最快轨道
触发方式    默认双轨启动，用户可关闭任一轨道
========== =====================================================

一、数据模型改动
----------------

contents 表新增字段
~~~~~~~~~~~~~~~~~~~

.. code-block:: sql

    content_tracks TEXT DEFAULT 'article,video'

可选值：``article``、``video``、``article,video``

content_stages 表
~~~~~~~~~~~~~~~~~

**无需改动**。现有 ``stage`` 字段已天然区分轨道：

- 图文轨道：``script_article`` → ``draft_article`` → ``platform_adapt_article``
- 视频轨道：``script_video`` → ``draft_video`` → ``platform_adapt_video``

Status 推进逻辑
~~~~~~~~~~~~~~~

改为"任一轨道完成当前阶段即推进"：

======================== ==========================
事件                      status 变更
======================== ==========================
任一轨道脚本完成          scripting → creating
任一轨道内容完成          creating → adapting
任一轨道适配完成          adapting → scheduled
======================== ==========================

涉及文件
~~~~~~~~

======================== =============================================
改动                      文件
======================== =============================================
Schema 新增字段           ``packages/shared/src/db/schema.ts``
Repository 适配           ``packages/shared/src/db/repositories/contents.ts``
======================== =============================================

二、Skill 层改动
----------------

改动的 Skills（6 个）
~~~~~~~~~~~~~~~~~~~~~

**idea-researcher（灵感调研）**：

- 创建 content 时写入 ``content_tracks: 'article,video'``（默认双轨）
- 其余逻辑不变

**topic-generator（选题推荐）**：

- 同上，推荐选题时默认双轨

**article-script-create（图文脚本）**：

- 新增前置检查：读取 ``content_tracks``，不包含 ``article`` 则跳过
- status 推进改为：首条轨道完成脚本即推进 status 为 ``creating``

**video-script-create（视频脚本）**：

- 同上，检查 ``content_tracks`` 是否包含 ``video``
- 同样的 status 推进逻辑

**content-creator（图文内容创作）**：

- 轨道检查 + status 推进逻辑同上

**video-creator（视频创作）**：

- 轨道检查 + status 推进逻辑同上

**platform-adapter（平台适配）**：

- 改动最大：检测 content 下所有 draft 阶段（``draft_article``、``draft_video``）
- 对每种形态分别做平台适配
- 图文适配产出 ``platform_adapt_article``，视频适配产出 ``platform_adapt_video``

新增 Skill：creation-orchestrator（创作编排器）
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

负责在研究阶段完成后编排双轨流程::

    触发条件：content.status 变为 scripting
    职责：
    1. 读取 content_tracks 确定要启动哪些轨道
    2. 并行调用对应的脚本 Skill（article-script-create / video-script-create）
    3. 脚本完成后并行调用内容创作 Skill（content-creator / video-creator）
    4. 内容创作完成后调用平台适配（platform-adapter）
    5. 全程更新 content.status（取最快轨道）

Skill 文件位置
~~~~~~~~~~~~~~

::

    skill-marketplace/apps/app-creator-media/skills/
    ├── idea-researcher/SKILL.md          # 改动
    ├── topic-generator/SKILL.md          # 改动
    ├── article-script-create/SKILL.md    # 改动
    ├── video-script-create/SKILL.md      # 改动
    ├── content-creator/SKILL.md          # 改动
    ├── video-creator/SKILL.md            # 改动
    ├── platform-adapter/SKILL.md         # 改动
    └── creation-orchestrator/SKILL.md    # 新增

三、前端交互改动
----------------

选题确认环节
~~~~~~~~~~~~

选题确认时展示轨道选择，默认双轨开启::

    ┌─────────────────────────────────────┐
    │  确认选题：如何用 AI 提升创作效率     │
    │                                     │
    │  产出形态：                          │
    │  [✓] 图文内容    [✓] 视频内容        │
    │                                     │
    │  目标平台：                          │
    │  图文：[✓] 小红书  [✓] 公众号        │
    │  视频：[✓] 抖音    [✓] B站           │
    │                                     │
    │        [开始创作]                     │
    └─────────────────────────────────────┘

内容详情页
~~~~~~~~~~

双轨进度展示，支持关闭单轨::

    ┌─────────────────────────────────────────────┐
    │  《如何用 AI 提升创作效率》                    │
    │                                             │
    │  ● 选题研究  ✅ 完成                         │
    │                                             │
    │  ┌─ 图文轨道 ──────────────────────┐        │
    │  │ ● 图文脚本  ✅                   │        │
    │  │ ● 图文内容  ✅                   │        │
    │  │ ● 平台适配  🔄 进行中            │        │
    │  │   └ 小红书 ✅ | 公众号 🔄        │        │
    │  └──────────────────────────────────┘        │
    │                                             │
    │  ┌─ 视频轨道 ──────────────────────┐        │
    │  │ ● 视频脚本  ✅                   │        │
    │  │ ● 视频制作  🔄 进行中            │        │
    │  │ ● 平台适配  ⏳ 等待              │        │
    │  └──────────────────────────────────┘        │
    │                                             │
    │  [关闭视频轨道]  [查看图文] [查看视频]        │
    └─────────────────────────────────────────────┘

用户可在任意时刻关闭某条轨道（更新 ``content_tracks``），已完成的阶段产出保留。

IPC 层改动
~~~~~~~~~~

====================================== ==========================================
改动                                    说明
====================================== ==========================================
``creatorMedia:contents:create``        支持传入 ``content_tracks``
``creatorMedia:contents:update``        支持更新 ``content_tracks``（关闭轨道）
====================================== ==========================================

四、目录结构
------------

无需改动，现有结构天然支持双轨::

    {项目名}/内容创作/{序号}-{标题}/
    ├── 图文/
    │   ├── 脚本/图文脚本.md
    │   ├── 素材/
    │   └── 作品/
    │       ├── 原稿.md
    │       └── 平台适配/
    │           ├── 小红书.md
    │           └── 公众号.md
    └── 视频/
        ├── 脚本/视频脚本.json
        ├── 素材/
        └── 作品/
            ├── [视频文件].mp4
            └── 平台适配/
                ├── 抖音.md
                └── B站.md

五、实施计划
------------

Phase 1 — 打通数据流（最小可用）
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. contents 表加 ``content_tracks`` 字段
2. 改造 ``idea-researcher``，创建 content 时写入双轨标记
3. 新增 ``creation-orchestrator`` Skill，实现并行调用脚本 Skill 的编排逻辑
4. 改造各 Skill 的 status 推进逻辑（任一轨道完成即推进）

Phase 2 — 前端可视化
~~~~~~~~~~~~~~~~~~~~~

5. 选题确认时的轨道选择 UI
6. 内容详情页的双轨进度展示
7. 关闭单轨的交互

Phase 3 — 完善体验
~~~~~~~~~~~~~~~~~~~

8. platform-adapter 的多形态适配改造
9. 发布阶段的多形态分发
10. 内容列表的轨道标签展示
